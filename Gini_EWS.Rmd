---
title: "Inequality and early warning signals"
author: "Juan Rocha"
date: "3/7/2017"
output:
  html_document:
    self_contained: true
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ineq)
library(ggplot2)
library(plotly)
library(earlywarnings)
library(foreign)
library(dplyr)
library(tidyr)
```

## Intro

Before leaving Princeton Dali and me had the idea of exploring potential political collapses such as change of dynasties in China from a critical transition point of view. Early warning signals (EWS) for critical transitions take advantage of the statistical signature that systems approaching a tipping point leave: namely increase in variance, autocorrelation and skewness (to name a few). We realized that the literature exploring 'collapses' in the social sciences have not fully explore the potential for predicting critical transitions. As an excercise, here I explore the application of EWS to inequality data: Gini coefficients collected by the World Bank for the period 1950 - 2012.

```{r gini, fig.height= 7, fig.width=7}
gin <- read.dta("~/Downloads/allginis_2013.dta")

g <- ggplot(gin, aes(x = year, y = Giniall)) + geom_line(aes(color = country), show.legend = F) + facet_wrap(~region, ncol = 1)+
    theme_gray(base_size = 9)

(gg <- ggplotly(g))
```

## Early warning signals

Below I plot the generic early warnings signals for few countries as example of how it works. I only used countries where the time line is almost complete or that interested me. Note that the algorithm imputes missing values, so when there is gaps on the time line with the World Bank dataset, it's filled up with average values.

### United states

```{r usa, echo = FALSE, fig.height= 7, fig.width=7, dev.args=list(pointsize = 6)}
out <- generic_ews(timeseries = filter(gin, country == "United States") %>% select(year, Giniall), 
            interpolate = T, winsize = 25, detrending = 'gaussian', logtransform = F)

out <- left_join(out, filter(gin, country == "United States") %>% select(year, Giniall), by = c("timeindex" = "year"))

out <- rename(out, autoregressive_coefficient = ar1, stardard_deviation = sd, skewness = sk, kurtosis = kurt, 
              coefficient_of_variation = cv, return_rate = returnrate, density_ratio = densratio, autocorr_1_lag = acf1,
              Gini = Giniall)

out <- reshape::melt(out, "timeindex")
g <- ggplot(out, aes(x= timeindex, y = value)) + geom_line() + facet_wrap(~variable, scale = 'free_y', ncol =1) +
    theme_gray(base_size = 10)
(gg <- ggplotly(g))

```

### UK

```{r india, echo = FALSE, fig.height= 7, fig.width=7, dev.args=list(pointsize = 6)}
out <- generic_ews(timeseries = filter(gin, country == "United Kingdom") %>% select(year, Giniall), 
            interpolate = T, winsize = 25, detrending = 'gaussian', logtransform = F)

out <- left_join(out, filter(gin, country == "United Kingdom") %>% select(year, Giniall), by = c("timeindex" = "year"))

out <- rename(out, autoregressive_coefficient = ar1, stardard_deviation = sd, skewness = sk, kurtosis = kurt, 
              coefficient_of_variation = cv, return_rate = returnrate, density_ratio = densratio, autocorr_1_lag = acf1,
              Gini = Giniall)

out <- reshape::melt(out, "timeindex")
g <- ggplot(out, aes(x= timeindex, y = value)) + geom_line() + facet_wrap(~variable, scale = 'free_y', ncol =1)+
    theme_gray(base_size = 10)
(gg <- ggplotly(g))

```

### Germany

```{r swe, echo = FALSE, fig.height= 7, fig.width=7, dev.args=list(pointsize = 6)}
out <- generic_ews(timeseries = filter(gin, country == "Germany") %>% select(year, Giniall), 
            interpolate = T, winsize = 25, detrending = 'gaussian', logtransform = F)

out <- left_join(out, filter(gin, country == "Germany") %>% select(year, Giniall), by = c("timeindex" = "year"))

out <- rename(out, autoregressive_coefficient = ar1, stardard_deviation = sd, skewness = sk, kurtosis = kurt, 
              coefficient_of_variation = cv, return_rate = returnrate, density_ratio = densratio, autocorr_1_lag = acf1,
              Gini = Giniall)

out <- reshape::melt(out, "timeindex")
g <- ggplot(out, aes(x= timeindex, y = value)) + geom_line() + facet_wrap(~variable, scale = 'free_y', ncol =1)+
    theme_gray(base_size = 10)
(gg <- ggplotly(g))

```

### China

```{r china, echo = FALSE, fig.height= 7, fig.width=7, dev.args=list(pointsize = 6)}
out <- generic_ews(timeseries = filter(gin, country == "China") %>% select(year, Giniall), 
            interpolate = T, winsize = 25, detrending = 'gaussian', logtransform = F)

out <- left_join(out, filter(gin, country == "China") %>% select(year, Giniall), by = c("timeindex" = "year"))

out <- rename(out, autoregressive_coefficient = ar1, stardard_deviation = sd, skewness = sk, kurtosis = kurt, 
              coefficient_of_variation = cv, return_rate = returnrate, density_ratio = densratio, autocorr_1_lag = acf1,
              Gini = Giniall)

out <- reshape::melt(out, "timeindex")
g <- ggplot(out, aes(x= timeindex, y = value)) + geom_line() + facet_wrap(~variable, scale = 'free_y', ncol =1)+
    theme_gray(base_size = 10)
(gg <- ggplotly(g))

```

### Ukraine

```{r Colombia, echo = FALSE, fig.height= 7, fig.width=7, dev.args=list(pointsize = 6)}
out <- generic_ews(timeseries = filter(gin, country == "Russian Federat") %>% select(year, Giniall), 
            interpolate = T, winsize = 25, detrending = 'gaussian', logtransform = F)

out <- left_join(out, filter(gin, country == "Russian Federat") %>% select(year, Giniall), by = c("timeindex" = "year"))

out <- rename(out, autoregressive_coefficient = ar1, stardard_deviation = sd, skewness = sk, kurtosis = kurt, 
              coefficient_of_variation = cv, return_rate = returnrate, density_ratio = densratio, autocorr_1_lag = acf1,
              Gini = Giniall)

out <- reshape::melt(out, "timeindex")
g <- ggplot(out, aes(x= timeindex, y = value)) + geom_line() + facet_wrap(~variable, scale = 'free_y', ncol =1)+
    theme_gray(base_size = 10)
(gg <- ggplotly(g))

```


