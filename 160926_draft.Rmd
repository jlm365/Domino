---
title: "Cascading effects of critical transitions in social-ecological systems"
author: "Juan Rocha"
date: "24 December 2016"
output:
    pdf_document:
        toc: no
        citation_package: natbib
    word_document: null
fontsize: 10pt
bibliography: cascading.bib
cls: nature.cls
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list = ls())
set.seed(12345)
library (dplyr)
library (tidyr)
library (network)
library (sna) # load the package
library(RColorBrewer)
library(ggplot2)
library(GGally)


```

### Outline
The manuscript presents a framework to explore hypothesis of potential connection between regime shifts. It's written with an interdisciplinary audience in mind (e.g. PNAS).
Potential co-authors: Garry Peterson (help with cld's and rsdb development), Ã–rjan Bodin (advise with domino effects) & Simon Levin (help with modeling)

Target journal to be decided, options include: Ecosystems, ERL, PNAS

* Abstract 200w
* Intro and problem setting 1000w
    + Liu call for broader study of potential interconnections for sustainability science
    + Increasing frequency and intensity of regime shifts
    + How can we explore potential interconnections?
* Method / Framework 500w (it's not a methods paper but networks should be introduced here technical details should go at the end)
    + Forks
    + Dominoes
    + Inconvenient feedbacks
    + Figure 1. Schematic framework
* Results 500w
    + Figure 1. Bipartite network from PlosONE
    + Figure 2. CLDs as networks: missing nodes and dominoes in Arctic examples
    + Figure 3. Inconvenient feedbacks in drylands examples
* Discussion 1000w
    + There is a risk of cascading effects amongst regime shifts but we cannot wait until they occur, a framework to explore potential interconnections is needed.
    + Examples of cascading effects already discussed in the literature
    + Examples of new cascading effects identified with our framework.
    + Further research that looks empirically where this might be happening and where not, and a modeling framework that help us distinguish plausible from unlikely.
* Conclusion 300w
* Methods
    + Data: RSDB + CLDs
    + Bipartite networks
    + CLD's as networks, communitiy detection
    + Feedback identification
* Refs 30max
* Appendix / complementary material (?)

-------

## Abstract
Critical transitions in nature and society are likely to occur more often and severe as humans increase they pressure on the world ecosystems. Yet it is largely unknown how these transitions will interact, whether the occurrence of one will increase the likelihood of another, and whether these potential teleconnections (social and ecological) correlate critical transition in distant places. Here we present a framework for exploring three types of potential cascading effects of critical transitions: forks, domino effects and inconvenient feedbacks. Drivers and feedback mechanisms are reduced to a network form that allow us to explore drivers co-occurrence (forks). Sharing drivers is likely to increase correlation in time or space among critical transitions but not necessarily interdependence. Random walks on causal networks allow us to detect and compare communities of common drivers and feedback mechanisms across different critical transitions; allowing us to detect missing drivers and potential domino effects. Inconvenient feedbacks were identified by mapping new circular pathways on coupled networks that have not been previously reported. The method serves as a platform for hypothesis exploration of plausible new feedbacks between critical transitions in social-ecological systems; it helps to scope structural interdependence and hence an avenue for future modelling and empirical testing of regime shifts coupling.

```{r dataset, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, results = 'hide'}

# load CLD
dat <- read.csv2('~/Documents/JUAN/PhD-SRC/RS20+Analysis/RS_CLD_2015.csv')
dat <- dat[,-1]
dat$col <- ifelse(dat$Polarity == -1, 'red','blue')

## Updated ploting function
plotnet <- function(net, ...){
	plot.network(net, #mode='circle',
			vertex.col = alpha(net %v% 'col', 0.7),
			label = network.vertex.names(net),
			label.cex= 1,
			main = net %n% 'name', col.main = "grey11", cex.main = 1,
			vertex.border = 0,
			usecurve=T,
			vertex.cex= 2 + scale(net %v% 'fb'),
			label.pos= 5,
			edge.col= alpha(net %e% 'col' , 0.5),  
			edge.lwd = 0.05 + net %e% 'fb',
			edge.curve = 0.01,
			displayisolates=T, pad = 1
			)
		}

# Now extract only one regime shift
# levels(rs$Regime.Shift)	# this are the RS currently on dataset
# com <- combn(levels(rs$Regime.Shift), m=2) # combinatories

## A function to create the network, add polarity and cycles / feedbacks as edge attributes
## J161105: Edge attributes are tricky to set because once the network is created the ordering of edges is lost and I cannot find the default order to set the right values. Reading the help of 'loading.attributes' I found that when declared as edgelist one can add attributes directly on the dataframe.

rs.net <- function (dat, i){
	# filter dataset
	dat <- filter(dat, Regime.Shift == levels(dat$Regime.Shift)[i],
	 Polarity == 1 | Polarity == -1)
	#dat <- droplevels(dat)
	# This ordering step is necessary to make sure polarity and other attributes are assigned correctly
	# dat <- dat[order(dat$Tail, partial = dat$Head, decreasing = F),]
	# tab <- table(dat$Tail, dat$Head, dat$Polarity) # tab is an array of tables
		# dimnames(tab) [[3]] "-1"   "-0.5" "0.5"  "1"
		# v <- as.matrix(tab[,,1]*-1) + as.matrix(tab[,,2])
	# build network
		rs.x <- network(select(dat, Tail, Head, Polarity, col), directed = T, ignore.eval=FALSE, matrix.type = 'edgelist')
	# add polarity to edges: Outated, the way I create the network includes already the polarities by using ignore.eval = F. Edge color is also set on the network creation line.
		# rs.x %e% 'polarity' <- dat$Polarity
		# set.edge.value(rs.x, 'polarity', value = as.matrix(v))
		# rs.x %e% 'col' <- ifelse(rs.x %e% "Polarity" == -1, 'red', 'blue')
	# add cycles to nodes and edges.
		fb.sum <- kcycle.census(rs.x, maxlen=network.size(rs.x), mode='digraph',	tabulate.by.vertex=T, cycle.comembership='sum')
		# number of cycles per nodes
		rs.x %v% 'fb' <-  diag(fb.sum$cycle.comemb)
		# number of cycles per edge
		rs.x %e% 'fb' <- as.sociomatrix(rs.x) * fb.sum$cycle.comemb
		#J161106: Note that cycle.comemb is a matrix with comemberships, so two nodes that are not connected in the network can belong to the same cycles. That's why I multiply by the adjacency matrix, to isolate only the edges. cycle.comemb can be used later for discovery of inconvenient feedbacks.
	## add vertex attributes
		rs.x %v% 'col' <- ifelse(colSums(fb.sum$cycle.count)[-1] == 0, "grey84", 'goldenrod2')
		rs.x %n% 'name' <- levels(dat$Regime.Shift)[i]
	return(rs.x)
}

```

```{r rsdb, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 4, fig.width = 8, dev.args = list(pointsize= 8), fig.align='center', fig.cap = 'Potential cascading effects as reported in the regime shifts database (a), and forks respresented as bipartite network (b).' }

rsdb <- read.csv(file = "~/Documents/Projects/Cascading Effects/161025_RegimeShiftsDatabase.CSV",
                  header = TRUE, sep = ",")

cases <- read.csv(file = '~/Downloads/Regime Shifts Database Case Studies_170120.CSV', header = T, sep = ',' )

rsdb <- rsdb [-2,] # delete for know Invasive floating plants... seems to be duplicated.
rs <- as.character(rsdb[,3])

# Note that the number of RS depends of the version of the RSDB file. Current version 161025
type <- rep(0,30)  
type[c(9,14)] <- 'Social'
type[c(27,22,19,18,5,1)] <- 'Terrestrial'
type[c(30, 17, 10, 23, 7, 6, 21, 28, 20, 12, 2, 3 )] <- 'Aquatic'
type[c(29, 25, 26, 24, 11)] <- 'Earth'
type[c(4, 15, 13, 16, 8)] <- 'Land-Water interface'
df.biome <- as.data.frame(cbind(rs,type))

# this function takes the original csv from the website and create edgelist of regime shfits and the variables from the database. z is the column from the original file that is to be cracked, so for example column 7 are drivers. data is to make sure you declare the file you're using, here data=data. If you want to create a matrix then use table as shown below
cracking <- function(z, data){
	y <- data.frame()
	for (i in 1:dim(data)[1]){
		x <- as.character(data[i,z])
		x <- strsplit(x, split=', ')
		if (length(unlist(x)) == 0) x <- 'none'  
		y <- rbind(y,cbind(as.character(data[i,3]), unlist(x)), deparse.level=1)
	}
return (y) #return is a long form dataframe that can be used with ggplot2
}

# If you want to see the table
# drivers <- as.data.frame(table(cracking(z=7, data=data)))
df <- as.data.frame(table(cracking (z=22, data = rsdb)))
df <- df %>% filter (Freq > 0) %>%
    select (V1, V2)

## Correct incosistent naming on the RSDB. Note it's not the regime shift name (column 3), but how they are referred to in column 22
# The problematic names:
# setdiff(levels(df$V2), levels(df$V1))
levels(df$V2) [14] <- levels(df$V1) [10]
levels(df$V2) [15] <- levels(df$V1) [6]
levels(df$V2) [18] <- levels(df$V1) [6]
levels(df$V2) [17] <- levels(df$V1) [10]
levels(df$V2) [17] <- levels(df$V1) [7]
levels(df$V2) [19] <- levels(df$V1) [24]

levels(df$V2) [17] <- levels(df$V2) [20] # I don't have Desertification nor Forest to Cropland published on website!!!


cas.rs <- network( df, directed = TRUE)
network::delete.vertices(cas.rs, vid = 20)

# cas.rs2 <- igraph::graph.data.frame(d = df, dir=T)
# cas.rs2 <- igraph::delete_vertices(cas.rs2, v=31)
# com <- igraph::infomap.community(cas.rs2, mod = F, nb.trials = 200)

## setting some graphical parameters
# pal <-brewer.pal(length(levels(df.biome$type)),"Set1")
# bet <- betweenness(cas.rs, gmode='digraph')
# detach(package:igraph)

```
## Introduction
Critical phenomena has been documented on a wide variety of systems from climate, finance, language, neurological diseases, ecosystems and ancient societies [@Sole:2011us; @Scheffer:2009wl]. A large set of critical transitions in social-ecological systems has been identified [@Biggs:2015iha]. As human pressures increase on the planet, these transitions might become more acute and frequent than previously thought. Research on critical transitions in social-ecological systems is often confined to well defined domains of expertise (e.g. limnology, urbanism, climate science), adopting either an empirical, modelling [@Carpenter2003rsi] or early warnings indicator approach [@Scheffer:2012cta; @Scheffer:2009p4449]. These approaches require a deep knowledge of the causal structure of the system or a high quality spatial-temporal data respectively. These requirements have confined the body of research to the analysis of individual types of critical transitions rather than the potential interactions across systems. One of the key challenges of sustainability science is analyzing the diverse set of interactions across human-environmental systems [@Liu:2015go]. The aim of this paper is developing a framework for exploring potential interactions amongst critical transitions in social-ecological systems, so called regime shifts.

Regime shifts are large, abrupt and persistent changes in the function and structure of systems [@Scheffer:2003p339; @Scheffer:2001uu]. They present a challenge for ecological management and governance because they are very difficult to predict [@Boettiger:2013bm; @Hastings:2010p5336] and reverse [@Scheffer:2003p339], while having substantial impacts on the availability or ecosystem services that societies rely upon [@Carpenter:2009jr]. A regime is the region of the parameter space where state variables (e.g. vegetation density, coral cover) fluctuate, they are also called equilibrium, alternative stable states, basins or domains of attraction. Systems prone to regime shifts have more than one alternative stable states; under similar parameter values they can suddenly shift from one domain to another when critical thresholds are crossed [@MAY:1977p3426; @Holling:1973p6861]. Change in slow variables (e.g. temperature in coral reefs) often shrinks the basin of attraction, making the system more susceptible to shifting when exposed to shock events (e.g. hurricanes) or the action of external drivers [@Scheffer:2012cta].

How different regime shifts might be interconnected is largely unknown and a key frontier of research [@Liu:2015go; @Hughes:2013cv]. The concept of cascading effect has been used in two seemingly different contexts: i) when referring to the effect of an abrupt change on one species spreading through food webs [@Singer:2014gj; @Pauly:1998iw]; and ii) when local interactions are magnified by feedbacks that are reinforced across scales (e.g. erosion or fire) [@Anonymous:2007tc; @DebraPCPeters:2004ex]. What these interpretations have in common is that both refer to networked systems (e.g. foodwebs, landscape mosaics) where a signal (e.g. fire, species collapse, disease) spreads broadly or is contained locally depending upon the system's connectivity. The units of these networks are usually species or sets of spatial units that represent ecosystems. Here we broaden the cascading effects concept to networks of regime shifts, when regime shifts can be represented as causal networks of drivers and underlying feedback mechanisms or processes (see methods).

To explore interconnections amongst regime shifts the units of analysis should be regime shifts, and teleconnections [@Liu:2015go] or cross-scale interactions [@DebraPCPeters:2004ex] should be signals strong enough to couple them. In this context, cascading effects could occur if i) two regime shifts are affected by the same driving forces inducing synchronization of the shift (a fork) [@Rocha:2015du], ii) the occurrence of one regime shift affects the drivers of other regime shift (a domino effect) [@Rocha:2010vv; @Hughes:2013cv; @Scheffer:2012cta] or iii) when two regime shifts dynamics generate new inconvenient (not previously identified) feedback dynamics [@Liu:2015go] by reinforcing or damping each other drivers [@Rocha:2010vv] (See Fig 1). Here we present a graphical framework to explore such hypothetical interconnections.

```{r Fig1, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 5, fig.width = 5, fig.align = 'center', fig.cap = "Cascading effects. a) Conceptual diagram of the framework proposed. b) Potential interconnections of regime shifts as reported by the contributors of the regime shifts database. Potential communities of cascading effects were detected with the map equation [Rosvall et al., 2009]. c) Causal loop diagram example for the regime shift Arctic Sea Ice collapse. Positive links are depicted as blue arrows, negative links as red arrows, drivers are variables outside feedback loops (in grey), while variables inside feedbacks are yellow. Both links and vertices are scaled according to the number of feedback loops that where they are involved", dev.args = list(pointsize = 7)}

library(png)
logo <- readPNG('~/Documents/Projects/Cascading Effects/Domino/Cascading_framework.png')

op <- par()
# quartz(width = 7, height = 7, pointsize =9 )
# set layout
layout(matrix(c(1,2,3,3),2,2, byrow = T))
par(mar = c(0,1,1,0))
# Insert png for the framework
plot(c(0,452), c(0,868), asp = 1, type = 'n', xlab = "", ylab= "", xpd = T, axes = FALSE) # numbers come from pixels
rasterImage(logo, 0, 0, 452, 868 , interpolate = T)
title('a', adj = 0, cex=1)


par(mar = c(1,1,1,1))
# Plotting network of believes from RSDB
plot.network(cas.rs,
             label = network.vertex.names(cas.rs), label.cex = 0.5,
             label.pos = 5, pad = 2,
             displayisolates = TRUE, usecurve = F,
             edge.lwd = 0.2, vertex.border=0,
             vertex.cex = 1, edge.curve=0.02,
             vertex.col = 'orange', #vertex.col= pal[as.factor(type)], #
             edge.col='grey84')
# forest to cropland and dryland degradation don't exist on RSDB


## Alternative with igraph
# igraph::plot.igraph(cas.rs2, vertex.color = 'orange',
#         vertex.size =3, vertex.frame.color = NA,
#         vertex.label.cex = 0.5,edge.curved = 0.1, edge.arrow.size =0.4,
#         mark.groups = igraph::communities(com))

title('b', adj = 0, cex=1)
g <-rs.net(dat = dat, 1)
plotnet(g)
title ('c', adj = 0, cex = 1)

#set old par
# par(op)

```


## Methods
 **_Data:_** The regime shifts database is to our knowledge the largest online repository of regime shifts in social-ecological systems. It offers syntheses and a regime shift analysis for over 30 generic types of regime shifts and over 300 case studies based on literature review of over 800 scientific papers [@Biggs:2015iha]. The database decomposes regime shifts in terms of describing their regimes, drivers, feedback mechanisms and impacts on ecosystem services. It provides a series of categorical variables about impacts, scales, evidence type; as well as a causal loop diagram that summarizes the feedback structure of each system [@Biggs:2015iha].

Causal loop diagrams consist of variables connected by arrows denoting causal influence. Each relationship must have a positive (+) or negative (-) polarity that represents the effect of the dependent variable given change on the independent variable [@Lane:2008p6781; @Sterman:2000we]. Although the functional form that underlies each relationship is assumed to be unknown, positive relationships are proportional while negative are inverse proportional. Feedback loops are the basic structural units of the diagram and emerge by connecting variables in closed directed paths (cycles). Feedback means that once a signal enters the loop, some part of the output is feed back to the input, resulting on amplification or dampening of its own signal. Feedbacks can be reinforcing if the overall polarity of its links is positive, or balancing if negative. Reinforcing feedbacks are usually responsible for behaviours that drives the system out of equilibrium, while balancing feedbacks are responsible for near equilibrium dynamics such as oscillations and delays. Note that causal links do not describe the behaviour of variables, only the structure of the system. They describe what would happen if there were changes [@Sterman:2000we].

Through synthesis of current scientific literature, the regime shifts database offers causal loop diagrams as a summary of the driving processes and underlying feedbacks of regime shifts. They represent a collection of causal mechanisms that scientist have reported in their narratives: both empirical (what they choose to sample) or theoretical (what they choose to model). When possible, entries to the regime shifts database have been peer reviewed by an expert on the topic to ensure quality and accuracy of its contents [@Biggs:2015iha].

**_Forks:_** correspond to regime shifts that share common drivers (Fig 1a). This type of connection is expected to increase the likelihood of synchronization in space and time of different regime shift phenomena, both in terms of cases (e.g. two different coral reefs) or regime shift types (e.g. thermokrast lakes and peatland transitions both driven by climate warming). Rocha _et al._ [-@Rocha:2015du] used a bipartite network to study this _fork_ connections by asking what are the main drivers or regime shifts globally. Here we reconstruct a similar network with an updated version of the regime shifts database. Drivers are variables outside feedback mechanisms and are linked to regime shifts nodes if there is a reference in the scientific literature suggesting causality [@Rocha:2015du]. We study what type of micro configurations better explain the global patterns of the network by applying exponential random graph models on the bipartite graph [@Hunter:2007bq].

**_Domino effects_** occur when the occurrence of a regime shift can increase or decrease the likelihood of other regime shift occurring. We explore potential domino effects by using the full causal loop diagrams as networks.  Set differences between causal pathways suggest missing drivers, and set intersection between causal pathways and feedback loop communities indicate potential domino effects: when a variable belonging to a feedback mechanisms is in turn the driver of another regime shift.

**_Inconvenient feedbacks:_** are cycles or feedback loops that might connect two different regime shifts; if strong enough, it could amplify or dampen the coupled dynamics. This type of connection is often disregarded because research on regime shifts usually focus on one system at the time; data collection and hypothesis testing for coupled systems has largely remained unexplored. An inconvenient feedback occurs when the dynamics of one regime shift affects a variable that belongs in turn to another regime shit and vice versa. It means that two regime shifts can reinforce or dampen each other. Here we explore inconvenient feedbacks by pair-wise comparison of causal networks. First, the feedback loops (or cycles) are counted by feedback length for each regime shift separately. Then the same is applied to the composite network of the two regime shifts compared. The difference between the cycles in the composite network and the cycles on the individual networks are the inconvenient feedbacks.

**Modelling:** Generalized modeling is used on an ... [**_can I fit this on this paper? If so we need to choose two regime shifts where coupling is expected (perhaps based on other sections results), model each one separately and then model them together. I believe the complete exercise could be a paper in itself, but happy to include here if it's not too much._**


## Results

The results are intended to be a demonstration of how the framework can be used by applying it to minimal examples; while further exploration on how the framework could be developed both theoretically and empirically will be presented in the discussion. The minimal examples reflect the natural grouping already reported in the regime shifts database. Contributors to the regime shifts database were asked whether they believed that the particular regime shift contributed had a relationship with any of the other regime shifts already documented. Figure 1b depicts such believes in the form of a directed network. It shows that cascading effects are thought to be more likely between systems that share ecosystem type. Roughly the major groupings correspond to aquatic, terrestrial and arctic systems. Some regime shifts are believed to be isolated, meaning that contributors did not report potential interconnections, or simply disregard the question. Such is the case of salt marshes to tidal flats, common pool resource harvesting, and river channel position. First we present results for forks using the full dataset (n = 30). Following the grouping suggested in Figure 1b, we investigate domino effects by looking at a subset of Arctic regime shifts (n = 8), while inconvenient feedbacks are investigated using a subset of regime shifts in drylands (n = 5).

A preliminary exploration of _fork_ type of connections was introduced by Rocha et al [-@Rocha:2015du]. Here we update their analysis to `r length(levels(dat$Regime.Shift))` regime shifts and show how drivers importance can be inferred from the network structure. Figure 2 presents a bipartite network composed by X drivers and X regime shifts. {**_expand results here_**}

> + complement results with ERGMs and graph statistics


```{r Fig2, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 6, fig.width = 4, dev.args = list(pointsize= 8), fig.align='center', fig.cap = 'Bipartite network of sharing drivers or forks, version updated from Rocha et al (2015).'}


## Setting the bipartite network
nets <- list()
bip.edgelist <- list()

for (i in 1:length(levels(dat$Regime.Shift)) ){ #length(levels(dat$Regime.Shift))
	net <- rs.net(dat = dat,  i = i)
	fb <- kcycle.census(net, maxlen = network.size(net), mode = 'digraph', tabulate.by.vertex=T, cycle.comembership = 'sum' )
	driv <- names(colSums(fb$cycle.count)[colSums(fb$cycle.count) == 0])
	rs.nam <- rep(net %n% "name", length(driv))
	df <- data.frame(drivers = driv, rs = rs.nam)
	bip.edgelist[[i]] <- df
    nets[[i]] <- net
}

bip.edgelist <- bind_rows(bip.edgelist)
bipmat <- as.matrix(table(bip.edgelist))

library(bipartite)
N <- nestedness(bipmat, null.models=TRUE, n.nulls=100)
nest <- nestedrank(bipmat, method="binmatnest", normalise=T, return.matrix=F)

network.layout.nest <- function (d, layout.par){
	y <- c(nest[[1]],nest[[2]])*-20
	x <- c(rep(0,dim(bipmat)[1]), rep(3,dim(bipmat)[2]))
	cbind(x,y) # q <- t(rbind(x,y))
}

y <- c(nest[[1]],nest[[2]])*-20
x <- c(rep(0,dim(bipmat)[1]), rep(3,dim(bipmat)[2]))

bip1 <- network(bipmat, bipartite = T)
degbip <- sna::degree(bip1, gmode="graph")


op <- par()

par(mar=c(1,1,1,1)) #, xaxs = 'i', yaxs = 'i'
# Plotting the bipartite network
# plot.new(asp = 1,  xlim = c(5,-2), ylim = c(2,-22), type = 'n')
plot.network(bip1, edge.lwd=0.01, usecurve=F, edge.curve= -0.01,
    vertex.cex= degbip*0.05, displayisolates=F, interactive=F,
    mode="nest", jitter=F,  vertex.lty=1, vertex.border = 'white',
    edge.col = "gray84", suppress.axes = T, ylim = c(-22, 2))
#labels for drivers
text(x,y,c(network.vertex.names(bip1)[1:74],rep(' ',25)), pos=2, col='grey12', cex = 0.5)
#labels for RS
text(x,y,c(rep(" ", 74),network.vertex.names(bip1)[75:99]), pos=4, col='grey12', cex = 0.5)
# title("b", adj = 0, cex = 0.7)


### Alternative visualiztion with circlesize

# library(circlize)
# quartz(width=7, height =7, family = 'Helvetica', pointsize = 5)
# chordDiagram(bip.edgelist, annotationTrack = "grid", preAllocateTracks = list(track.height = 0.3))
#
# ## from tutorial
# circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
#     xlim = get.cell.meta.data("xlim")
#     xplot = get.cell.meta.data("xplot")
#     ylim = get.cell.meta.data("ylim")
#     sector.name = get.cell.meta.data("sector.index")
#     #if(abs(xplot[2] - xplot[1]) < 20) {
#         circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise",
#         niceFacing = TRUE, adj = c(0, 0.5), cex = .8) #}
#     # else {circos.text(mean(xlim), ylim[1], sector.name, facing = "inside",
#     #     niceFacing = TRUE, adj = c(0.5, 0), cex = .8)
#     # }
# }
# , bg.border = NA)
#
# detach(package:circlize)

```

Domino effects were investigated by searching variables that belong to feedback mechanisms in one regime shift and at the same time can be drivers of another. Figure 3a shows the resulting directed graph for 8 regime shifts in the Arctic. Connections between regime shifts typically occur when a larger-scale regime shift include on its mechanism variables that in turn are drivers on smaller-scale regime shifts. The stronger connection found between the Arctic regime shifts is between thermohaline circulation (Fig 3b) and fisheries collapse (Fig 3c), with three different pathways. Their causal networks show how climate change, sea surface temperature, and water stratification are part of the processes underlying the weakening of the thermohaline circulation, as well as drivers of fisheries collapse. The example also serves to illustrate how the method can be used for identification of missing drivers or feedback variables: In the thermohaline circulation network the relationship between sea surface temperature and water stratification is mediated by water density, while in fisheries collapse is a direct relationship.


```{r Fig3, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 4, fig.width = 10, dev.args = list(pointsize= 8), fig.align='center', fig.cap = 'Domino effects'}

## Domino effects will be studied with Arctic regime shifts. This is: if a driver in one regime shift is part of a feedback in another.

# subset the dominoes dataset
dom <- filter(dat, Regime.Shift == 'Arctic Sea Ice collapse'|
                Regime.Shift == 'Fisheries collapse' |
                Regime.Shift == 'Greenland Ice Sheet collapse'|
                Regime.Shift == 'Marine foodwebs'|
                Regime.Shift == 'Thermohaline circulation' |
                Regime.Shift == 'Tundra to forest'|
                Regime.Shift == 'Steppe to Tundra' |
                Regime.Shift == 'Peatland transitions'
                )
dom <- droplevels(dom)

# list for network outcomes
out_dom <- list()

for (i in 1:length(levels(dom$Regime.Shift))){
    net <- rs.net(dom, i)
    out_dom[[i]] <- net
}

key <- combn(seq(1, length(levels(dom$Regime.Shift))),2)


out <- list()
for (i in 1:dim(key)[2]){
    # drivers in regime shift i
    x1 <- (out_dom[[key[1,i]]] %v% 'vertex.names') [out_dom[[key[1,i]]] %v% 'col' == 'grey84']
    # feedback variables in regime shift j
    y1 <- (out_dom[[key[2,i]]] %v% 'vertex.names') [out_dom[[key[2,i]]] %v% 'col' != 'grey84']

    # drivers in regime shift j
    x2 <- (out_dom[[key[2,i]]] %v% 'vertex.names') [out_dom[[key[2,i]]] %v% 'col' == 'grey84']
    # feedback variables in regime shift i
    y2 <- (out_dom[[key[1,i]]] %v% 'vertex.names') [out_dom[[key[1,i]]] %v% 'col' != 'grey84']

    # resulting interactions
    df1 <- data.frame(Tail = out_dom[[key[2,i]]] %n% 'name',
                    Head = out_dom[[key[1,i]]] %n% 'name',
                    weight = sum(x1 %in% y1),
                    driv2feed = paste(x1[x1 %in% y1], collapse = ', ') )
    df2 <- data.frame(Tail = out_dom[[key[1,i]]] %n% 'name',
                    Head = out_dom[[key[2,i]]] %n% 'name',
                    weight = sum(x2 %in% y2),
                    driv2feed = paste(x2[x2 %in% y2], collapse = ', '))
    df <- bind_rows(df1,df2)

    out[[i]] <- df
}

out <- bind_rows(out)
# domino <- select(out, Tail, Head, weight = weight1dir)
# domino <- rbind(domino, select(out, Tail = Head, Head = Tail, weight = weigth2dir))

dom_net <- network(filter(out, weight > 0),
    directed = T, ignore.eval = FALSE, matrix.type = 'edgelist')

dom_net %v% 'indegree' <- sna::degree(dom_net, cmode = 'indegree')
dom_net %v% 'outdegree' <- sna::degree(dom_net, cmode = 'outdegree')

# quartz(width = 12, height = 4, pointsize = 9)
par(mfrow = c(1,3))


### change this figure by a heatmap.
plot.network(dom_net,
    label = network.vertex.names(dom_net),
    label.cex= 1, label.pos= 5,
    edge.lwd = 2 * dom_net %e% 'weight' ,
    #edge.curve = 0.01, usecurve=F,
    displayisolates=T, pad=1,
    vertex.col = alpha('orange', 0.5),
    edge.col = alpha('grey', 0.5)
    )
title('a', adj= 0, cex = 3)

# mutuality(dom_net)
## plotting parameters for disciplines
# p <- ggnet2(net = dom_net, size = 3,
#         #size.legend = "Number of papers",
#         #label.size = 2,
#         #mode = 'mds',
#         #node.color = 'orange',
#         node.color = dom_net %v% 'indegree' + 1,
#         node.alpha = 0.3,
#         edge.color = "grey10",
#         edge.alpha = scales::rescale(dom_net %e% "weight", to = c(0.25, 1)),
#         edge.size = scales::rescale(dom_net %e% "weight", to = c(0.25, 1)),
#         arrow.size = 5, arrow.gap = 0.025
#         )
#
# p + scale_fill_gradient("Indegree", high = "red", low = "yellow")
#
# p <- ggnetworkmap(net = dom_net, arrow.size = 0.2,
#     node.group = indegree,
#              ring.group = outdegree, size = 4) +
#   scale_fill_continuous("Indegree", high = "red", low = "yellow") +
#   labs(color = "Outdegree")
#
# p
# p + scale_fill_gradient("Indegree", high = "red", low = "yellow") +
#   labs(color = "Outdegree")

plotnet(out_dom[[7]]); title('b', adj = 0, cex= 3)
plotnet(out_dom[[2]]); title('c', adj = 0, cex= 3)

```
In order to identify potential inconvenient feedbacks we merged causal networks and found that most inconvenient feedbacks occur at higher feedback length. Figure 4 elaborates a minimal example for bush encroachment and desertification. First all feedbacks are counted and classified by length for each individual network. Once the networks are merged, the identification of inconvenient feedbacks is facilitated by subtracting the resulting feedback counts minus the expected feedbacks (the sum of each individual count). Figure 5 takes this approach forwards and compares all pair-wise combinations of drylands regime shifts in the regime shifts database. Not all regime shifts are connected by inconvenient feedbacks (e.g. forest to savanna and steppe to tundra), but when inconvenient feedbacks do occur they tend to be on the right side of the distribution at longer lengths. Particularly strong connections are found between desertification and soil salinization, as well as between bush encroachment and forest to savanna.

```{r Fig4, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 4, fig.width = 6, dev.args = list(pointsize= 8), fig.align='center', fig.cap = 'Inconvenient feedbacks. Causal networks are depicted as networks for the minimal example of bush encroachment (a) and desertification (b). Drivers are coloured gray, variables inside feedback loops are yellow, positive links are blue and negative red. The size of the node and the width of links are scaled relative to the number of feedback loops that include each node or edge respectively. The histograms on the bottom show the number of feedback loops per feedback length on the original networks; while c) shows both the coupled network for both regime shifts and its histogram with new unidentified feedbacks in red.'}

# A function to merge networks based on edge lists aggregation
# Note this comes from another script and needs to be updated to the variables declared here.

net.merge <- function(dat,i,j){
    # create network. Attributes are already declared when using ignore.evale = F
    df <- rbind(
        filter(dat, Regime.Shift ==
                     levels(dat$Regime.Shift)[i], Polarity == 1 | Polarity == -1),
        filter(dat, Regime.Shift==
                     levels(dat$Regime.Shift)[j], Polarity == 1 | Polarity == -1))

		rs.mix <- network(select(df, Tail, Head, Polarity, col),
                directed = T, ignore.eval = F, matrix.type = 'edgelist')
    # Add cycles to nodes and edges
		fb.sum <- kcycle.census(rs.mix, maxlen=network.size(rs.mix), mode='digraph', tabulate.by.vertex=T, cycle.comembership='sum')
        rs.mix %v% 'fb' <-  diag(fb.sum$cycle.comemb)
		rs.mix %e% 'fb' <-  as.sociomatrix(rs.mix) * fb.sum$cycle.comemb
    # name the network
        rs.mix %n% 'name' <- paste(levels(dat$Regime.Shift)[i],
			levels(dat$Regime.Shift)[j], sep=' - ')
    # add vertex attributes
        rs.mix %v% 'col' <- ifelse(colSums(fb.sum$cycle.count)[-1] == 0, "grey84", 'goldenrod2')
	return(rs.mix)

}

key <- combn(seq(1,5),2)

# subset dataset
rs <- filter(dat, Regime.Shift == 'Bush encroachment'|
                Regime.Shift == 'Desertification' |
                Regime.Shift == 'Forest to savanna'|
                Regime.Shift == 'Steppe to Tundra'|
                Regime.Shift == 'Soil Salinisation'
                )
rs <- droplevels(rs)


# The function below is useful when cycles numbers are not calculated. Currently I'm using cycle.comemebership='sum' which gives me the link weigth. As alternative, cycle.comembership='byblength' retunrs an array where each matrix shows cycle co-membership by length.
# source('~/Dropbox/Code/themeJuan.R')

net.fb <- function(net1, net2, net3){

	#count cycles for all networks
	x1cycle <- kcycle.census(net1, maxlen=network.size(net3), mode='digraph',
		tabulate.by.vertex=T, cycle.comembership='sum')

	x2cycle <- kcycle.census(net2, maxlen=network.size(net3), mode='digraph',
		tabulate.by.vertex=T, cycle.comembership='sum')

	x3cycle <- kcycle.census(net3, maxlen=network.size(net3), mode='digraph',
		tabulate.by.vertex=T, cycle.comembership='sum')

	#create a matrix with results
	feed.mat <- cbind(x1cycle$cycle.count[,1], x2cycle$cycle.count[,1],
		 x3cycle$cycle.count[,1]) # feedbacks matrix
	# put some colnames
	colnames(feed.mat) <- c('RS1', 'RS2', 'RS.mix')
	#c(net1 %n% 'name', net2 %n% 'name', net3 %n% 'name')

	feed.mat <- as.data.frame(feed.mat)
	feed.mat$feed.length <- rownames(feed.mat)
	feed.mat$Inconvenient <- feed.mat$RS.mix - (feed.mat$RS1 + feed.mat$RS2)
    feed.mat$Expected <- (feed.mat$RS1 + feed.mat$RS2)

	#put data on long format
	require(reshape2)
	x.long <- melt(feed.mat, id.var="feed.length",
			 measure.var= colnames(feed.mat)[c(1:3,5,6)],
			 value.name='value')

	x.long$value <- as.integer(x.long$value)
	x.long$feed.length <- as.integer(x.long$feed.length)

	# plot it
	require(ggplot2)
	g <- ggplot(filter(x.long, variable == 'Expected' | variable == 'Inconvenient' ), aes(x=feed.length, y=value), group=variable)
	g <- g + geom_bar(aes(fill=variable), position = 'stack', stat = 'identity')  +
		ylab('Number of feedbacks') + xlab('Feedback length') +
		ggtitle(net3 %n% 'name') + theme_bw(base_size = 7) +
		theme(legend.position=c(0.8,0.7), plot.title=element_text(size=rel(0.85))) + scale_fill_manual("Feedbacks",values=c("#377EB8CC", "#E41A1CCC")) + xlim(0, max(x.long[x.long$value > 0, ]$feed.length))
# colors not used "#984EA3", "#4DAF4A"
	return(list(feed.mat, g)) # , g
}

## update plotnet to plot smaller nodes and no labels
plotnet <- function(net, ...){
	plot.network(net, #mode='circle',
			vertex.col = alpha(net %v% 'col', 0.8),
			# label = network.vertex.names(net),
			# boxed.labels=F,
			# label.cex=0.5,
			main = net %n% 'name', col.main = "grey",
			vertex.border = 0,
			usecurve=T,
			vertex.cex= 2 + scale(net %v% 'fb')/2,
			label.pos=5,
			edge.col= alpha(net %e% 'col' , 0.75),
			edge.lwd = 0.05 + net %e% 'fb',
			edge.curve = 0.01,
			displayisolates=T, pad=1
			)
		}


## automatize from here!
# list of results
out <- list() # output for merged networks

for (i in 1:dim(key)[2]){
	out[[i]] <- net.merge(rs, i = key[1,i], j = key[2,i])
}

out_dat <- list()
out_graph <- list() # output for graphics
for (i in 1:dim(key)[2]){
    x <- net.fb(rs.net(rs, key[1,i]), rs.net(rs, key[2,i]), out[[i]])
    out_dat[[i]] <- x[[1]]
    out_graph[[i]] <- x[[2]]
}

# rs1 <- list()
# rs1 <- apply(rs.net, rs, )
#
rs1 <- rs.net(rs, 1)
rs2 <- rs.net(rs, 2)
# rs3 <- rs.net(rs, 3)
# rs4 <- rs.net(rs, 4)
# rs5 <- rs.net(rs, 5)
#
# x1 <- net.fb(rs1,rs2, out[[1]])[[2]]
# x2 <- net.fb(rs1,rs3, out[[2]])[[2]] + theme(legend.position='none')
# x3 <- net.fb(rs1,rs4, out[[3]])[[2]]
# x4 <- net.fb(rs2,rs3, out[[4]])[[2]]
# x5 <- net.fb(rs2,rs4, out[[5]])[[2]]
# x6 <- net.fb(rs3,rs4, out[[6]])[[2]]

x <- melt(out_dat[[1]], id.var="feed.length",
         measure.var= colnames(out_dat[[1]])[c(1:3,5,6)],
         value.name='value') %>%
         mutate(feed.length = as.integer(feed.length))

x$variable <- factor(x$variable, levels = rev(levels(x$variable)))

library(forcats)
g1<-ggplot(filter(x, variable == 'RS1'),
    aes(x=feed.length, y=value)) +
    geom_bar( position = 'dodge', stat = 'identity')  + ylab('Number of feedbacks') + xlab('Feedback length') + xlim(0,max(out_graph[[1]]$data[out_graph[[1]]$data$value > 0, ]$feed.length)) + theme_minimal(base_size = 7) + ylim(0,5)
g2<-ggplot(filter(x, variable == 'RS2'),
    aes(x=feed.length, y=value)) + geom_bar( position = 'dodge', stat = 'identity')  + ylab('Number of feedbacks') + xlab('Feedback length') + xlim(0,max(out_graph[[1]]$data[out_graph[[1]]$data$value > 0, ]$feed.length)) + theme_minimal(base_size = 7) + ylim(0,5)
g3 <- ggplot(filter(x,  variable == 'Inconvenient' | variable == 'Expected') ,
    aes(x=feed.length, y=value)) +
    geom_bar( position = 'stack', stat = 'identity', aes(fill = fct_rev(variable)))  +
    ylab('Number of feedbacks') + xlab('Feedback length') + xlim(0,max(out_graph[[1]]$data[out_graph[[1]]$data$value > 0, ]$feed.length)) + theme_minimal(base_size = 7) + ylim(0,5) +
    scale_fill_manual("New feedbacks",values=c("#E41A1C","#377EB8")) +
    theme(legend.position=c(0.8,0.8))

g <- list() # list of plots

for (i in 2:length(out_dat)){
    x <- melt(out_dat[[i]], id.var="feed.length",
             measure.var= colnames(out_dat[[i]])[c(1:3,5,6)],
             value.name='value') %>%
             mutate(feed.length = as.integer(feed.length))
    x$variable <- factor(x$variable, levels = rev(levels(x$variable)))         
    g[[i-1]] <- ggplot(filter(x,  variable == 'Inconvenient' | variable == 'Expected') , aes(x=feed.length, y=value)) +
        geom_bar( position = 'stack', stat = 'identity', aes(fill = fct_rev(variable)), show.legend = F)  +
        ylab('Number of feedbacks') + xlab('Feedback length') +
        xlim(0,max(out_graph[[i]]$data[out_graph[[i]]$data$value > 0, ]$feed.length)) + theme_minimal(base_size = 4 ) + ylim(0,5) +
        scale_fill_manual("New feedbacks",values=c("#E41A1C","#377EB8")) +
        theme(legend.position=c(0.7,0.7)) + ggtitle(out[[i]] %n% 'name')
}


# The graph g3 has the wrong order of bars but haven't been able to correct it. ON the to do list.
# ggplot(filter(x,  variable == 'Inconvenient' | variable == 'Expected') %>% droplevels(),
#     aes(x=feed.length, y=value)) +
#     geom_bar( aes(fill=variable), position = 'stack', stat = 'identity')  + ylab('Number of feedbacks') + xlab('Feedback length') + xlim(0,max(out_graph[[1]]$data[out_graph[[1]]$data$value > 0, ]$feed.length))  + ylim(0,5)

library(gridBase)
library(grid)
library(gridExtra)


# quartz(width = 6, height = 4, pointsize = 7)
par(mfrow = c(2,3)) # layout(matrix(1:12,4,3, byrow=T))
plot.new()
# grid.newpage() # I need this line to plot on quartz, but not on markdown pdf.
pushViewport(viewport(layout = grid.layout(2,3)))

## First networks
pushViewport(viewport(layout.pos.row=1, layout.pos.col=1))
par(fig = gridFIG(), new = TRUE)
plotnet(rs1)
popViewport()
pushViewport(viewport(layout.pos.row=1, layout.pos.col=2))
par(fig = gridFIG(), new = TRUE)
plotnet(rs2)
popViewport()
pushViewport(viewport(layout.pos.row=1, layout.pos.col=3))
par(fig = gridFIG(), new = TRUE)
plotnet(out[[1]])
popViewport()

## Then the feedback histograms
pushViewport(viewport(layout.pos.row=2, layout.pos.col=1))
print(g1, newpage = F)
popViewport()

pushViewport(viewport(layout.pos.row=2, layout.pos.col=2))
print(g2, newpage = F)
popViewport()

pushViewport(viewport(layout.pos.row=2, layout.pos.col=3))
print(g3, newpage = F)
# popViewport()

```

## Discussion

This paper aims to develop a framework for exploring potential cascading effects among critical transitions in social-ecological systems. A graphical approach allows us to treat regime shifts as causal networks composed by feedback mechanisms and drivers reported in the regime shifts database. Regime shifts interactions can occur when sharing drivers (_forks_), or when _domino effects_ or _inconvenient feedbacks_ are strong enough to couple their dynamics. While their dynamic behaviour is outside the scope of this paper, the topological features that would allow coupling are explored here and serve as a conceptual devise for hypothesis exploration and further modeling.

Intuitively, the sharing of drivers is proposed as a potential mechanisms that can correlate regime shifts in space and time, but not necessarily make them interdependent; unless they also share feedback mechanisms. Time correlation is debated given that spatial heterogeneity can break the synchrony induced by the sharing of drivers, meaning that contextual settings matter for such correlations to emerge [@Hughes:2013cv]. Spatial heterogeneity is also attributed as mechanism that can smooth out critical transitions and soften their abruptness [@Martin:2015kl; @Medeiros:2016vf]. Yet, with or without masking mechanism, identifying fork type of connections is useful for designing management strategies that target bundles of drivers instead of well studied variables independently, increasing the chances that managers will avoid several regime shifts under the influence of the same sets of drivers [@Rocha:2015eea; @Rocha:2015du]. For example, management options for drivers such as sedimentation, nutrients leakage, and fishing can reduce the likelihood of regime shifts in coastal brackish lagoons such as eutrophication and hypoxia, as well as coral transitions in adjacent coral reefs. {In fact, the framework reveals that there is not fork interactions without either domino effects or inconvenient feedbacks **_need to check_**}.

Examples of cascading effects between regime shifts have been reported in the literature, but here we have developed a framework to explore graphically what type of mechanisms can underly regime shifts coupling. For example, eutrophication is often reported as a preceding ecosystem state to hypoxia or dead zones in coastal areas [@Diaz:2008p199]. Moisture recycling feedback is an important process reported as a key mechanism on the shift from forest to savanna or the Indian monsoon; but also has the potential to couple ecosystems beyond the forest that depend on moisture recycling as an important water source. Changes in moisture recycling can affect mountain forest in the Andes [@Clark:2015bj; @MoruetaHolme:2015fy], nutrient cycling in the ocean by affecting sea surface temperature and therefore regime shifts in marine food webs [@Bakun:2010p5340], or exacerbation of dryland related regime shifts [@DebraPCPeters:2004ex]. These examples have in common that a larger scale feedback affects a more localized dynamic in another ecosystem. However, the opposite is also possible, when the accumulation of small-scale process scale up and impact larger scale dynamics. Peters [@Anonymous:2007tc] have already explore under this line of thinking the dynamics of the dust bowl, desertification, or amplification of fire dynamics. More recently it has been reported that increasing frequency of boreal forest fire could be actually strong enough to increase warming in the Arctic [@Young:2016kj; @Kelly:2015iq]. Permafrost thawing across the Arctic peatlands can be a dangerous amplifier of global warming by release of methane [@Zona:2016hq]. Mangrove forest are expected to store less carbon as their areas shrink and their ability to build peat soils is overwhelmed by sea level rise; however it is unclear if the effect will be comparable as to impact global carbon budgets and further warming [@Alongi:2014kq].

The framework allow us to explore more rigorously the type of potential couplings between regime shifts. For our sample of 30 regime shifts reported in the regime shifts database, 435 possible pair-wise combinations exist. Exploring such search space is not a trivial task. Once the mechanisms responsible for one coupling is identified, it still remains to be explored the parameter space at which the coupling is plausible. While the literature continue to provide examples of potential couplings, our framework allow us to distinguish whether the coupling is expected to be correlation because of sharing drivers, a one-way causation (the domino effect), or a two-way interaction (the inconvenient feedbacks). Here we have use minimal examples to demonstrate the usefulness of the framework. Arctic regime shifts are prone to domino effects mainly mediated by changes in temperature that is part of some feedbacks and in turn a driver for other regime shifts. An exception to this pattern is the links between thermohaline circulation and fisheries collapse (shown in Fig 3) or the reconfiguration of marine food webs, mediated by alteration of nutrients cycling as the current weakens. Conversely, the analysis of inconvenient feedbacks in drylands shows that not all regime shifts are connected to each other. Regime shifts in non-adjacent ecosystems do not present new inconvenient feedbacks such as the case of tropical forest to savannas versus steppe to tundra in temperate areas. When inconvenient feedbacks do occur, they tend to have long feedback length. This analysis of counting cycles by length can be computationally extensive in large and dense networks, since the number of cycles grow exponentially as the number of links increase. However, for our analysis of causal networks, the size of the network is manageable and the maximum feedback length is bounded by the maximum number of nodes, in our case not more than 20 (Fig 5).

Our analysis is purely topological, it shows what potential domino effects or feedbacks could exist, but it does not reveals whether the connection is strong enough to couple the dynamic behaviour of systems known to be prone to regime shifts. A further area of research could ask under which conditions are these couplings plausible? While experimentation is rarely an option for testing this large scale ecosystem dynamics, observational studies are of prime importance as well as modeling efforts. Dynamic models of this type of dynamics require careful assumptions about parameter values as well as functional form of the system's equations. Alternatively, generalized modeling is a promising technique that does not require particular assumptions allowing the researcher to reach more general conclusions based on the systems Jacobian [@Gross:2009jr; @Gross:2004uu; @Lade:2013iw]. Another potential avenue for future research is looking at how transport mechanisms couple far apart ecosystems. One example already mentioned is the moisture recycling feedback and how it can affect the water budget of areas down the '_preceipitationshed_'[@Keys:2012bo]. Another teleconneciton could be with international allocation of resources through trade, investigating how demand of resources in certain countries can shape the ecosystems of the providing countries.

```{r, Fig5, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 4, fig.width = 4, dev.args = list(pointsize= 5), fig.align='center', fig.cap = 'Inconvenient feedbacks in drylands. Blue bars show feedbacks present on the individual causal network of each regime shifts. Red bars shows the emergent inconvenient feedbacks when two regime shift networks are joined'}
source('~/Dropbox/Code/multiplot.R')
layout <- matrix(1:9, 3,3)
multiplot(plotlist = g, layout = layout)

```

## Conclusion

Non-linear dynamics are ubiquitous to a large range of social-ecological systems. However, how a regime shift somewhere in the world could affect the occurrence of another regime shift remains an open question and a key frontier of research. Here we have developed a graphical framework to explore potential cascading effects amongst regime shifts. Based on topological features of causal networks three type of connections have been proposed in a framework and identified in minimal examples. Potential correlations due to sharing drivers are denominated _forks_, while the spatio-temporal correlation can be masked by heterogeneity or noise, the cluster of sharing drivers serves to design managerial strategies. One-way directional interactions are denoted as _domino effects_ and seems ubiquitous in the example of Arctic regime shifts, while  two-way interconnections are denoted _inconveneint feedbacks_, present in some dryland regime shifts. The two later types of cascading effects call for a more holistic approach for modeling and studying regime shifts, acknowledging their potential interdependences.

## Supplementary material

```{r supp1, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 7, fig.width = 7, dev.args = list(pointsize= 6), fig.align='center', fig.cap = 'Supplementary figure 1. Causal netoworks for all regime shifts'}

detach(package:igraph)
library(network); library(sna)
#quartz(pointsize = 7)
par(mfrow = c(5,5))

for (i in 1:length(levels(dat$Regime.Shift)) ){
	net <- rs.net(dat = dat,  i = i)
	plotnet(net)

}
```

```{r failures, echo = FALSE}
### J161213: This was an attempt to map communities and do the analysis above based on community structure. It doesn't work neatly.
#What didn't work:
# detach(package:bipartite)
# detach(package:sna)
# detach(package:network)
# library(igraph)
#
# g <- graph.data.frame(d=filter(dat, Regime.Shift == 'Desertification'),  directed = T) #vertices = df,
#
# # set attributes from loop counting
# E(g)$fb <- nets[[5]] %e% 'fb'
# V(g)$color <- nets[[5]] %v% 'col'
#
# com <- infomap.community(g, mod=F, nb.trials=200) #without weights
# com <- infomap.community(g, mod=F, e.weights = E(g)$Polarity, v.weights = 1 + V(g)$loops, nb.trials=200) # uses polarity on edges and # fb on vertex
# com <- infomap.community(g, mod=F, e.weights = E(g)$Polarity,  nb.trials=200) #only uses polarity
# com <- infomap.community(g, mod=F, e.weights = 1 + E(g)$fb ,  nb.trials=200) #only uses #fb
#
# plot.igraph(g, vertex.color = V(g)$col,
#     vertex.size =3, vertex.frame.color = NA,
#     vertex.label.cex = 0.5,
#     edge.color = E(g)$col,
#     edge.width = 0.5 + sqrt(E(g)$fb),
#     edge.curved = 0.1, edge.arrow.size =0.4,
#     main = nets[[5]] %n% 'name',
#     mark.groups = communities(com)
#     )
#
# ## Now this is working, perhaps should be included in appendix, how the algorithm separates different communities... just for visualization.
# ## can a graph = matrix be reduced on rref and threat that as a core matrix of the cld or system of equations?
# detach(package:igraph)

```
