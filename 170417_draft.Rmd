---
title: Cascading effects of critical transitions in social-ecological systems

author: Juan C. Rocha
    # affiliation: a,1,2
address:
  - code: a
    address: Stockholm Resilience Centre, Stocholm University, Kräftriket 2B, 10691 Stockholm
  - code: b
    address: Beijer Institute, Swedish Royal Academy of Sciences, Lilla Frescativägen 4A, 104 05 Stockholm

corresponding_author:
  - code: 2
    text: "To whom correspondence should be addressed. E-mail: juan.rocha@su.se"

date: "`r format(Sys.time(), '%B %d, %Y')`"

abstract: |
  Critical transitions in nature and society are likely to occur more often and severe as humans increase they pressure on the world ecosystems. Yet it is largely unknown how these transitions will interact, whether the occurrence of one will increase the likelihood of another, and whether these potential teleconnections (social and ecological) correlate critical transition in distant places. Here we present a framework for exploring three types of potential cascading effects of critical transitions$:$ forks, domino effects and inconvenient feedbacks. Drivers and feedback mechanisms are reduced to a network form that allow us to explore drivers co-occurrence (forks). Sharing drivers is likely to increase correlation in time or space among critical transitions but not necessarily interdependence. Domino effects occur when the feedback processes of one regime shifts affect the drivers of another, creating a one way dependence. Inconvenient feedbacks were identified by mapping new circular pathways on coupled networks that have not been previously reported. The method serves as a platform for hypothesis exploration of plausible new feedbacks between critical transitions in social-ecological systems; it helps to scope structural interdependence and hence an avenue for future modelling and empirical testing of regime shifts coupling.

keywords: "regime shifts, cascading effects, tele-connections, networks"

header-includes:
- \usepackage{dcolumn}
- \usepackage{lineno}
- \linenumbers

fontsize: 9pt
csl: nature.csl
bibliography: cascading.bib
lineno: true
documentclass: article
linkcolor: blue
urlcolor: blue
citecolor: blue


output:
  pdf_document:
    toc: no
    keep_tex: true
    latex_engine: pdflatex
    dev: pdf

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list = ls())
set.seed(12345)
library (dplyr)
library (tidyr)
library (network)
library (sna)
library(RColorBrewer)
library(ggplot2)
library(GGally)

# for plotting
library(ggmap)
library(maptools)
library(maps)
library(mapproj)

library(gridBase)
library(grid)
library(gridExtra)


## for cleaning models
library(car)
library(broom)
library(sandwich); library(lmtest)

### ERGMS for Regime Shifts
library(ergm.count)

# setwd('~/Documents/Projects/Cascading Effects/Domino')
# Sys.setenv(RSTUDIO_PANDOC="/Applications/RStudio.app/Contents/MacOS/pandoc")
# rmarkdown::render('170125_draft.Rmd', output_format = 'pdf_document')

  # html_document:
  #   code_folding: hide
  #   dev: pdf
  #   self_contained: yes
  #   toc: yes
  #   toc_float:
  #     collapsed: no
  #     smooth_scroll: no
  # word_document: null

```


```{r data_ergm, include=FALSE}
# this loads the data, it was cleaned and prepared with script 170329_read_data.R
# and load the ergm models fitted with script 170329_ergms.R

load('~/Documents/Projects/Cascading Effects/ergm_data.RData')

```
## Introduction
Critical phenomena has been documented on a wide variety of systems from climate, finance, language, neurological diseases, ecosystems and ancient societies [@Sole:2011us; @Scheffer:2009wl]. A large set of critical transitions in social-ecological systems has been identified [@Biggs:2015iha]. As human pressures increase on the planet, these transitions might become more acute and frequent than previously thought[@Lewontin:1969vh]. Research on critical transitions in social-ecological systems is often confined to well defined domains of expertise (e.g. limnology, urbanism, climate science), adopting either an empirical, modelling [@Carpenter2003rsi] or early warnings indicator approach [@Scheffer:2012cta; @Scheffer:2009p4449]. These approaches require a deep knowledge of the causal structure of the system or a high quality spatial-temporal data respectively. These requirements have confined the body of research to the analysis of individual types of critical transitions rather than the potential interactions across systems. Yet, one of the key challenges of sustainability science is analyzing the diverse set of interactions across human-environmental systems [@Liu:2015go]. The aim of this paper is developing a framework for exploring potential interactions amongst critical transitions in social-ecological systems, so called regime shifts.

Regime shifts are large, abrupt and persistent changes in the function and structure of systems [@Scheffer:2003p339; @Scheffer:2001uu]. They present a challenge for ecological management and governance because they are very difficult to predict [@Boettiger:2013bm; @Hastings:2010p5336] and reverse [@Scheffer:2003p339], while having substantial impacts on the availability or ecosystem services that societies rely upon [@Carpenter:2009jr]. A regime is the region of the parameter space where state variables (e.g. vegetation density, coral cover) fluctuate, they are also called equilibrium, alternative stable states, basins or domains of attraction. Systems prone to regime shifts have more than one alternative stable states; under similar parameter values they can suddenly shift from one domain to another when critical thresholds are crossed [@MAY:1977p3426; @Holling:1973p6861]. Change in slow variables (e.g. temperature in coral reefs) often shrinks the basin of attraction, making the system more susceptible to shifting when exposed to shock events (e.g. hurricanes) or the action of external drivers [@Scheffer:2012cta].

How different regime shifts might be interconnected is largely unknown and a key frontier of research [@Liu:2015go; @Hughes:2013cv]. The concept of cascading effect has been used in two seemingly different contexts: i) when referring to the effect of an abrupt change on one species spreading through food webs [e.g. see @Singer:2014gj; @Pauly:1998iw]; and ii) when local interactions are magnified by feedbacks that are reinforced across scales (e.g. erosion or fire) [e.g. see @Anonymous:2007tc; @DebraPCPeters:2004ex]. What these interpretations have in common is that both refer to networked systems (e.g. foodwebs, landscape mosaics) where a signal (e.g. fire, species collapse, disease) spreads broadly or is contained locally depending upon the system's connectivity. The units of these networks are usually species or sets of spatial units that represent ecosystems. Here we broaden the cascading effects concept to networks of regime shifts, when regime shifts can be represented as causal networks of drivers and underlying feedback mechanisms or processes (see methods).

To explore interconnections amongst regime shifts the units of analysis should be regime shifts, and teleconnections [@Liu:2015go] or cross-scale interactions [@DebraPCPeters:2004ex] should be signals strong enough to couple them. In this context, cascading effects could occur if i) two regime shifts are affected by the same driving forces inducing synchronization of the shift (a fork) [@Rocha:2015du], ii) the occurrence of one regime shift affects the drivers of other regime shift (a domino effect) [@Rocha:2010vv; @Hughes:2013cv; @Scheffer:2012cta] or iii) when two regime shifts dynamics generate new inconvenient (not previously identified) feedback dynamics [@Liu:2015go] by reinforcing or damping each other drivers [@Rocha:2010vv]. Here we present a graphical framework to explore such hypothetical interconnections.

## Methods

\textit{Data:} The [regime shifts database](www.regimeshifts.org) is to our knowledge the largest online repository of regime shifts in social-ecological systems (Fig. 1). It offers syntheses and a regime shift analysis for over 30 generic types of regime shifts, > 300 case studies based on literature review of > 1000 scientific papers [@Biggs:2015iha]. The database decomposes regime shifts in terms of describing their regimes, drivers, feedback mechanisms, impacts on ecosystem services, and management options. It provides a set of categorical variables about impacts, scales, evidence type; as well as a causal loop diagram that summarizes the feedback structure of each system [@Biggs:2015iha]. When possible, entries to the regime shifts database have been peer reviewed by an expert on the topic to ensure quality and accuracy of its contents [@Biggs:2015iha].

Through synthesis of current scientific literature, the regime shifts database offers causal loop diagrams as a summary of the driving processes and underlying feedbacks of regime shifts. They represent a collection of causal mechanisms that scientist have reported in their narratives: both empirical (what they choose to sample) or theoretical (what they choose to model). Causal loop diagrams (CLDs) consist of variables connected by arrows denoting causal influence [@Sterman:2000we]. Each relationship must have a positive (+) or negative (-) polarity that represents the effect of the dependent variable given change on the independent variable [@Lane:2008p6781; @Sterman:2000we]. Although the functional form that underlies each relationship is not necessarily known, positive relationships are proportional while negative are inverse proportional _ceteris paribus_. CLDs assume that the causal relationships captured by links are monotonic, while non-linearities are captured by links sets, thus self-loops are not allowed. Feedback loops are the basic structural units of the diagram and emerge by connecting variables in closed directed paths (cycles). Feedback means that once a signal enters the loop, some part of the output is feed back to the input, resulting on amplification or dampening of its own signal. Feedbacks can be reinforcing if the overall polarity of its links is positive, or balancing if negative. Reinforcing feedbacks are usually responsible for behaviours that drives the system out of equilibrium, while balancing feedbacks are responsible for near equilibrium dynamics such as oscillations and delays. Note that causal links do not describe the behaviour of variables, only the structure of the system: they describe what would happen if there were changes [@Sterman:2000we]. CLDs were curated in the regime shifts database in a way that variables names are consistent (e.g. agriculture and cropping is kept as 'agriculture'), and feedback loops comparable (e.g. albedo in the rainfores, Arctic or Antarctic regime shifts is the same feedback).

_Networks:_  Each causal loop diagram was turned into a network by creating the adjacency matrix $M$, where $M_{i,j}$ is $1$ if there is a connection or zero otherwise. Link weights $w_{i,j}$ represent link polarity taking $-1$ if the relationship is expected to be inverse proportional, or $1$ when proportional. In each network, node attributes were coded if a node belongs to a feedback loop -a k-cycle in the network- or not. The later is then by definition a driver, an independent variable whose dynamics are not affected by the dynamics of the system at hand. Note that networks in ecology usually describe inter species interactions such as predation or mutualism. Our approach is different from what has been done in ecology. Here a network describe a set of processes, both biotic and abiotic, that can govern ecosystem regime shifts dynamics. Our approach is inspired by other network applications to processes such as cells metabolic networks or the network of human diseases, where a process is not captured by a link type (e.g. predation) but by a collection of link interactions (e.g. the Krebs cycle). Thus, individual species are not taken into consideration, bur rather their functional role at the aggregated ecosystem scale (e.g. herbivory).

```{r Fig1, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 4, fig.width = 6, fig.align = 'center', fig.cap = "Regime shifts around the world. Large points show generic types of regime shifts (n = 35) while small points are case studies (n=324).", dev.args = list(pointsize = 5)}

coords <- read.csv2("~/Documents/Projects/Cascading Effects/Domino/case_coords.csv", dec = '.')

coord_rs <- read.csv(file = '~/Documents/Projects/Cascading Effects/Domino/rs_coords.csv', dec = '.')
cases <- cbind(cases, coords)
rs <- cbind(rs, coord_rs)
rs$rs <- as.factor(rs$rs)
cases$Type.of.regime.shift <- as.factor(cases$Type.of.regime.shift)
names(cases)[7] <- 'rs'

# correction on RS names for plotting
levels(rs$rs) [17] <- "Marine food webs"
levels(rs$rs) [28] <- "Thermokarst lakes"
levels(cases$rs)[17] <- "Fisheries collapse"
levels(cases$rs)[c(5,22)] <- "Marine food webs"
levels(cases$rs)[c(2,9,12,17,20)] <- "Other"


world <- map_data('world')
world <- fortify(world)

m <- ggplot(world, aes(long, lat)) +
    geom_polygon(fill="grey90", aes(group = group)) +
    geom_path(color="white",aes(group=group), size = 0.2) +
    coord_equal() + theme_void(base_size = 7, base_family = "Helvetica")

m + geom_point(data = cases, aes(lon, lat, color = rs), size = 0.2, show.legend = F) +
    geom_point(data = rs, aes(lon,lat, color = rs), size = 2, show.legend = T ) +
    theme(legend.position = "bottom", legend.text = element_text(size = 4)) +
    scale_color_discrete(guide = guide_legend(title = "Regime shifts documented on the regime shifts database \n Source: www.regimeshifts.org", title.position = 'top', title.hjust = 0.5))



```

_Forks:_ correspond to regime shifts that share common drivers (Fig 2a). This type of connection is expected to increase the likelihood of synchronization in space and time of different regime shift phenomena, both in terms of cases (e.g. two different coral reefs) or regime shift types (e.g. thermokrast lakes and peatland transitions both driven by climate change). Rocha _et al._ [-@Rocha:2015du] used a bipartite network of drivers and regime shifts to study this type of connections. Here we replicate their analysis with an updated version of the regime shifts database (N=30). Drivers are variables outside feedback mechanisms and are linked to regime shifts nodes if there is a reference in the scientific literature suggesting causality [@Rocha:2015du]. Categorical variables from the regime shifts database were used as node attributes: biome type for regime shift nodes and scale of management for driver nodes. The statistical models (see below) were performed for the case of forks on the one-mode network of regime shifts sharing drivers.

_Domino effects_ occur when the occurrence of a regime shift can increase or decrease the likelihood of other regime shift occurring. We explore potential domino effects by using the full causal loop diagrams as networks. The algorithm for identifying domino effects takes the adjacency matrix of two given regime shifts $M_1$ and $M_2$ and identifies all nodes $n \in M_1 \cap M_2$ such that $n$ belong to a feedback in $M_1$ but is a driver in $M_2$. Thus, set differences between causal pathways suggest missing drivers, and set intersection between causal pathways and feedback loop nodes indicate potential domino effects (Fig 2a). By iterating this simple algorithm we derived how many different pathways exist between every pair-wise combination of regime shifts. The resulting non-symmetrical matrix represents a directed network with regime shifts as nodes and link weights as the number of pathways used for statistical analysis (below).

_Inconvenient feedbacks:_ are cycles or feedback loops that might connect two different regime shifts; and if strong enough, it could amplify or dampen the coupled dynamics. This type of connection is often disregarded because research on regime shifts usually focus on one system at the time; data collection and hypothesis testing for coupled systems has largely remained unexplored. An inconvenient feedback occurs when the dynamics of one regime shift affects a variable that belongs in turn to another regime shit and vice versa (Fig 2a). It means that two regime shifts could reinforce or dampen each other. Here we explore inconvenient feedbacks by pair-wise comparison of causal networks. First, the feedback loops (or k-cycles) are counted by feedback length $k$ for each regime shift matrix  $M_1$ and $M_2$ separately. Then the cycle count is applied to the composite network $M_{1,2}$ of the two regime shifts. The difference between the k-cycles in the composite network $M_{1,2}$ and the k-cycles on the individual networks $M_1$ and $M_2$ are the inconvenient feedbacks that emerge when the two causal networks are joined. By iterating the same procedure to all pair-wise combinations of regime shifts a symmetric directed matrix is obtained that is then used on the statistical analysis.

_Statistical analysis:_ We study what type of micro configurations that better explain the global patterns of the network by applying exponential random graph models[@Hunter:2007bq], and comparing them with a naïve ordinary least squares regression that does not take into account network structure. The response variable for forks is the number of drivers shared, for domino effects is the number of directed pathways that connect two regime shifts, and for inconvenient feedbacks it is the number of k-cycles that emerge on the joined network that do not exist on the separate causal networks. The explanatory variables are modeled as edge covariates derived from the regime shifts categorical variables (N=92). We calculated the similarity of each pair-wise combination of regime shifts in the database regarding categorical attributes such as (i) land use under which the regime shift occur, (ii) ecosystem type, impacts on (iii) ecosystem processes, (iv) provisioning services, (v) regulating services, (vi) cultural services, (vii) human wellbeing; as well as (viii) the spatial scale at which the regime shift occur, (ix) the temporal scales, (x) reversibility, and (xi) evidence type [@Biggs:2015iha; @Rocha:2015du]. For all 92 categorical variables encoded, the database reports presence or absence (0,1) allowing us to calculate the Jaccard index and use it as a proxy of how similar two regime shifts are. To facilitate the interpretation of statistical models, the Jaccard distance was rescaled ($1 - J_{d}$) so equivalent regime shifts score 1 and complete dissimilar zero. Note that the resulting distance matrix for all cases contains values $x_{i,j}$ regardless if the link exist on the networks used as response. For this reason we also fitted naïve OLS models to compare what can be explained by similarity alone, and what is explained by the cascading effects network types (forks, dominos, and inconvenient feedbacks). Note also that these networks contain all valued links of count data, therefore the specification for the exponential random graph models follow Krivitsky [-@Krivitsky:2012uo] and a Poisson reference distribution. All software used is under open access license [@Handcock:2008p5095, @Hunter:2008vh, @Morris:2008ty, @Hunter:2007bq] and run under the R statistical language [@RCoreTeam:2012wf].

```{r Fig2, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 3, fig.width = 5, fig.align = 'center', fig.cap = "Cascading effects. a) Conceptual diagram of the framework proposed. b) Causal loop diagram example for the regime shift on peatlands transitions. Positive links are depicted as blue arrows, negative links as red arrows, drivers are variables outside feedback loops (in yellow), while variables inside feedbacks are grey. Both links and vertices are scaled according to the number of feedback loops that where they are involved", dev.args = list(pointsize = 9)}

library(png)
logo <- readPNG('~/Documents/Projects/Cascading Effects/Domino/Cascading_framework.png')
library(jpeg)
bifurcation <- readJPEG("~/Documents/JUAN/PhD-SRC/Draft papers/Thesis/bifurcation.jpg" )


# op <- par()
# quartz(width = 7, height = 7, pointsize =9 )
# set layout
layout(matrix(c(1,2,2),1,3, byrow = T))
par(mar = c(0,1,1,0))
# Insert png for the framework
plot(c(0,452), c(0,868), asp = 1, type = 'n', xlab = "", ylab= "", xpd = T, axes = FALSE) # numbers come from pixels
rasterImage(logo, 0, 0, 452, 868 , interpolate = T)
title('a)', adj = 0, cex=3)

# plot(c(0,2573), c(0,2942), asp = 1, type = 'n', xlab = "", ylab= "", xpd = T, axes = FALSE) # numbers come from pixels
# rasterImage(bifurcation,0, 0, 2573, 2942 , interpolate = T )
# title('b)', adj = 0, cex=1)


plotnet(rs.net(dat = dat, 19))
title ('b)', adj = 0, cex = 3)

#set old par
# par(op)

```

## Results

```{r Fig3, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 5, fig.width = 5, dev.args = list(pointsize= 5), fig.align='center', fig.cap = 'Bipartite network of sharing drivers shows fork type of cascading effects. Updated version from Rocha et al (2015) with 30 regime shifts.'}


# df1 <- tidy(fit1); df1$model <- 'OLS'
# df2 <- tidy(fit.null1); df2$model <- 'ergm null'
# df3 <- tidy(fit.w1); df3$model <- 'ergm weighted'
# df3$term[3:13] <-  df1$term[2:12]
#
# df <- full_join(df1, df2) %>% full_join(df3)
# df <- mutate(df, conf.hi = estimate + std.error, conf.low = estimate - std.error)
# df$P <- ifelse(df$p.value <= 0.05, "< 0.05", "> 0.05")
# df$term <- as.factor(df$term)
#
# ## change names of places and reorder levels
# df$term <- factor(df$term, levels(df$term)[c(1,8,13,7,4,3,9,10,2,6,12,14,11,5)])
# levels(df$term) <- c("Intercept","Non zero",'Sum', "Landuse","Ecosystem type", "Ecosystem processes", "Provisioning services","Regulating services", "Cultural services", "Human wellbeing", "Spatial scale", "Temporal scale", "Reversibility", "Evidence type")
# df$term <- factor(df$term, rev(levels(df$term)))
#
# df$model <- as.factor(df$model)
# df$model <- factor(df$model, levels(df$model)[c(3,1,2)])
#
# ## plot results
# p <- ggplot(df, aes(estimate, term))+
#     geom_point(aes(shape = factor(P)), show.legend = T) +
#     scale_shape(name = "p value") +
#     geom_errorbarh(aes(xmax = conf.hi, xmin = conf.low, height = .1), show.legend = T) +
#     geom_vline(xintercept = 0, color = 'grey', show.legend = F, linetype = 2) +
#     facet_wrap(~model, scales = "free_x")
# p




## Setting the bipartite network
# library(bipartite)
# N <- nestedness(bipmat, null.models=TRUE, n.nulls=100)
# nest <- nestedrank(bipmat, method="binmatnest", normalise=T, return.matrix=F)
#
# network.layout.nest <- function (d, layout.par){
# 	y <- c(nest[[1]],nest[[2]])* -20
# 	x <- c(rep(0,dim(bipmat)[1]), rep(3,dim(bipmat)[2]))
# 	cbind(x,y) # q <- t(rbind(x,y))
# }
#
# y <- c(nest[[1]],nest[[2]])* -20
# x <- c(rep(0,dim(bipmat)[1]), rep(3,dim(bipmat)[2]))



# bip_attr <- read.csv2('~/Documents/Projects/Cascading Effects/bip_attributes.csv')
#
# colors <- c( "#0000EE" ,"#FFB90F", "#EE3B3B", "#8A2BE2", "#FF7F00", "#9ACD32")

# bip1 %v% 'attr' <- as.vector(bip_attr$attribute)
# bip1 %v% 'col' <- colors[factor(bip_attr$attribute)]

# op <- par()

# par(mar=c(1,1,1,1)) #, xaxs = 'i', yaxs = 'i'
# # Plotting the bipartite network
# # plot.new(asp = 1,  xlim = c(5,-2), ylim = c(2,-22), type = 'n')
# plot.network(bip1, edge.lwd=0.01, usecurve=F, edge.curve= -0.01,
#     vertex.cex= degbip*0.05 + 0.1, displayisolates=F, interactive=F,
#     mode="nest", jitter=F,  vertex.lty=1, vertex.border = 'white',
#     edge.col = "gray84", suppress.axes = T, ylim = c(-22, 2),
#     vertex.col = bip1 %v% 'col')
# #labels for drivers
# text(x,y,c(network.vertex.names(bip1)[1:dim(bipmat)[1]],rep(' ',dim(bipmat)[2])), pos=2, col='grey12', cex = 0.5)
# #labels for RS
# text(x,y,c(rep(" ", dim(bipmat)[1]),network.vertex.names(bip1)[(1 + dim(bipmat)[1]): network.size(bip1)]), pos=4, col='grey12', cex = 0.5)
# # title("b", adj = 0, cex = 0.7)


### Alternative visualiztion with circlesize
## J170323: There is errors with this alternative in the way colours are plotted. It's nicer to the eye but it's using the edge list instead of the network object and the colouring of drivers get messed up. To correct on final version.
library(circlize)

# quartz(width=7, height =4, family = 'Helvetica', pointsize = 6)
# par(mfrow = c(1,2)) # layout(matrix(1:12,4,3, byrow=T))
# plot.new()
# # grid.newpage() # I need this line to plot on quartz, but not on markdown pdf.
# pushViewport(viewport(layout = grid.layout(1,2)))

## First plot the network
# pushViewport(viewport(layout.pos.row=1, layout.pos.col=1))
# par(fig = gridFIG(), new = TRUE)

circos.par(gap.degree = c(rep(2, length(unique(bip.edgelist[[1]]))-1), 30,
                          rep(2, length(unique(bip.edgelist[[2]]))-1), 30),
            start.degree = 15)

chordDiagram(bip.edgelist, annotationTrack = "grid", preAllocateTracks = list(track.height = 0.3), grid.col = bip1 %v% 'col')
#
## from tutorial
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
    xlim = get.cell.meta.data("xlim")
    xplot = get.cell.meta.data("xplot")
    ylim = get.cell.meta.data("ylim")
    sector.name = get.cell.meta.data("sector.index")
    #if(abs(xplot[2] - xplot[1]) < 20) {
        circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise",
        niceFacing = TRUE, adj = c(0, 0.5), cex = .8)#}
    # else {circos.text(mean(xlim), ylim[1], sector.name, facing = "inside",
    #     niceFacing = TRUE, adj = c(0.5, 0), cex = .8)
    # }
}
, bg.border = NA)
circos.clear()
detach(package:circlize)

### Add legends.
legend("topright", legend = c("Aquatic", "Terrestrial", "Subcontinental"),
        fill = c("#0000EE","#9ACD32", "#FF7F00"), border = FALSE,
        title = 'Regime shift type', bty = 'n')
legend("bottomleft", legend = c("International", "Regional", "Local"),
        fill = c("#FFB90F","#EE3B3B", "#8A2BE2"), border = FALSE,
        title = 'Drivers scale of\n management', bty = 'n')
# pushViewport(viewport(layout.pos.row=2, layout.pos.col=3))
# print(g3, newpage = F)

```

A preliminary exploration of _fork_ type of connections was introduced by Rocha _et al._ [-@Rocha:2015du] when asking the question of what are the main drivers of regime shifts globally. While their focus was on drivers importance, here we updated their analysis to `r length(levels(dat$Regime.Shift))` regime shifts and focus on what aspects increase the likelihood of two regime shifts sharing the same drivers (forks). Figure 3 presents the bipartite network composed by `r dim(bipmat)[1]` drivers and `r dim(bipmat)[2]` regime shifts. Regime shifts in this network are more likely to share drivers when they occur on similar ecosystem types and impact similar regulating services (p << 0.001, SM Tables 1,2). The odds of two regime shifts sharing drivers is $exp(-1.024) = 0.35$, while the odds of them sharing the same ecosystem type is $exp(-0.582) = 0.55$ times higher. This likelihood is also affected by occurring on similar land use, impacting similar cultural services and aspects of human wellbeing, occurring at similar spatial scales (but not temporal ones), as well as having similar types of evidence and reversibility (p < 0.05, SM Table 2). Interestingly, while the likelihood of having a non-zero link is significant, the number of drivers shared is not. The negative coefficient on the `non-zero` term indicates zero inflation, this is that most of the interaction occur through the link weights as opposed to the number of links, confirming previous results [@Rocha:2015du] for clustering coefficient and co-occurrence index on the bipartite network. The naïve OLS approach render slightly similar results, while reversibility, provisional and regulating services are not significant, similarity on temporal scales is correlated to number of drivers shared. Yet, the amount of variance explained by the OLS model is relatively low (adjusted $R^2$ ~ 0.3), while the AIC and BIC for the model that consider network structure and regime shifts attributes is much better than the null model with network structure alone (SM Table 2).

Domino effects were investigated by searching variables that belong to feedback mechanisms in one regime shift and at the same time can be drivers of another (Fig 4, see a worked example in SM Fig 2). While most of pair-wise combinations of regime shifts do not have pathways that can result on domino effects, the maximum number of pathways found was $4$. The regime shifts that contain variables that will in turn be drivers of other regime shifts typically have large spatial scales and slow temporal scales: thermohaline circulation collapse, river channel change, monsoon weakening, and Greenland ice sheet collapse. On the other hand, regime shifts that receive the influence are often marine and their time and space dynamics contained more locally: kelps transitions, marine eutrophication, mangroves transitions, coral transitions and fisheries collapse. The statistical models confirm this observation. Both, having a link and having a high number of pathways are significant. The odds of having higher numbers of domino effects are increased when regime shifts impact similar regulating services and similar aspects of human well being (p < 0.001). The OLS approach pick up weak signals for ecosystem type and reversibility (p > 0.01) but without the network structure the power of the OLS model is low (adjusted $R^2= 0.018$). The exponential random graph models that consider both network structure and regime shifts attributes is much better than the null model with network structure alone (SM Table 3).

```{r Fig4, include = TRUE, results = 'hide', cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 3, fig.width = 7, dev.args = list(pointsize= 6), fig.align='center', fig.cap = 'Domino effects.'}


## Heatmap with ggplot
g <- ggplot(data = out, aes( Head, Tail)) +
    geom_tile(aes(fill = weight)) + ylab("Independent regime shift") + xlab("Dependent regime shift") + theme_minimal(base_size=6)

g <- g + scale_fill_gradient2(low = "#FFA50080", mid = "gray84" ,high = "#0000FF80", midpoint = 0, na.value = "grey50")+ theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5 ))

## heatmap with heatmaply

# x <- out %>% select(Head, Tail, weight) %>%
#     spread(Tail, value = weight) %>%
#     select(-1) %>%
#     as.matrix()
# rownames(x) <- colnames(x)
#
# library(heatmaply)
# heatmaply(x, alpha = .6,
#     na.value = "grey84",
#     column_text_angle = 90,
#     margins = c(250,250,30,30),
#     xlab = "Receiver",
#     ylab = "Source",
#     main = "Domino effects",
#     )

## heatmap with d3
# library(d3heatmap)
# d3heatmap(x, scale = "none", colors = "Spectral", theme = "dark")

# ## change this figure by a heatmap.
# quartz(pointsize=5)
# plot.network(dom_net,
#     label = network.vertex.names(dom_net),
#     label.cex= 1, label.pos= 5,
#     edge.lwd = .2, #* dom_net %e% 'weight' ,
#     #edge.curve = 0.01, usecurve=F,
#     displayisolates=T, pad=1,
#     vertex.col = alpha('orange', 0.5),
#     edge.col = alpha('grey', 0.5)
#     )
# title('a', adj= 0, cex = 3)


# mutuality(dom_net)
# ## plotting parameters for disciplines
# p <- ggnet2(net = dom_net, size = 3,
#         #size.legend = "Number of papers",
#         #label.size = 2,
#         #mode = 'mds',
#         #node.color = 'orange',
#         node.color = dom_net %v% 'indegree' + 1,
#         node.alpha = 0.3,
#         edge.color = "grey10",
#         edge.alpha = scales::rescale(dom_net %e% "weight", to = c(0.25, 1)),
#         edge.size = scales::rescale(dom_net %e% "weight", to = c(0.25, 1)),
#         arrow.size = 5, arrow.gap = 0.025
#         )
#
# p + scale_fill_gradient("Indegree", high = "red", low = "yellow")
#
# p <- ggnetworkmap(net = dom_net, arrow.size = 0.2,
#     node.group = indegree,
#              ring.group = outdegree, size = 4) +
#   scale_fill_continuous("Indegree", high = "red", low = "yellow") +
#   labs(color = "Outdegree")
#
# p
# p + scale_fill_gradient("Indegree", high = "red", low = "yellow") +
#   labs(color = "Outdegree")

df1 <- tidy(fit2); df1$model <- 'OLS'
df2 <- tidy(fit.null2); df2$model <- 'ergm null'
df3 <- tidy(fit.w2); df3$model <- 'ergm weighted'
df3$term[3:13] <-  df1$term[2:12]

df <- full_join(df1, df3) # %>% full_join(df3)
df <- mutate(df, conf.hi = estimate + std.error, conf.low = estimate - std.error)
df$P <- ifelse(df$p.value <= 0.05, "< 0.05", "> 0.05")
df$term <- as.factor(df$term)

## change names of places and reorder levels
df$term <- factor(df$term, levels(df$term)[c(1,8,13,7,4,3,9,10,2,6,12,14,11,5)])
levels(df$term) <- c("Intercept","Non zero",'Sum', "Landuse","Ecosystem type", "Ecosystem processes", "Provisioning services","Regulating services", "Cultural services", "Human wellbeing", "Spatial scale", "Temporal scale", "Reversibility", "Evidence type")
df$term <- factor(df$term, rev(levels(df$term)))

df$model <- as.factor(df$model)
df$model <- factor(df$model, levels(df$model)[c(3,1,2)])


## plot results
p <- ggplot(df, aes(estimate, term))+
    geom_point(aes(shape = factor(P)), show.legend = T) +
    scale_shape(name = "p value") +
    geom_errorbarh(aes(xmax = conf.hi, xmin = conf.low, height = .1), show.legend = T) +
    geom_vline(xintercept = 0, color = 'grey', show.legend = F, linetype = 2) +
    facet_wrap(~model, scales = "free_x") + theme_grey(base_size = 6)
# p

## Combine the figure
gg <- list (g,p)
source('~/Dropbox/Code/multiplot.R')
layout <- matrix(c(1,2), ncol = 2, nrow = 1, byrow = T)
multiplot(plotlist = gg, layout = layout)

```

In order to identify potential inconvenient feedbacks we merged causal networks and found that most inconvenient feedbacks occur at higher feedback length (Fig 5).  Not all regime shifts are connected by inconvenient feedbacks, but when inconvenient feedbacks do occur they tend to be on the right side of the distribution at longer cycle lengths. Even for small networks, the number of cycles tend to increase exponentially with respect to the increase of links. Although computationally intensive, the search for k-cycles is feasible in our networks given the small size and relative sparse structures. In fact, the maximum cycle length $k$ is bounded by the size of the network. Out of the `r length(out_inc)` coupled networks analysed, the maximum feedback length was `r unlist(lapply(out_inc, network.size) ) %>% max`. The statistical analysis shows that there is a zero inflation on the resulting matrix (fewer links that one would expect by random), but when they do occur, the odds of having multiple feedbacks coupling two regime shifts is `r round(exp(1.99143),2)` times higher. The odds of two regime shifts been connected through inconvenient feedbacks increase if the pair of regime shifts occur in similar land uses, impact similar ecosystem processes, impact similar regulating and cultural services, and if they occur on similar scales in space and time (Fig 5, SM Table 4, p < 0.001).

```{r Fig5, include = TRUE, results = 'hide', cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 3.5, fig.width = 7, dev.args = list(pointsize= 6), fig.align='center', fig.cap = 'Inconvenient feedbacks. Causal networks are depicted as networks for the minimal example of bush encroachment (a) and desertification (b). Drivers are coloured gray, variables inside feedback loops are yellow, positive links are blue and negative red. The size of the node and the width of links are scaled relative to the number of feedback loops that include each node or edge respectively. The histograms on the bottom show the number of feedback loops per feedback length on the original networks; while c) shows both the coupled network for both regime shifts and its histogram with new unidentified feedbacks in red.'}


## Heatmap with ggplot
g <- ggplot(data = df_inc, aes(Tail, Head)) +
    geom_tile(aes(fill = log(inc))) + theme_dark(base_size = 6)

g <- g + scale_fill_gradient(low = "#FFA50080", high = "#0000FF80", na.value = "grey50")+ theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5 )) + xlab('') + ylab('') +
inset(
  grob = ggplotGrob( ggplot(data = df_inc, aes(inc)) + geom_histogram() + xlab('Inconvenient feedbacks') + theme_gray(base_size = 4) ) ,
  xmin = 14, xmax =28 , ymin = 1, ymax = 12)

# ## heatmap with heatmaply
# x <- df_inc %>% select(Head, Tail, inc) %>%
#     spread(Head, value = inc) %>%
#     select(-1) %>%
#     as.matrix()
# rownames(x) <- colnames(x)
#
# library(heatmaply)
# heatmaply(x, alpha = .6,
#     na.value = "grey84",
#     column_text_angle = 90,
#     margins = c(250,250,30,30),
#     xlab = "Receiver",
#     ylab = "Source",
#     main = "Inconvenient feedbacks",
#     )

## plot outliers:
# quartz(width = 10, height = 3.5, pointsize = 12)
# par(mfrow = c(1,3))
#
# plotnet(out_dom[[7]]); title('a', adj = 0)
# plotnet(out_dom[[19]]); title('b', adj = 0)
# plotnet(net.merge(dat,7,19))

# out_graph[[267]]

# network.vertex.names(out_dom[[7]])[network.vertex.names(out_dom[[7]]) %in% network.vertex.names(out_dom[[19]])]

df1 <- tidy(fit3); df1$model <- 'OLS'
# df2 <- tidy(fit.null3); df2$model <- 'ergm null'
df3 <- tidy(fit.w3); df3$model <- 'ergm weighted'
df3$term[3:13] <-  df1$term[2:12]

df <- full_join(df1, df3)# %>% full_join(df3)
df <- mutate(df, conf.hi = estimate + std.error, conf.low = estimate - std.error)
df$P <- ifelse(df$p.value <= 0.05, "< 0.05", "> 0.05")
df$term <- as.factor(df$term)

## change names of places and reorder levels
df$term <- factor(df$term, levels(df$term)[c(1,8,13,7,4,3,9,10,2,6,12,14,11,5)])
levels(df$term) <- c("Intercept","Non zero",'Sum', "Landuse","Ecosystem type", "Ecosystem processes", "Provisioning services","Regulating services", "Cultural services", "Human wellbeing", "Spatial scale", "Temporal scale", "Reversibility", "Evidence type")
df$term <- factor(df$term, rev(levels(df$term)))

df$model <- as.factor(df$model)
df$model <- factor(df$model, levels(df$model)[c(3,1,2)])

z <- bind_rows(out_dat)

z <- gather(z,`Inconvenient`,`Expected`, key = Feedbacks, value = count)
# z$feed.length <- as.numeric(z$feed.length)

p <- ggplot(filter(z, count > 0), aes(x= as.numeric(feed.length), y = count, color = Feedbacks)) +
geom_jitter(aes(alpha = 0.01), show.legend = F) + facet_wrap(~Feedbacks) + xlab('Feedback length')+ theme_grey(base_size = 6)

## plot results
q <- ggplot(df, aes(estimate, term))+
    geom_point(aes(shape = factor(P)), show.legend = T) +
    scale_shape(name = "p value") +
    geom_errorbarh(aes(xmax = conf.hi, xmin = conf.low, height = .1), show.legend = T) +
    geom_vline(xintercept = 0, color = 'grey', show.legend = F, linetype = 2) +
    facet_wrap(~model, scales = "free_x") + theme_grey(base_size = 6)



## Combine the figure
gg <- list (g,p, q)
source('~/Dropbox/Code/multiplot.R')
layout <- matrix(c(1,1,1,2,3,3), ncol = 2, nrow = 3, byrow = F)
multiplot(plotlist = gg, layout = layout)

```
In summary, we have identified structural dependencies that can give rise to cascading effects among different regime shifts. The topological structure of the drivers and feedback mechanisms underlying the occurrence of regime shifts allows us to explore three types of cascading effects. Figure 6 summarizes the results of our exploration by indicating how many of these types are plausible. While regime shifts in cities (sprawling versus dense growth) is not reported to be affected by any cascading effect with the regime shifts in our dataset, other regime shifts such as kelps transitions are often subject to the three types of interconnections. Of particular importance, the weakening of the Indian Monsoon, primary production in the Arctic ocean, seagrass transitions, soil salinization, bivalves collapse and the weakening of the thermohaline circulation are regime shifts that are expected to be involved in many of these couplings, at least at the structural level. This is, without knowledge of how strong these couplings could be or whether feedbacks are strong enough to produce signals that will impact the coupled system.

```{r Fig6, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 4, fig.width = 4.5, dev.args = list(pointsize= 5), fig.align='center', fig.cap = 'Cascading effects. Potential identified connections between regime shifts'}

fork <- as.sociomatrix(x)
domino <- as.sociomatrix(dom_net)
inconvenient <- as.sociomatrix(inc_net)

inconvenient <- cbind(inconvenient, rep(0,29))
inconvenient <- rbind(inconvenient, rep(0,30))

colnames(inconvenient)[30] <- "Sprawling vs compact city"
rownames(inconvenient)[30] <- "Sprawling vs compact city"

inconvenient <- clean.and.order(inconvenient)

all <- as.data.frame(fork + domino + inconvenient)
all$from <- rownames(all)

df_all <- gather(all,  1:30, key = to, value = count)


## Heatmap with ggplot
g <- ggplot(data = df_all, aes(y = from, x = to)) +
    geom_tile(aes(fill = count)) + theme_dark(base_size = 6)

 g + scale_fill_gradient(high = "#FFA50080", low = "#0000FF80", na.value = "grey50")+ theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5 )) + xlab('') + ylab('')

# ## heatmap with heatmaply
# x <- df_inc %>% select(Head, Tail, inc) %>%
#     spread(Head, value = inc) %>%
#     select(-1) %>%
#     as.matrix()
# rownames(x) <- colnames(x)
#
# library(heatmaply)
# heatmaply(x, alpha = .6,
#     na.value = "grey84",
#     column_text_angle = 90,
#     margins = c(250,250,30,30),
#     xlab = "Receiver",
#     ylab = "Source",
#     main = "Inconvenient feedbacks",
#     )

```

## Discussion

This paper aimed to develop a framework for exploring potential cascading effects among critical transitions in social-ecological systems. A graphical approach allows us to treat regime shifts as causal networks composed by feedback mechanisms and drivers reported in the regime shifts database. Regime shifts interactions can occur when sharing drivers (_forks_), or when _domino effects_ or _inconvenient feedbacks_ are strong enough to couple their dynamics. While their dynamic behaviour is outside the scope of this paper, the topological features that would allow coupling are explored here and serve as a conceptual devise for hypothesis exploration and further modeling of this coupled dynamics.

Intuitively, the sharing of drivers is proposed as a potential mechanisms that can correlate regime shifts in space and time, but not necessarily make them interdependent; unless they also share feedback mechanisms. Time correlation is debated given that spatial heterogeneity can break the synchrony induced by the sharing of drivers, meaning that contextual settings matter for such correlations to emerge [@Hughes:2013cv]. Spatial heterogeneity is also attributed as mechanism that can smooth out critical transitions and soften their abruptness [@Martin:2015kl; @Medeiros:2016vf]. Yet, with or without masking mechanism, identifying fork type of connections is useful for designing management strategies that target bundles of drivers instead of well studied variables independently, increasing the chances that managers will avoid several regime shifts under the influence of the same sets of drivers [@Rocha:2015eea; @Rocha:2015du]. For example, management options for drivers such as sedimentation, nutrients leakage, and fishing can reduce the likelihood of regime shifts in coastal brackish lagoons such as eutrophication and hypoxia, as well as coral transitions in adjacent coral reefs.

Examples of cascading effects between regime shifts have been reported in the literature, but here we have developed a framework to explore graphically what type of mechanisms can underly different regime shifts coupling. For example, eutrophication is often reported as a preceding ecosystem state to hypoxia or dead zones in coastal areas [@Diaz:2008p199]. Similarly, hypoxic events have been reported to affect the resilience of coral reefs to warming and other stressors in the tropics [@Altieri:2017bl]. Moisture recycling feedback is an important process reported as a key mechanism on the shift from forest to savanna [@Zemp:2017dr; @Boers:2017ej] or the Indian monsoon [@Donges:2015fv, @Malik:2011bv]; but also has the potential to couple ecosystems beyond the forest that depend on moisture recycling as an important water source. Changes in moisture recycling can affect mountain forest in the Andes [@Clark:2015bj; @MoruetaHolme:2015fy], nutrient cycling in the ocean by affecting sea surface temperature and therefore regime shifts in marine food webs [@Bakun:2010p5340], or exacerbation of dry land related regime shifts [@DebraPCPeters:2004ex]. These examples have in common that a larger scale feedback affects a more localized dynamic in another ecosystem. However, the opposite is also possible, when the accumulation of small-scale process scale up and impact larger scale dynamics. Peters _et al._ [-@Anonymous:2007tc] have already explore under this line of thinking the dynamics of the dust bowl, desertification, or amplification of fire dynamics. More recently it has been reported that increasing frequency of boreal forest fire could be actually strong enough to increase warming in the Arctic [@Young:2016kj; @Kelly:2015iq]. Permafrost thawing across the Arctic peatlands can be a dangerous amplifier of global warming too by release of methane [@Zona:2016hq]. Mangrove forest are expected to store less carbon as their areas shrink and their ability to build peat soils is overwhelmed by sea level rise; however it is unclear whether the effect will be comparable as to impact global carbon budgets and further warming [@Alongi:2014kq].

While this handful of examples represent an emergent literature on regime shifts interactions, the framework here developed allow us to explore more rigorously the type of potential couplings between regime shifts. For our sample of 30 regime shifts reported in the regime shifts database, 435 possible pair-wise combinations exist. Exploring such search space is not a trivial task. Once the mechanisms responsible for one coupling is identified, it still remains to be explored the parameter space under which the coupling is possible. In other words, while the framework identifies plausible connections, modeling efforts and observational studies are imperative to distinguish plausible from probable. While the literature continue to provide examples of potential couplings, our framework allow us to distinguish whether the coupling is expected to be correlation because of sharing drivers, a one-way causation (the _domino effect_), or a two-way interaction (the _inconvenient feedbacks_), providing a useful set of hypotheses for future research.

Our analysis is purely topological, it shows what potential domino effects or feedbacks could exist, but it does not reveals whether the connection is strong enough to couple the dynamic behaviour of systems known to be prone to regime shifts. A further area of research could ask under which conditions are these couplings plausible. While experimentation is rarely an option for testing this large scale ecosystem dynamics, observational studies are of prime importance as well as modeling efforts. Dynamic models of this type of dynamics require careful assumptions about parameter values as well as functional form of the system's equations. Alternatively, generalized modeling is a promising technique that does not require particular assumptions allowing the researcher to reach more general conclusions based on the systems Jacobian [@Gross:2009jr; @Gross:2004uu; @Lade:2013iwa]. Another potential avenue for future research is looking at how transport mechanisms couple far apart ecosystems. One example already mentioned is the moisture recycling feedback and how it can affect the water budget of areas down the '_preceipitationshed_'[@Keys:2012bo]. Another teleconneciton [@Liu:2015go] could be with allocation of resources through international trade, investigating how demand of resources in certain countries can shape the state space of ecosystems from the providing countries.

```{r, Fig7, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 4, fig.width = 7, dev.args = list(pointsize= 5), fig.align='center', fig.cap = 'Inconvenient feedbacks in drylands. Blue bars show feedbacks present on the individual causal network of each regime shifts. Red bars shows the emergent inconvenient feedbacks when two regime shift networks are joined'}

### In analyizing a subset and produce barplos, uncomment the following.
# rs1 <- list()
# rs1 <- apply(rs.net, rs, )
#
# rs1 <- rs.net(rs, 1)
# rs2 <- rs.net(rs, 2)

#
# x <- melt(out_dat[[1]], id.var="feed.length",
#          measure.var= colnames(out_dat[[1]])[c(1:3,5,6)],
#          value.name='value') %>%
#          mutate(feed.length = as.integer(feed.length))
#
# x$variable <- factor(x$variable, levels = rev(levels(x$variable)))
#
# library(forcats)
# g1<-ggplot(filter(x, variable == 'RS1'),
#     aes(x=feed.length, y=value)) +
#     geom_bar( position = 'dodge', stat = 'identity')  + ylab('Number of feedbacks') + xlab('Feedback length') + xlim(0,max(out_graph[[1]]$data[out_graph[[1]]$data$value > 0, ]$feed.length)) + theme_minimal(base_size = 7) + ylim(0,5)
# g2<-ggplot(filter(x, variable == 'RS2'),
#     aes(x=feed.length, y=value)) + geom_bar( position = 'dodge', stat = 'identity')  + ylab('Number of feedbacks') + xlab('Feedback length') + xlim(0,max(out_graph[[1]]$data[out_graph[[1]]$data$value > 0, ]$feed.length)) + theme_minimal(base_size = 7) + ylim(0,5)
# g3 <- ggplot(filter(x,  variable == 'Inconvenient' | variable == 'Expected') ,
#     aes(x=feed.length, y=value)) +
#     geom_bar( position = 'stack', stat = 'identity', aes(fill = fct_rev(variable)))  +
#     ylab('Number of feedbacks') + xlab('Feedback length') + xlim(0,max(out_graph[[1]]$data[out_graph[[1]]$data$value > 0, ]$feed.length)) + theme_minimal(base_size = 7) + ylim(0,5) +
#     scale_fill_manual("New feedbacks",values=c("#E41A1C","#377EB8")) +
#     theme(legend.position=c(0.8,0.8))
#
# g <- list() # list of plots
# indx <- c(87,91,163,107,176,258,106,178,260,416) # the current list is only for drylands based on 'key'
#
# for (i in 2:length(out_dat)){    # works on all RS (i in 2:length(out_dat))  
#     x <- reshape::melt(out_dat[[i]], id.var="feed.length",
#              measure.var= colnames(out_dat[[i]])[c(1:3,5,6)],
#              value.name='value') %>%
#              mutate(feed.length = as.integer(feed.length))
#     x$variable <- factor(x$variable, levels = rev(levels(x$variable)))
#     g[[i-1]] <- ggplot(filter(x,  variable == 'Inconvenient' | variable == 'Expected') , aes(x=feed.length, y=value)) +
#         geom_bar( position = 'stack', stat = 'identity', aes(fill = fct_rev(variable)), show.legend = F)  +
#         ylab('Number of feedbacks') + xlab('Feedback length') +
#         xlim(0,max(out_graph[[i]]$data[out_graph[[i]]$data$value > 0, ]$feed.length)) + theme_minimal(base_size = 4 ) + ylim(0,5) +
#         scale_fill_manual("New feedbacks",values=c("#E41A1C","#377EB8")) +
#         theme(legend.position=c(0.7,0.7)) + ggtitle(out[[i]] %n% 'name')
# }
#

# The graph g3 has the wrong order of bars but haven't been able to correct it. ON the to do list.
# ggplot(filter(x,  variable == 'Inconvenient' | variable == 'Expected') %>% droplevels(),
#     aes(x=feed.length, y=value)) +
#     geom_bar( aes(fill=variable), position = 'stack', stat = 'identity')  + ylab('Number of feedbacks') + xlab('Feedback length') + xlim(0,max(out_graph[[1]]$data[out_graph[[1]]$data$value > 0, ]$feed.length))  + ylim(0,5)

# library(gridBase)
# library(grid)
# library(gridExtra)
#
#
# # quartz(width = 6, height = 4, pointsize = 7)
# par(mfrow = c(2,3)) # layout(matrix(1:12,4,3, byrow=T))
# plot.new()
# # grid.newpage() # I need this line to plot on quartz, but not on markdown pdf.
# pushViewport(viewport(layout = grid.layout(2,3)))
#
# ## First networks
# pushViewport(viewport(layout.pos.row=1, layout.pos.col=1))
# par(fig = gridFIG(), new = TRUE)
# plotnet(rs1)
# popViewport()
# pushViewport(viewport(layout.pos.row=1, layout.pos.col=2))
# par(fig = gridFIG(), new = TRUE)
# plotnet(rs2)
# popViewport()
# pushViewport(viewport(layout.pos.row=1, layout.pos.col=3))
# par(fig = gridFIG(), new = TRUE)
# plotnet(out[[1]])
# popViewport()
#
# ## Then the feedback histograms
# pushViewport(viewport(layout.pos.row=2, layout.pos.col=1))
# print(g1, newpage = F)
# popViewport()
#
# pushViewport(viewport(layout.pos.row=2, layout.pos.col=2))
# print(g2, newpage = F)
# popViewport()
#
# pushViewport(viewport(layout.pos.row=2, layout.pos.col=3))
# print(g3, newpage = F)
# # popViewport()


# source('~/Dropbox/Code/multiplot.R')
# layout <- matrix(1:10, 2,5)
# multiplot(plotlist = g, layout = layout)

```

## Conclusion

Non-linear dynamics are ubiquitous to a large range of social-ecological systems. However, how a regime shift somewhere in the world could affect the occurrence of another regime shift remains an open question and a key frontier of research. Here we have developed a graphical framework to explore potential cascading effects amongst regime shifts. Based on topological features of causal networks three type of connections have been proposed. Potential correlations due to sharing drivers are denominated _forks_. While the spatio-temporal correlation can be masked by heterogeneity or noise, the cluster of sharing drivers serves to design managerial strategies. One-way directional interactions are denoted as _domino effects_ and are common in aquatic regime shifts. Two-way interconnections are denoted _inconveneint feedbacks_ and often . The two later types of cascading effects call for a more holistic approach for modeling and studying regime shifts, acknowledging their potential interdependences.

\pagebreak

## Supplementary material

### OLS models

**Table SM1.** Ordinary least square models

```{r table1, message = FALSE, warning = FALSE, echo = FALSE, results='asis'}

invisible(stargazer::stargazer(fit1, fit2, fit3,
    align = F, header = F,  out.header = T, type = 'latex', digits = 2,
    float = F, no.space = T, single.row = T, font.size = "small",
    title = "Table SM1. Ordinary least square models")
    )

```

### Exponential random graph models

```{r table2, message = FALSE, warning = FALSE, echo = FALSE, results='asis'}

# suppressMessages(stargazer::stargazer(fit.null1, fit.w1,
#     align = F, header = F,  out.header = T, type = 'latex', digits = 2,
#     float = F, no.space = T, single.row = T, font.size = "small",
#     title = "Table SM2. Exponential random graph models for shared drivers (\textit{forks})",
#     covariate.labels = c("Non-zero", "Sum", "Land use", "Ecosystem type", "Ecosystem processes",
#                          "Provising services", "Regulating services", "Cultural services",
#                          "Human wellbeing", "Spatial scale", "Temporal scale", "Reversibility",
#                          "Evidence type"),
#     dep.var.labels = "Forks")
#     )
# 
# suppressMessages(stargazer::stargazer( fit.null2, fit.w2,
#     align = F, header = F,  out.header = T, type = 'latex', digits = 2,
#     float = F, no.space = T, single.row = T, font.size = "small",
#     title = "Table SM3. Exponential random graph models for \textit{domino effects}",
#     covariate.labels = c("Non-zero", "Sum", "Land use", "Ecosystem type", "Ecosystem processes",
#                          "Provising services", "Regulating services", "Cultural services",
#                          "Human wellbeing", "Spatial scale", "Temporal scale", "Reversibility",
#                          "Evidence type"),
#     dep.var.labels = "Domino effects")
#     )
# 
# suppressMessages(stargazer::stargazer(fit.null3, fit.w3,
#     align = F, header = F,  out.header = T, type = 'latex', digits = 2,
#     float = F, no.space = T, single.row = T, font.size = "small",
#     title = "Table SM4. Exponential random graph models for \textit{inconvenient feedbacks}",
#     covariate.labels = c("Non-zero", "Sum", "Land use", "Ecosystem type", "Ecosystem processes",
#                          "Provising services", "Regulating services", "Cultural services",
#                          "Human wellbeing", "Spatial scale", "Temporal scale", "Reversibility",
#                          "Evidence type"),
#     dep.var.labels = "Inconvenient feedbacks")
#     )

```
**Table SM2.** Exponential random graph models for shared drivers (\textit{forks})
\begingroup 
\small 
\begin{tabular}{@{\extracolsep{5pt}}lcc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{2}{c}{\textit{Dependent variable:}} \\ 
\cline{2-3} 
\\[-1.8ex] & \multicolumn{2}{c}{Forks} \\ 
\\[-1.8ex] & (1) & (2)\\ 
\hline \\[-1.8ex] 
 Non-zero & $-$1.86$^{***}$ (0.15) & $-$1.02$^{***}$ (0.18) \\ 
  Sum & 1.05$^{***}$ (0.04) & 0.14 (0.11) \\ 
  Land use &  & 0.32$^{**}$ (0.14) \\ 
  Ecosystem type &  & $-$0.59$^{***}$ (0.10) \\ 
  Ecosystem processes &  & $-$0.15 (0.10) \\ 
  Provising services &  & 0.46$^{***}$ (0.16) \\ 
  Regulating services &  & 1.02$^{***}$ (0.13) \\ 
  Cultural services &  & $-$0.27$^{**}$ (0.10) \\ 
  Human wellbeing &  & 0.33$^{**}$ (0.14) \\ 
  Spatial scale &  & $-$0.19$^{**}$ (0.08) \\ 
  Temporal scale &  & 0.16 (0.10) \\ 
  Reversibility &  & 0.27$^{***}$ (0.09) \\ 
  Evidence type &  & $-$0.41$^{**}$ (0.17) \\ 
 \hline \\[-1.8ex] 
Akaike Inf. Crit. & $-$578.37 & $-$779.70 \\ 
Bayesian Inf. Crit. & $-$570.22 & $-$726.72 \\ 
\hline 
\hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{2}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\ 
\end{tabular} 
\endgroup

**Table SM3.** Exponential random graph models for \textit{domino effects}
\begingroup 
\small 
\begin{tabular}{@{\extracolsep{5pt}}lcc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{2}{c}{\textit{Dependent variable:}} \\ 
\cline{2-3} 
\\[-1.8ex] & \multicolumn{2}{c}{Domino effects} \\ 
\\[-1.8ex] & (1) & (2)\\ 
\hline \\[-1.8ex] 
 Non-zero & $-$1.63$^{***}$ (0.16) & 3.20$^{***}$ (0.36) \\ 
  Sum & $-$0.05 (0.09) & $-$6.66$^{***}$ (0.44) \\ 
  Land use &  & 0.49 (0.51) \\ 
  Ecosystem type &  & 0.26 (0.30) \\ 
  Ecosystem processes &  & 1.15$^{***}$ (0.35) \\ 
  Provising services &  & 1.65$^{***}$ (0.58) \\ 
  Regulating services &  & 2.56$^{***}$ (0.43) \\ 
  Cultural services &  & $-$0.25 (0.26) \\ 
  Human wellbeing &  & 1.38$^{***}$ (0.40) \\ 
  Spatial scale &  & $-$0.04 (0.24) \\ 
  Temporal scale &  & 0.58$^{**}$ (0.29) \\ 
  Reversibility &  & 0.84$^{***}$ (0.28) \\ 
  Evidence type &  & 0.78$^{*}$ (0.40) \\ 
 \hline \\[-1.8ex] 
Akaike Inf. Crit. & $-$556.68 & $-$1,320.93 \\ 
Bayesian Inf. Crit. & $-$547.15 & $-$1,258.94 \\ 
\hline 
\hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{2}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\ 
\end{tabular} 
\endgroup

**Table SM4.** Exponential random graph models for \textit{inconvenient feedbacks}
\begingroup 
\small 
\begin{tabular}{@{\extracolsep{5pt}}lcc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & \multicolumn{2}{c}{\textit{Dependent variable:}} \\ 
\cline{2-3} 
\\[-1.8ex] & \multicolumn{2}{c}{Inconvenient feedbacks} \\ 
\\[-1.8ex] & (1) & (2)\\ 
\hline \\[-1.8ex] 
 Non-zero & $-$16.56$^{***}$ (0.34) & $-$9.56$^{***}$ (0.42) \\ 
  Sum & 2.76$^{***}$ (0.02) & 1.99$^{***}$ (0.06) \\ 
  Land use &  & $-$0.30$^{***}$ (0.08) \\ 
  Ecosystem type &  & 0.07 (0.07) \\ 
  Ecosystem processes &  & $-$0.58$^{***}$ (0.07) \\ 
  Provising services &  & 0.23$^{**}$ (0.10) \\ 
  Regulating services &  & 0.92$^{***}$ (0.08) \\ 
  Cultural services &  & $-$0.39$^{***}$ (0.07) \\ 
  Human wellbeing &  & 0.04 (0.09) \\ 
  Spatial scale &  & 0.42$^{***}$ (0.06) \\ 
  Temporal scale &  & 0.42$^{***}$ (0.07) \\ 
  Reversibility &  & 0.26$^{***}$ (0.06) \\ 
  Evidence type &  & $-$0.28$^{***}$ (0.10) \\ 
 \hline \\[-1.8ex] 
Akaike Inf. Crit. & $-$7,922.18 & $-$8,714.67 \\ 
Bayesian Inf. Crit. & $-$7,914.16 & $-$8,662.59 \\ 
\hline 
\hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{2}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\ 
\end{tabular} 
\endgroup 


### Causal loop diagram networks

```{r supp1, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 10, fig.width = 10, dev.args = list(pointsize= 10), fig.align='center', fig.cap = 'Supplementary figure 1. Causal netoworks for all regime shifts'}

## Updated ploting function
plotnet <- function(net, ...){
	plot.network(net, #mode='circle',
			vertex.col = net %v% 'col', # alpha(net %v% 'col', 0.7),
			# label = network.vertex.names(net),
			# label.cex= .5,
			main = net %n% 'name', col.main = "grey11", cex.main = 1,
			vertex.border = 0,
			usecurve=T,
			vertex.cex= 2, #2 + scale(net %v% 'fb'),
			# label.pos= 5,
			edge.col= net %e% 'col', #alpha(net %e% 'col' , 0.9),  
			edge.lwd =  0.01, #0.05 + net %e% 'fb',
			edge.curve = 0.01,
			displayisolates=T, pad = 1
			)
		}

# detach(package:igraph)
library(network); library(sna)
# quartz(pointsize = 7)
par(mfrow = c(6,5))

for (i in 1:length(levels(dat$Regime.Shift)) ){
	net <- rs.net(dat = dat,  i = i)
	plotnet(net)

}
```


### A worked example of domino effects

```{r supp2, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 2, fig.width = 6, dev.args = list(pointsize= 10), fig.align='center', fig.cap = 'Domino effects'}

# quartz(width = 10, height = 3.5, pointsize = 6)
par(mfrow = c(1,3))
# quartz(pointsize = 7)
plotnet(out_dom[[27]]); title('a', adj = 0, cex= 6)
plotnet(out_dom[[14]]); title('b', adj = 0, cex= 6)
plotnet(net.merge(dat, 27,14 )); title ('c', adj = 0, cex =6)

# network.vertex.names(out_dom[[11]])[network.vertex.names(out_dom[[11]]) %in% network.vertex.names(out_dom[[5]])]
```


