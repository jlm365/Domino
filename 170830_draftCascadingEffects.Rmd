---
title: Cascading effects of regime shifts in social-ecological systems

author: Juan C. Rocha, Garry Peterson, Örjan Bodin, Simon Levin
    # affiliation: a,1,2
address:
  - code: a
    address: Stockholm Resilience Centre, Stocholm University, Kräftriket 2B, 10691 Stockholm
  - code: b
    address: Beijer Institute, Swedish Royal Academy of Sciences, Lilla Frescativägen 4A, 104 05 Stockholm

corresponding_author:
  - code: 2
    text: "To whom correspondence should be addressed. E-mail: juan.rocha@su.se"

date: "`r format(Sys.time(), '%B %d, %Y')`"

abstract: |
  Regime shifts in nature and society are likely to occur more often and severe as humans increase they pressure on the world ecosystems. Yet it is largely unknown how these transitions will interact, whether the occurrence of one will increase the likelihood of another, or whether they might simply correlate on distant places. Here we explore three types of potential cascading effects of critical transitions$:$ drivers sharing, domino effects and hidden feedbacks. Regime shifts are reduced to a network drivers and feedback processes underlying their dynamics. This directed signed graphs that allow us to explore drivers co-occurrence. Sharing drivers is likely to increase correlation in time or space among critical transitions but not necessarily interdependence. Domino effects occur when the feedback processes of one regime shifts affect the drivers of another, creating a one way dependency. Hidden feedbacks were identified by mapping circular pathways on coupled networks that have not been previously reported, helping us detect potential two way dependencies. Our results explore plausible interconnections and new feedbacks between regime shifts in social-ecological systems; it helps to scope structural interdependence and hence an avenue for future modelling and empirical testing of regime shifts coupling.

keywords: "regime shifts, cascading effects, tele-connections, networks"

header-includes:
- \usepackage{dcolumn}
- \usepackage{lineno}
- \linenumbers

fontsize: 9pt
csl: nature.csl
bibliography: cascading.bib
lineno: true
documentclass: article
linkcolor: blue
urlcolor: blue
citecolor: blue


output:
  pdf_document:
    toc: no
    keep_tex: true
    latex_engine: pdflatex
    dev: pdf

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list = ls())
set.seed(12345)
library (dplyr)
library (tidyr)
library (network)
library (sna)
library(RColorBrewer)
library(ggplot2)
library(GGally)

# for plotting
library(ggmap)
library(maptools)
library(maps)
library(mapproj)

library(gridBase)
library(grid)
library(gridExtra)


## for cleaning models
library(car)
library(broom)
library(sandwich); library(lmtest)

### ERGMS for Regime Shifts
library(ergm.count)

# setwd('~/Documents/Projects/Cascading Effects/Domino')
# Sys.setenv(RSTUDIO_PANDOC="/Applications/RStudio.app/Contents/MacOS/pandoc")
# rmarkdown::render('170125_draft.Rmd', output_format = 'pdf_document')

  # html_document:
  #   code_folding: hide
  #   dev: pdf
  #   self_contained: yes
  #   toc: yes
  #   toc_float:
  #     collapsed: no
  #     smooth_scroll: no
  # word_document: null

# - \usepackage{lineno}
# - \linenumbers


```


```{r data_ergm, include=FALSE}
# this loads the data, it was cleaned and prepared with script 170329_read_data.R
# and load the ergm models fitted with script 170329_ergms.R

load('~/Documents/Projects/Cascading Effects/170525_ergm_data.RData')


## updated functions ##
## this can be deleted in the future

## Updated ploting function
plotnet <- function(net, ...){
	plot.network(net, #mode='circle',
			vertex.col = alpha(net %v% 'col', 0.7),
			# label = network.vertex.names(net),
			# label.cex= 1,
			main = net %n% 'name', col.main = "gray44", cex.main = 1.2,
			vertex.border = 0,
			usecurve=T,
			vertex.cex= 2, #2 + scale(net %v% 'fb'),
			label.pos= 5,
			edge.col= alpha(net %e% 'col' , 1),
			edge.lwd =  rep(0.01, max(valid.eids(net))), #0.05 + net %e% 'fb',
			edge.curve = 0.01,
			displayisolates=T, pad = 0
			)
}

plotnet2 <- function(net, ...){
	plot.network(net, #mode='circle',
			vertex.col = alpha(net %v% 'col', 0.7),
			# label = network.vertex.names(net),
			# label.cex= 1,
			main = net %n% 'name', col.main = "gray44", cex.main = 1.2,
			vertex.border = 0,
			usecurve=T,
			vertex.cex= 2 + scale(net %v% 'fb'),
			label.pos= 5,
			edge.col= alpha(net %e% 'col' , 1),
			edge.lwd =  0.01 * net %e% 'fb',
			edge.curve = 0.01,
			displayisolates=T, pad = 0 # no need of pad for labels
			)
		}
## A function to create the network, add polarity and cycles / feedbacks as edge attributes
## J161105: Edge attributes are tricky to set because once the network is created the ordering of edges is lost and I cannot find the default order to set the right values. Reading the help of 'loading.attributes' I found that when declared as edgelist one can add attributes directly on the dataframe.
rs.net <- function (dat, i){
	# filter dataset
	dat <- filter(dat, Regime.Shift == levels(dat$Regime.Shift)[i],
	 Polarity == 1 | Polarity == -1)
	#dat <- droplevels(dat)
	# This ordering step is necessary to make sure polarity and other attributes are assigned correctly
	# dat <- dat[order(dat$Tail, partial = dat$Head, decreasing = F),]
	# tab <- table(dat$Tail, dat$Head, dat$Polarity) # tab is an array of tables
		# dimnames(tab) [[3]] "-1"   "-0.5" "0.5"  "1"
		# v <- as.matrix(tab[,,1]*-1) + as.matrix(tab[,,2])
	# build network
		rs.x <- network(select(dat, Tail, Head, Polarity, col), directed = T, ignore.eval=FALSE, matrix.type = 'edgelist')
	# add polarity to edges: Outated, the way I create the network includes already the polarities by using ignore.eval = F. Edge color is also set on the network creation line.
		# rs.x %e% 'polarity' <- dat$Polarity
		# set.edge.value(rs.x, 'polarity', value = as.matrix(v))
		# rs.x %e% 'col' <- ifelse(rs.x %e% "Polarity" == -1, 'red', 'blue')
	# add cycles to nodes and edges.
		fb.sum <- kcycle.census(rs.x, maxlen=network.size(rs.x), mode='digraph',	tabulate.by.vertex=T, cycle.comembership='sum')
		# number of cycles per nodes
		rs.x %v% 'fb' <-  diag(fb.sum$cycle.comemb)
		# number of cycles per edge
		rs.x %e% 'fb' <- as.sociomatrix(rs.x) * fb.sum$cycle.comemb
		#J161106: Note that cycle.comemb is a matrix with comemberships, so two nodes that are not connected in the network can belong to the same cycles. That's why I multiply by the adjacency matrix, to isolate only the edges. cycle.comemb can be used later for discovery of inconvenient feedbacks.
	## add vertex attributes
		rs.x %v% 'col' <- ifelse(colSums(fb.sum$cycle.count)[-1] == 0, "#E41A1C","#8DA0CB") # "#FFD92F"
		rs.x %n% 'name' <- levels(dat$Regime.Shift)[i]
	return(rs.x)
}

```


## Introduction
Regime shifts or critical transitions have been documented on a wide variety of systems from climate, finance, language, neurological diseases, ecosystems and ancient societies [@Sole:2011us; @Scheffer:2009wl]. Over 30 regime shifts in social-ecological systems has been identified [@Biggs:2015iha]; and as human pressures increase on the planet, these transitions might become more acute and frequent than previously thought[@Lewontin:1969vh]. Research on regime shifts is often confined to well defined domains of expertise (e.g. limnology, urbanism, climate science), adopting either an empirical, modelling [@Carpenter2003rsi] or early warnings indicator approach [@Scheffer:2012cta; @Scheffer:2009p4449]. These approaches require a deep knowledge of the structure of the causal network of system or a high quality of spatio-temporal data respectively. These requirements have confined the body of research to the analysis of individual types of regime shifts rather than the potential interactions across systems. Yet, one of the key challenges of sustainability science is analyzing the diverse set of interactions across human-environmental systems [@Liu:2015go]; in other words, how social-ecological regime shifts could interact?.

Regime shifts are large, abrupt and persistent changes in the function and structure of systems [@Scheffer:2003p339; @Scheffer:2001uu]. They present a challenge for ecological management and governance because they are very difficult to predict [@Boettiger:2013bm; @Hastings:2010p5336] and reverse [@Scheffer:2003p339], while having substantial impacts on the availability or ecosystem services that societies rely upon [@Carpenter:2009jr]. A regime is the region of the parameter space where fast state variables (e.g. vegetation density, coral cover) fluctuate, they are also called equilibrium, alternative stable states, basins or domains of attraction. Systems prone to regime shifts have more than one alternative stable states; under similar parameter values they can suddenly shift from one domain to another when critical thresholds are crossed [@MAY:1977p3426; @Holling:1973p6861]. Change in slow variables (e.g. temperature in coral reefs) often shrinks the basin of attraction, making the system more susceptible to shifting when exposed to shock events (e.g. hurricanes) or the action of external drivers [@Scheffer:2012cta].

How different regime shifts might be interconnected is largely unknown and a key frontier of research [@Liu:2015go; @Hughes:2013cv]. Some examples of cascading effects between regime shifts have been reported in the literature but a systematic review is lacking (See summary Table 1). For example, eutrophication is often reported as a preceding ecosystem state to hypoxia or dead zones in coastal areas [@Diaz:2008p199]. Similarly, hypoxic events have been reported to affect the resilience of coral reefs to warming and other stressors in the tropics [@Altieri:2017bl]. Moisture recycling is a key underlying feedback on the shift from forest to savanna [@Zemp:2017dr; @Boers:2017ej; @Khanna:2017br] or the Indian monsoon [@Donges:2015fv, @Malik:2011bv]; but also has the potential to couple ecosystems beyond the forest that depend on moisture recycling as an important water source. Changes in moisture recycling can affect mountain forest in the Andes [@Clark:2015bj; @MoruetaHolme:2015fy], nutrient cycling in the ocean by affecting sea surface temperature and therefore regime shifts in marine food webs [@Bakun:2010p5340], or exacerbation of dry land related regime shifts [@DebraPCPeters:2004ex]. The increasing frequency of boreal forest fire could be actually strong enough to increase warming in the Arctic [@Young:2016kj; @Kelly:2015iq] potentially exacerbating Arctic sea ice loss. By the same token, Arctic sea ice loss can have important impacts on the weakening of the thermohaline circulation and in the long term further exacerbating warming [@Sevellec:2017fk]. Permafrost thawing across the Arctic peatlands can be a dangerous amplifier of global warming too by releasing methane [@Zona:2016hq]. Mangrove forest are expected to store less carbon as their areas shrink and their ability to build peat soils is overwhelmed by sea level rise; however it is unclear whether the effect will be comparable as to impact global carbon budgets and further warming [@Alongi:2014kq]. While this growing body of literature already presents some potential cascading effects, a rigorous method for systematically assessing what regime shifts could be interconnected and how is needed.

:Table 1. Summary of proposed cascading effects between regime shifts.

| Regime shift 1 | Regime Shift 2 | Type | Reference |
|:--------------:|:--------------:|:--------------:|:--------------:|
| Marine eutrophication | Hypoxia | Sharing drivers, domino effect | [@Diaz:2008p199] |
| Hypoxia | Coral transitions | Domino effect | [@Altieri:2017bl] |
| Forest to savanna | Mountain forest transitions | Domino effect | [@Clark:2015bj; @MoruetaHolme:2015fy] |
| Forest to savanna | Marine food webs | Domino effect | [@Bakun:2010p5340] |
| Forest to savanna | Dryland degradation | Domino effect | [@DebraPCPeters:2004ex] |
| Coniferous to deciduous boreal forest | Arctic sea ice loss | Hidden feedback | [@Young:2016kj; @Kelly:2015iq] |
| Peatland transitions | Arctic sea ice loss | Hidden feedback | [@Zona:2016hq] |
| Arctic sea ice loss | Thermohaline circulation weakening | Hidden feedback | [@Sevellec:2017fk] |

The aim of this paper is exploring potential interactions amongst regime shifts in social-ecological systems. We propose three types of interconnections: *i)* two regime shifts can sync if they are affected by the same driving forces [@Rocha:2015du]; *ii)* a domino effect is triggered when the occurrence of one regime shift affects the drivers of other regime shift [@Rocha:2010vv; @Hughes:2013cv; @Scheffer:2012cta]; or *iii)* when two regime shifts dynamics generate new (not previously identified) feedback dynamics [@Liu:2015go] by reinforcing or damping each other drivers [@Rocha:2010vv].

## Method summary

The question we are trying to answer: whether regime shifts might be interconnected and how - calls for a method for studying relational data, namely networks. Before outlining the technical details and data used, first we present the hypothesis we test. Then we describe the datasets used and how networks help us identify the three types of interconnections proposed. Last, the statistical analysis tailored to our networks is presented.

What the examples from the literature mentioned above have in common is that a larger scale feedback often affects a more localized dynamic in another ecosystem. However, the opposite is also possible, when the accumulation of small-scale process scale up and impact larger scale dynamics. Peters _et al._ [-@Anonymous:2007tc] explored under this line of thinking the dynamics of the dust bowl, desertification, or amplification of fire dynamics[@Anonymous:2007tc; @DebraPCPeters:2004ex]. Therefore our first hypothesis is that cross-scale dynamics underlie potential cascading effects: we expect that domino effects will be mostly dominated by connections between regime shifts that occur in relatively larger scales and slower dynamics in time towards regime shifts in smaller scales and faster in time. Conversely, we expect that hidden feedbacks will occur when scales match (both in space and time), as well as under similar ecosystem types. We expect that regime shifts occurring in similar ecosystem types or land uses will be subject to relatively similar sets of drivers, increasing the likelihood of drivers sharing. While regime shifts might have similar impacts on ecosystem services and human well being, we do not expect such similarities to be significant aspects increasing the likelihood of sharing drivers, domino effects or hidden feedbacks.

To test these hypotheses we used the [regime shifts database](www.regimeshifts.org), to our knowledge the largest online repository of regime shifts in social-ecological systems (Fig. 1). It offers syntheses of over $30$ generic types of regime shifts, $> 300$ case studies based on literature review of $> 1000$ scientific papers [@Biggs:2015iha]. The database decomposes regime shifts in terms of describing their regimes, drivers, feedback mechanisms, impacts on ecosystem services, and management options. It provides a set of $92$ categorical variables about impacts, scales, and evidence type [@Biggs:2015iha]. When possible, entries to the regime shifts database have been peer reviewed by an expert on the topic to ensure quality and accuracy of its contents [@Biggs:2015iha]. The regime shifts database also offers causal loop diagrams as a summary of the driving processes and underlying feedbacks of regime shifts. Each causal loop diagram was turned into a network by creating the adjacency matrix $A$, where $A_{i,j}$ is $1$ if there is a connection or zero otherwise. Link sign $w_{i,j}$ represent link polarity taking $-1$ if the relationship is expected to be inverse proportional, or $1$ when proportional (See SM). Based on the signed graphs we created three response variables corresponding to each of the cascading effects.

Our hypotheses were tested using as response variable for _drivers sharing_ the number of drivers shared, for _domino effects_ the number of directed pathways that connect two regime shifts, and for _hidden feedbacks_ it is the number of k-cycles that emerge on the joined network that do not exist on the separate causal networks (See SM). Note that all three response variables are matrixes that can be represented as weighted networks in our statistical framework where nodes are regime shifts and the link depends on the cascading effect described. Our research question can be translated then to what is the likelihood of a link between regime shifts in this network, and what features change this likelihood. The explanatory variables (such as scale) are modeled as edge covariates derived from the regime shifts categorical variables ($N=92$, See SM). We focused on how similar two regime shifts are -regarding the categorical variables they share- and how the similarity increases or not the likelihood of having a link, this is, the likelihood of presenting any of the cascading effects types. All these networks contain weighted links of count data, therefore the specification for the exponential random graph models follows Krivitsky [-@Krivitsky:2012uo] and a Poisson reference distribution. All models were fit in the R statistical language [@RCoreTeam:2012wf] using packages for modeling networks with exponential random graph models [@Handcock:2008p5095; @Hunter:2008vh; @Morris:2008ty; @Hunter:2007bq].


:Table 2. Summary of hypothesis tested: What does increase the likelihood of a cascading effect?.

| Cascading effect | Hypothesis | Response variable |
|:--------------:|:--------------:|:--------------:|
| Sharing drivers | Regime shifts are more likely to share drivers if they are subject to similar land uses and occur on similar ecosystem type | Number of drivers shared between regime shifts | 
| Domino effects | Domino effects are more likely to occur between regime shifts with large spatial scale and slow temporal dynamics towards regime shifts in smaller scales and faster in time | Number of pathways from feedback loop in regime shift 1 to driver in regime shift 2 | 
| Hidden feedbacks | Hidden feedbacks are more likely to occur between regime shifts that share scales and ecosystem types | Number of non-previously identified feedbacks (circular pathways) in the joint network of regime shift 1 and regime shift 2 |


```{r Fig1, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 4, fig.width = 6, fig.align = 'center', fig.cap = "Regime shifts around the world. Large points show generic types of regime shifts (n = 35) while small points are case studies (n=324).", dev.args = list(pointsize = 5)}

coords <- read.csv2("~/Documents/Projects/Cascading Effects/Domino/case_coords.csv", dec = '.')

coord_rs <- read.csv(file = '~/Documents/Projects/Cascading Effects/Domino/rs_coords.csv', dec = '.')
cases <- cbind(cases, coords)
rs <- cbind(rs, coord_rs)
rs$rs <- as.factor(rs$rs)
cases$Type.of.regime.shift <- as.factor(cases$Type.of.regime.shift)
names(cases)[7] <- 'rs'

# correction on RS names for plotting
levels(rs$rs) [17] <- "Marine food webs"
levels(rs$rs) [28] <- "Thermokarst lakes"
levels(cases$rs)[17] <- "Fisheries collapse"
levels(cases$rs)[c(5,22)] <- "Marine food webs"
levels(cases$rs)[c(2,9,12,17,20)] <- "Other"


world <- map_data('world')
world <- fortify(world)

m <- ggplot(world, aes(long, lat)) +
    geom_polygon(fill="grey90", aes(group = group)) +
    geom_path(color="white",aes(group=group), size = 0.2) +
    coord_equal() + theme_void(base_size = 7, base_family = "Helvetica")

m + geom_point(data = cases, aes(lon, lat, color = rs), size = 0.2, show.legend = F) +
    geom_point(data = rs, aes(lon,lat, color = rs), size = 2, show.legend = T ) +
    theme(legend.position = "bottom", legend.text = element_text(size = 4)) +
    scale_color_discrete(guide = guide_legend(title = "Regime shifts documented on the regime shifts database \n Source: www.regimeshifts.org", title.position = 'top', title.hjust = 0.5))

# png(file="rsdb_map.png", width=1280, height = 768, units = "px")
# dev.off()
# quartz.save("rsdb_map.png", width= 12, height=7, pointsize = 10, dpi = 800, bg = "white")

```



```{r Fig2, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 4, fig.width = 5, fig.align = 'center', fig.cap = "Minimal examples of the cascading effects framework. a) Sharing drivers: Causal loop diagram examples for the regime shift on the thermohaline circulation and tundra to forest. Positive links are depicted as blue arrows, negative links as orange arrows, drivers are variables outside feedback loops (in red), while variables inside feedbacks are grey. While thermohaline circulation has one driver, tundra to forest has three. The bipartite network (right) depicts drivers (red nodes) shared by these two regime shifts (blue nodes), the only driver shared by both is green house gas emissions. b) Domino effects: Four variables are part of feedback processes in the causal loop diagram of thermohaline circulation that are in turn drivers of kelps transitions. Domino effects create directional dependencies between regime shifts. c) Hidden feedbacks: Both causal loop diagrams in b) are merged into a network where both links and node sizes are scaled according to the number of feedback loops where they are involved. The histogram on the right shows the number of feedbacks per feedback length. Hidden feedbacks are feedbacks that emerge when joining the networks that did not exist on the individual regime shift networks, in this example two hidden feedbacks exist of length 5.", dev.args = list(pointsize = 5)}

# library(png)
# logo <- readPNG('~/Documents/Projects/Cascading Effects/Domino/Cascading_framework.png')
# library(jpeg)
# bifurcation <- readJPEG("~/Documents/JUAN/PhD-SRC/Draft papers/Thesis/bifurcation.jpg" )

# load mini data
mini_dat <- read_csv2("~/Documents/Projects/Cascading Effects/minimal_example_cld_cascading_effects.csv")

# mini_dat %>% filter (Regime.Shift == 'rs1') %>%
#     select(tail, head, color) %>%
#     # network(directed = T, ignore.eval=FALSE, matrix.type = 'edgelist') %>%
#     # ggnet2(edge.color = "color", arrow.size = 1) # no curved edges, I need them
#     igraph::graph_from_data_frame(directed = TRUE) %>%
#     igraph::plot.igraph(edge.curved = c(0,0,0.5,0.5), 
#         vertex.color = alpha(c(rep("red", 2), rep("purple",2)), 0.7 ),
#         vertex.frame.color = NA, vertex.label.color = "grey84", 
#         layout = matrix(c(rep(0,4), 4,1,3,2), ncol = 2, nrow = 4),
#         main = "regime shift 1")


# quartz(width = 6, height = 4, pointsize = 7)
par(mfrow = c(3,4), mar = c(1,1,1,1)) # layout(matrix(1:12,4,3, byrow=T))
plot.new()
# grid.newpage() # I need this line to plot on quartz, but not on markdown pdf.
pushViewport(viewport(layout = grid.layout(3,4)))

## first row 2 clds
pushViewport(viewport(layout.pos.row=1, layout.pos.col=1))
par(fig = gridFIG(), new = TRUE)
mini_dat %>% filter (Regime.Shift == 'rs1') %>%
    select(tail, head, color) %>%
    # network(directed = T, ignore.eval=FALSE, matrix.type = 'edgelist') %>%
    # ggnet2(edge.color = "color", arrow.size = 1) # no curved edges, I need them
    igraph::graph_from_data_frame(directed = TRUE) %>%
    igraph::plot.igraph(edge.curved = c(0,0,0.5,0.5), 
        vertex.color = alpha(c(rep("red", 2), rep("purple",2)), 0.7 ),
        vertex.frame.color = NA, vertex.label.color = "grey84", 
        layout = matrix(c(rep(1,4), 4,1,3,2), ncol = 2, nrow = 4),
        main = "regime shift 1")
title('a)', adj = 0, cex=5)
popViewport()

pushViewport(viewport(layout.pos.row=1, layout.pos.col=2))
par(fig = gridFIG(), new = TRUE)
mini_dat %>% filter (Regime.Shift == 'rs2') %>%
    select(tail, head, color) %>%
    igraph::graph_from_data_frame(directed = TRUE) %>%
    igraph::plot.igraph(edge.curved = c(0,0.5,0.5), 
        vertex.color = alpha(c(rep("red", 1), rep("purple",2)), 0.7 ),
        vertex.frame.color = NA, vertex.label.color = "grey84", 
        layout = matrix(c(rep(1,3), 3,2,1), ncol = 2, nrow = 3),
        main = "regime shift 2")
popViewport()


pushViewport(viewport(layout.pos.row=1, layout.pos.col=3))
par(fig = gridFIG(), new = TRUE)
mini_dat %>% filter (RS_joined == 'rs1_2') %>%
    select(tail, Regime.Shift) %>%
    # network(directed = T, ignore.eval=FALSE, matrix.type = 'edgelist') %>%
    # ggnet2(edge.color = "color", arrow.size = 1) # no curved edges, I need them
    igraph::graph_from_data_frame(directed = TRUE) %>%
    igraph::plot.igraph(edge.curved = FALSE, vertex.shape = c("circle", "circle", "square", "square"),
        vertex.color = alpha(c(rep("red", 2), rep("blue",2)), 0.7 ), vertex.size = 18,
        vertex.frame.color = NA, vertex.label.color = "grey84", 
        layout = matrix(c(1,1,2,2, 2,1,2,1), ncol = 2, nrow = 4) ,
        main = "joint regime shifts")
popViewport()


m1 <- ggplot(
    data = as.sociomatrix(x, "paths") %>% as_tibble() %>% mutate(tail = rownames(as.sociomatrix(x))) %>%
        gather(key = head, value = paths,  1:30),
    aes(tail, head)) + 
    geom_raster(aes(fill = paths)) + ylab("") + xlab("") + 
    scale_fill_gradient2(low = "#FFA50080", mid = "gray84" ,high = "#0000FF80", midpoint = 0, na.value = "grey50") +
    theme_light (base_size=6) +
    theme(axis.text.x = element_blank(), axis.text.y = element_blank()) 

pushViewport(viewport(layout.pos.row=1, layout.pos.col=4))
par(fig = gridFIG(), new = TRUE)
print(m1, newpage = FALSE)
popViewport()

## second panel
pushViewport(viewport(layout.pos.row=2, layout.pos.col=1))
par(fig = gridFIG(), new = TRUE)
mini_dat %>% filter (Regime.Shift == 'rs3') %>%
    select(tail, head) %>%
    igraph::graph_from_data_frame(directed = TRUE) %>%
    igraph::plot.igraph(edge.curved = FALSE,
        vertex.color = alpha(c("red", rep("purple",3), "red"), 0.7 ), vertex.size = 15,
        vertex.frame.color = NA, vertex.label.color = "grey84", 
        #layout = matrix(c(1,1,0.5,1,1, 4,3,2.5,2,1), ncol = 2, nrow = 5) ,
        main = "regime shift 1")
title ('b)', adj = 0, cex = 5)
popViewport()

pushViewport(viewport(layout.pos.row=2, layout.pos.col=2))
par(fig = gridFIG(), new = TRUE)
mini_dat %>% filter (Regime.Shift == 'rs4') %>%
    select(tail, head) %>%
    igraph::graph_from_data_frame(directed = TRUE) %>%
    igraph::plot.igraph(edge.curved = FALSE,
        vertex.color = alpha(c("red", rep("purple",4)), 0.7 ), vertex.size = 15,
        vertex.frame.color = NA, vertex.label.color = "grey84", 
        #layout = matrix(c(0,0,-1,0,1, 3,2,1,0,1), ncol = 2, nrow = 5) ,
        main = "regime shift 2")
popViewport()

pushViewport(viewport(layout.pos.row=2, layout.pos.col=3))
par(fig = gridFIG(), new = TRUE)
mini_dat %>% filter (RS_joined == 'rs3_4') %>%
    select(tail, head, color) %>%
    igraph::graph_from_data_frame(directed = TRUE) %>%
    igraph::plot.igraph(edge.curved = FALSE,
        vertex.color = alpha(c("red","gray","red", "gray", "red", rep("gray",4)), 0.7 ), vertex.size = 15,
        vertex.frame.color = NA, vertex.label.color = "grey84", 
        #layout = matrix(c(0,0,1,0,0,1,2,3,2,  4,3,2.5,2,1, 2.5, 1, 2.5, 3), ncol = 2, nrow = 9) ,
        main = "joint regime shifts")
popViewport()

m2 <- ggplot(
    data = out, aes( Head, Tail)) +
    geom_raster(aes(fill = weight)) + ylab("") + xlab("") +
    scale_fill_gradient2(low = "#FFA50080", mid = "gray84" ,high = "#0000FF80", midpoint = 0, na.value = "grey50") +
    theme_light(base_size=6) +
    theme(axis.text.x = element_blank(), axis.text.y = element_blank()) 

pushViewport(viewport(layout.pos.row=2, layout.pos.col=4))
par(fig = gridFIG(), new = TRUE)
print(m2, newpage = FALSE)
popViewport()




## third row

pushViewport(viewport(layout.pos.row=3, layout.pos.col=1))
par(fig = gridFIG(), new = TRUE)
mini_dat %>% filter (Regime.Shift == 'rs5') %>%
    select(tail, head) %>%
    igraph::graph_from_data_frame(directed = TRUE) %>%
    igraph::plot.igraph(edge.curved = c(0,0.5,0.5),
        vertex.color = alpha(c("red", rep("purple",2)), 0.7 ), vertex.size = 15,
        vertex.frame.color = NA, vertex.label.color = "grey84", 
        layout = matrix(c(1,1,1, 3,2,1), ncol = 2, nrow = 3) ,
        main = "regime shift 1")
title ('c)', adj = 0, cex = 5)
popViewport()

pushViewport(viewport(layout.pos.row=3, layout.pos.col=2))
par(fig = gridFIG(), new = TRUE)
mini_dat %>% filter (Regime.Shift == 'rs6') %>%
    select(tail, head) %>%
    igraph::graph_from_data_frame(directed = TRUE) %>%
    igraph::plot.igraph(edge.curved = c(0,0.5,0.5),
        vertex.color = alpha(c("red", rep("purple",2)), 0.7 ), vertex.size = 15,
        vertex.frame.color = NA, vertex.label.color = "grey84", 
        layout = matrix(c(1,1,1, 1,2,3), ncol = 2, nrow = 3),
        main = "regime shift 2")
popViewport()

pushViewport(viewport(layout.pos.row=3, layout.pos.col=3))
par(fig = gridFIG(), new = TRUE)
mini_dat %>% filter (RS_joined == 'rs5_6') %>%
    select(tail, head, color) %>%
    igraph::graph_from_data_frame(directed = TRUE) %>%
    igraph::plot.igraph(edge.curved = -0.8,
        vertex.color = alpha(c("red","purple","red", "purple"), 0.7 ), vertex.size = 15,
        vertex.frame.color = NA, vertex.label.color = "grey84", 
        #layout = matrix(c(0,0,1,0,0,1,2,3,2,  4,3,2.5,2,1, 2.5, 1, 2.5, 3), ncol = 2, nrow = 9) ,
        main = "joint regime shifts")
popViewport()

m3 <- ggplot(data = df_inc, aes(Tail, Head)) +
    geom_tile(aes(fill = log(inc))) + ylab("") + xlab("") +
    scale_fill_gradient(low = "#FFA50080", high = "#0000FF80", na.value = "grey50") +
    theme_light(base_size=6) +
    theme(axis.text.x = element_blank(), axis.text.y = element_blank())


pushViewport(viewport(layout.pos.row=3, layout.pos.col=4))
par(mar=c(2,2,2,2))
print(m3, newpage = F)
popViewport()

# quartz.save(file="methods_scheme.png", width=7, height=7, pointsize = 7, dpi = 300)
```



## Results

```{r Fig3, cache = TRUE, echo = FALSE, error=FALSE, results = 'hide', warning=FALSE, message=FALSE, fig.height = 4, fig.width = 8, dev.args = list(pointsize= 3), fig.align='center', fig.cap = 'Bipartite network of sharing drivers shows fork type of cascading effects. Updated version from Rocha et al (2015) with 30 regime shifts. WAIS stands for West Antarctica Ice Sheet collapse, NAO is North Atlantic Oscillation, and GHG is green house gases.'}


df1 <- tidy(fit1); df1$model <- 'OLS'
#df2 <- tidy(fit.null1); df2$model <- 'ergm null'
df3 <- tidy(fit.w1); df3$model <- 'ergm weighted'
df3$term[c(3:9,17,18)] <-  df1$term[c(2:8,11,12)]

df <- full_join(df1, df3) # %>% full_join(df3)
df <- mutate(df, conf.hi = estimate + std.error, conf.low = estimate - std.error)
df$P <- ifelse(df$p.value <= 0.05, "< 0.05", "> 0.05")
df$term <- as.factor(df$term)

# ## change names of places and reorder levels
df$term <- factor(df$term, levels(df$term)[c(1,15,20, 7,4,3,16,17,2,6,19,21,8,9,10:14,18,5)])
# levels(df$term) <- c("Intercept","Non zero",'Sum', "Landuse","Ecosystem type", "Ecosystem processes", "Provisioning services","Regulating services", "Cultural services", "Human wellbeing", "Spatial scale", "Temporal scale", "Reversibility", "Evidence type")
df$term <- factor(df$term, rev(levels(df$term)))

df$model <- as.factor(df$model)
# df$model <- factor(df$model, levels(df$model)[c(3,1,2)])

## plot results
p <- ggplot(df, aes(estimate, term))+
    geom_point(aes(shape = factor(P)), size = 2, show.legend = T) +
    scale_shape_manual(name = "p value", values = c(19,1)) +
    geom_errorbarh(aes(xmax = conf.hi, xmin = conf.low, height = .1),
                   show.legend = T) +
    geom_vline(xintercept = 0, color = 'grey', show.legend = F, linetype = 2)  +
    facet_wrap(~ model, scales = "free_x") + theme_light(base_size = 6) +
    theme(legend.position = "bottom")

## Setting the bipartite network
# library(bipartite)
# N <- nestedness(bipmat, null.models=TRUE, n.nulls=100)
# nest <- nestedrank(bipmat, method="binmatnest", normalise=T, return.matrix=F)
#
# network.layout.nest <- function (d, layout.par){
# 	y <- c(nest[[1]],nest[[2]])* -20
# 	x <- c(rep(0,dim(bipmat)[1]), rep(3,dim(bipmat)[2]))
# 	cbind(x,y) # q <- t(rbind(x,y))
# }
#
# y <- c(nest[[1]],nest[[2]])* -20
# x <- c(rep(0,dim(bipmat)[1]), rep(3,dim(bipmat)[2]))



# bip_attr <- read.csv2('~/Documents/Projects/Cascading Effects/bip_attributes.csv')
#
# colors <- c( "#0000EE" ,"#FFB90F", "#EE3B3B", "#8A2BE2", "#FF7F00", "#9ACD32")

# bip1 %v% 'attr' <- as.vector(bip_attr$attribute)
# bip1 %v% 'col' <- colors[factor(bip_attr$attribute)]

# op <- par()

# par(mar=c(1,1,1,1)) #, xaxs = 'i', yaxs = 'i'
# # Plotting the bipartite network
# # plot.new(asp = 1,  xlim = c(5,-2), ylim = c(2,-22), type = 'n')
# plot.network(bip1, edge.lwd=0.01, usecurve=F, edge.curve= -0.01,
#     vertex.cex= degbip*0.05 + 0.1, displayisolates=F, interactive=F,
#     mode="nest", jitter=F,  vertex.lty=1, vertex.border = 'white',
#     edge.col = "gray84", suppress.axes = T, ylim = c(-22, 2),
#     vertex.col = bip1 %v% 'col')
# #labels for drivers
# text(x,y,c(network.vertex.names(bip1)[1:dim(bipmat)[1]],rep(' ',dim(bipmat)[2])), pos=2, col='grey12', cex = 0.5)
# #labels for RS
# text(x,y,c(rep(" ", dim(bipmat)[1]),network.vertex.names(bip1)[(1 + dim(bipmat)[1]): network.size(bip1)]), pos=4, col='grey12', cex = 0.5)
# # title("b", adj = 0, cex = 0.7)


### Alternative visualiztion with circlesize
## J170323: There is errors with this alternative in the way colours are plotted. It's nicer to the eye but it's using the edge list instead of the network object and the colouring of drivers get messed up. To correct on final version.
library(circlize)

# quartz(width=8, height =4, family = 'Helvetica', pointsize = 6)
par(mfrow = c(1,2)) # layout(matrix(1:12,4,3, byrow=T))
plot.new()
# # grid.newpage() # I need this line to plot on quartz, but not on markdown pdf.
pushViewport(viewport(layout = grid.layout(1,2)))

## First plot the network
pushViewport(viewport(layout.pos.row=1, layout.pos.col=1))
par(fig = gridFIG(), new = TRUE)

circos.par(gap.degree = c(rep(2, length(unique(bip.edgelist[[1]]))-1), 30,
                          rep(2, length(unique(bip.edgelist[[2]]))-1), 30),
            start.degree = 90, clock.wise = F)

chordDiagram(bip.edgelist, annotationTrack = "grid", preAllocateTracks = list(track.height = 0.3), grid.col = bip1 %v% 'col')
#
## from tutorial
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
    xlim = get.cell.meta.data("xlim")
    xplot = get.cell.meta.data("xplot")
    ylim = get.cell.meta.data("ylim")
    sector.name = get.cell.meta.data("sector.index")
    #if(abs(xplot[2] - xplot[1]) < 20) {
        circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise",
        niceFacing = TRUE, adj = c(0, 0.5), cex = .75)#}
    # else {circos.text(mean(xlim), ylim[1], sector.name, facing = "inside",
    #     niceFacing = TRUE, adj = c(0.5, 0), cex = .8)
    # }
}
, bg.border = NA)
circos.clear()
detach(package:circlize)

### Add legends.
legend("bottomright", legend = c("Aquatic", "Terrestrial", "Subcontinental"),
        fill = c("#0000EE","#9ACD32", "#FF7F00"), border = FALSE,
        title = 'Regime shift type', bty = 'n', cex = 0.8)
legend("bottomleft", legend = c("International", "Regional", "Local"),
        fill = c("#FFB90F","#EE3B3B", "#8A2BE2"), border = FALSE,
        title = 'Drivers scale of\n management', bty = 'n', cex = 0.8)
popViewport()


pushViewport(viewport(layout.pos.row=1, layout.pos.col=2))
print(p, newpage = F)
popViewport()
#
# quartz.save("sharing_drivers.png", width = 8.5, height = 4, pointsize = 6, dpi = 300)

```

Drivers sharing were investigated by creating a bipartite graph - a network with two type of nodes (Fig. 2a) - linking drivers nodes to regime shifts nodes if there is a reference in the scientific literature suggesting causality [@Rocha:2015du]. This type of connection is expected to increase the likelihood of synchronization in space and time of different regime shift phenomena [@Hughes:2013cv] (correlations), both in terms of cases (e.g. two different coral reefs) or regime shift types (e.g. thermokrast lakes and peatland transitions both driven by climate change). A preliminary exploration of _drivers sharing_ was introduced by Rocha _et al._ [-@Rocha:2015du] when asking the question of what are the main drivers of regime shifts globally. While their focus was on drivers importance, here we updated their analysis to `r length(levels(dat$Regime.Shift))` regime shifts and focus on what aspects increase the likelihood of two regime shifts sharing the same drivers. Figure 3 presents the bipartite network composed by `r dim(bipmat)[1]` drivers and `r dim(bipmat)[2]` regime shifts. Regime shifts in this network are more likely to share drivers when they occur on similar ecosystem types and impact similar regulating services (p << 0.001, SM Tables 1,2). The odds of two regime shifts sharing drivers is `r round(exp(sum(fit.w1$coef[1])),2)`, while the odds of them sharing drivers given that they occur on similar ecosystem type is `r round(exp(sum(fit.w1$coef[c(1,4)])),2)`. The likelihood of sharing drivers is also affected by occurring on similar land use, impacting similar cultural services and aspects of human wellbeing, occurring at similar spatial scales (but not temporal ones), as well as having similar types of evidence and reversibility (p < 0.05, SM Table 2). Interestingly, while the likelihood of having a non-zero link is significant, the number of drivers shared is not. The negative coefficient on the `non-zero` term indicates zero inflation, this is that most of the interaction occur through the link weights as opposed to the number of links, confirming previous results [@Rocha:2015du] for clustering coefficient and co-occurrence index on the bipartite network. The naïve OLS approach render slightly similar results, while reversibility, provisional and regulating services are not significant, similarity on temporal scales is correlated to number of drivers shared. Yet, the amount of variance explained by the OLS model is relatively low (adjusted $R^2$ ~ 0.3), while the AIC and BIC for the model that consider network structure and regime shifts attributes is much better than the null model with network structure alone (SM Table 2).

Domino effects were investigated by searching variables that belong to feedback mechanisms in one regime shift and at the same time can be drivers of another (Fig 4, see a worked example in Fig 2b). While most of pair-wise combinations of regime shifts do not have pathways that can result on domino effects, the maximum number of pathways found was $4$. In line with our expectations, regime shifts that contain variables that will in turn be drivers of other regime shifts typically have large spatial scales and slow temporal scales: thermohaline circulation collapse, river channel change, monsoon weakening, and Greenland ice sheet collapse. On the other hand, regime shifts that receive the influence are often marine and their time and space dynamics contained more locally: kelps transitions, marine eutrophication, mangroves transitions, coral transitions and fisheries collapse. The statistical models support this observation: regime shifts whose time scale are on the rage of weeks to months are more likely to receive influence from regime shifts whose dynamics occur on the scale of years to decades (p < 0.1), but we did not find evidence for spatial scale (Table SM2). Both, having a link and having a high number of pathways are significant (p < 0.01). Surprisingly, the odds of having higher numbers of domino effects are increased when regime shifts impact similar regulating services and similar aspects of human well being (p < 0.001). The OLS approach pick up weak signals for ecosystem type and reversibility (p > 0.01) but without the network structure the power of the OLS model is low (adjusted $R^2= 0.018$). The exponential random graph model that consider both network structure and regime shifts attributes is much better than the null model with network structure alone (SM Table 3).

```{r Fig4, include = TRUE, results = 'hide', cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 3, fig.width = 7, dev.args = list(pointsize= 6), fig.align='center', fig.cap = 'Domino effects.'}

## Heatmap with ggplot
g <- ggplot(data = out, aes( Head, Tail)) +
    geom_tile(aes(fill = weight)) + ylab("Independent regime shift") + xlab("Dependent regime shift") + theme_light(base_size=6)

g <- g + scale_fill_gradient2(low = "#FFA50080", mid = "gray84" ,high = "#0000FF80", midpoint = 0, na.value = "grey50")+ theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5 ))

## heatmap with heatmaply

# x <- out %>% select(Head, Tail, weight) %>%
#     spread(Tail, value = weight) %>%
#     select(-1) %>%
#     as.matrix()
# rownames(x) <- colnames(x)
#
# library(heatmaply)
# heatmaply(x, alpha = .6,
#     na.value = "grey84",
#     column_text_angle = 90,
#     margins = c(250,250,30,30),
#     xlab = "Receiver",
#     ylab = "Source",
#     main = "Domino effects",
#     )

## heatmap with d3
# library(d3heatmap)
# d3heatmap(x, scale = "none", colors = "Spectral", theme = "dark")

# ## change this figure by a heatmap.
# quartz(pointsize=5)
# plot.network(dom_net,
#     label = network.vertex.names(dom_net),
#     label.cex= 1, label.pos= 5,
#     edge.lwd = .2, #* dom_net %e% 'weight' ,
#     #edge.curve = 0.01, usecurve=F,
#     displayisolates=T, pad=1,
#     vertex.col = alpha('orange', 0.5),
#     edge.col = alpha('grey', 0.5)
#     )
# title('a', adj= 0, cex = 3)


# mutuality(dom_net)
# ## plotting parameters for disciplines
# p <- ggnet2(net = dom_net, size = 3,
#         #size.legend = "Number of papers",
#         #label.size = 2,
#         #mode = 'mds',
#         #node.color = 'orange',
#         node.color = dom_net %v% 'indegree' + 1,
#         node.alpha = 0.3,
#         edge.color = "grey10",
#         edge.alpha = scales::rescale(dom_net %e% "weight", to = c(0.25, 1)),
#         edge.size = scales::rescale(dom_net %e% "weight", to = c(0.25, 1)),
#         arrow.size = 5, arrow.gap = 0.025
#         )
#
# p + scale_fill_gradient("Indegree", high = "red", low = "yellow")
#
# p <- ggnetworkmap(net = dom_net, arrow.size = 0.2,
#     node.group = indegree,
#              ring.group = outdegree, size = 4) +
#   scale_fill_continuous("Indegree", high = "red", low = "yellow") +
#   labs(color = "Outdegree")
#
# p
# p + scale_fill_gradient("Indegree", high = "red", low = "yellow") +
#   labs(color = "Outdegree")

df1 <- tidy(fit2); df1$model <- 'OLS'
df2 <- tidy(fit.null2); df2$model <- 'ergm null'
df3 <- tidy(fit.w2); df3$model <- 'ergm weighted'
df3$term[3:13] <-  df1$term[2:12]

df <- full_join(df1, df3) # %>% full_join(df3)
df <- mutate(df, conf.hi = estimate + std.error, conf.low = estimate - std.error)
df$P <- ifelse(df$p.value <= 0.05, "< 0.05", "> 0.05")
df$term <- as.factor(df$term)

## change names of places and reorder levels
df$term <- factor(df$term, levels(df$term)[c(1,8,13,7,4,3,9,10,2,6,12,14,11,5)])
levels(df$term) <- c("Intercept","Non zero",'Sum', "Landuse","Ecosystem type", "Ecosystem processes", "Provisioning services","Regulating services", "Cultural services", "Human wellbeing", "Spatial scale", "Temporal scale", "Reversibility", "Evidence type")
df$term <- factor(df$term, rev(levels(df$term)))

df$model <- as.factor(df$model)
df$model <- factor(df$model, levels(df$model)[c(3,1,2)])


## plot results
p <- ggplot(df, aes(estimate, term))+
    geom_point(aes(shape = factor(P)), show.legend = T) +
    scale_shape_manual(name = "p value", values = c(19,1)) +
    geom_errorbarh(aes(xmax = conf.hi, xmin = conf.low, height = .1), show.legend = T) +
    geom_vline(xintercept = 0, color = 'grey', show.legend = F, linetype = 2) +
    facet_wrap(~model, scales = "free_x") + theme_light(base_size = 6) +
    theme(legend.position = "bottom")
# p

## Combine the figure
gg <- list (g,p)
source('~/Dropbox/Code/multiplot.R')
layout <- matrix(c(1,2), ncol = 2, nrow = 1, byrow = T)
multiplot(plotlist = gg, layout = layout)


 # quartz.save("domino_effects.png", width = 8.5, height = 4, pointsize = 8, dpi = 300)

```

Hidden feedbacks are feedback loops that might connect two different regime shifts; and if strong enough, it could amplify or dampen the coupled dynamics (Fig 2c). A hidden feedback occurs when the dynamics of one regime shift affects a variable that belongs in turn to another regime shift and vice versa. In order to identify hidden feedbacks we merged causal networks (See SM) and found that most feedbacks occur at higher feedback length (Fig 5). Not all regime shifts are connected by hidden feedbacks, but when new feedbacks do occur they tend to be on the right side of the distribution at longer cycle lengths. Even for small networks, the number of cycles tend to increase exponentially with respect to the increase of links. Although computationally intensive, the search for k-cycles is feasible in our networks given the small size and relative sparse structures. In fact, the maximum cycle length $k$ is bounded by the size of the network. Out of the `r length(out_inc)` coupled networks analysed, the maximum feedback length was `r unlist(lapply(out_inc, network.size) ) %>% max`. The statistical analysis shows that there is a zero inflation on the resulting matrix (fewer links that one would expect by random), but when they do occur, the odds of having multiple feedbacks coupling two regime shifts is `r round(exp(1.99143),2)` times higher. The odds of two regime shifts been connected through hidden feedbacks increase if the pair of regime shifts occur in similar land uses, impact similar ecosystem processes, impact similar regulating and cultural services, and if they occur on similar scales in space and time (Fig 5, SM Table 4, p < 0.001).

```{r Fig5, include = TRUE, results = 'hide', cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 3.5, fig.width = 7, dev.args = list(pointsize= 6), fig.align='center', fig.cap = 'Hidden feedbacks.'}


## Heatmap with ggplot
g <- ggplot(data = df_inc, aes(Tail, Head)) +
    geom_tile(aes(fill = log(inc))) + theme_light(base_size = 6)

g <- g + scale_fill_gradient(low = "#FFA50080", high = "#0000FF80", na.value = "grey50")+ theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5 )) + xlab('') + ylab('') +
inset(
  grob = ggplotGrob( ggplot(data = df_inc, aes(inc)) + geom_histogram() + xlab('Hidden feedbacks') + theme_light(base_size = 4) ) ,
  xmin = 14, xmax =28 , ymin = 1, ymax = 12)

# ## heatmap with heatmaply
# x <- df_inc %>% select(Head, Tail, inc) %>%
#     spread(Head, value = inc) %>%
#     select(-1) %>%
#     as.matrix()
# rownames(x) <- colnames(x)
#
# library(heatmaply)
# heatmaply(x, alpha = .6,
#     na.value = "grey84",
#     column_text_angle = 90,
#     margins = c(250,250,30,30),
#     xlab = "Receiver",
#     ylab = "Source",
#     main = "Inconvenient feedbacks",
#     )

## plot outliers:
# quartz(width = 10, height = 3.5, pointsize = 12)
# par(mfrow = c(1,3))
#
# plotnet(out_dom[[7]]); title('a', adj = 0)
# plotnet(out_dom[[19]]); title('b', adj = 0)
# plotnet(net.merge(dat,7,19))

# out_graph[[267]]

# network.vertex.names(out_dom[[7]])[network.vertex.names(out_dom[[7]]) %in% network.vertex.names(out_dom[[19]])]

df1 <- tidy(fit3); df1$model <- 'OLS'
# df2 <- tidy(fit.null3); df2$model <- 'ergm null'
df3 <- tidy(fit.w3); df3$model <- 'ergm weighted'
df3$term[3:13] <-  df1$term[2:12]

df <- full_join(df1, df3)# %>% full_join(df3)
df <- mutate(df, conf.hi = estimate + std.error, conf.low = estimate - std.error)
df$P <- ifelse(df$p.value <= 0.05, "< 0.05", "> 0.05")
df$term <- as.factor(df$term)

## change names of places and reorder levels
df$term <- factor(df$term, levels(df$term)[c(1,8,13,7,4,3,9,10,2,6,12,14,11,5)])
levels(df$term) <- c("Intercept","Non zero",'Sum', "Landuse","Ecosystem type", "Ecosystem processes", "Provisioning services","Regulating services", "Cultural services", "Human wellbeing", "Spatial scale", "Temporal scale", "Reversibility", "Evidence type")
df$term <- factor(df$term, rev(levels(df$term)))

df$model <- as.factor(df$model)
df$model <- factor(df$model, levels(df$model)[c(3,1,2)])

z <- bind_rows(out_dat)

z <- gather(z,`Inconvenient`,`Expected`, key = Feedbacks, value = count)

z$Feedbacks <- factor(z$Feedbacks)
levels(z$Feedbacks)[2] <- "Hidden"

p <- ggplot(filter(z, count > 0), aes(x= as.numeric(feed.length), y = count, color = Feedbacks)) +
geom_jitter(aes(alpha = 0.01), show.legend = F) + facet_wrap(~Feedbacks) + xlab('Feedback length')+ theme_light(base_size = 6)

## plot results
q <- ggplot(df, aes(estimate, term))+
    geom_point(aes(shape = factor(P)), show.legend = T) +
    scale_shape_manual(name = "p value", values = c(19,1)) +
    geom_errorbarh(aes(xmax = conf.hi, xmin = conf.low, height = .1), show.legend = T) +
    geom_vline(xintercept = 0, color = 'grey', show.legend = F, linetype = 2) +
    facet_wrap(~model, scales = "free_x") + theme_light(base_size = 6) +
    theme(legend.position = "bottom")



## Combine the figure
gg <- list (g,p, q)
source('~/Dropbox/Code/multiplot.R')
layout <- matrix(c(1,1,1,2,3,3), ncol = 2, nrow = 3, byrow = F)
multiplot(plotlist = gg, layout = layout)

 # quartz.save("hidden_feedbacks.png", width = 8.5, height = 4, pointsize = 8, dpi = 300)

```


```{r Fig6, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 4, fig.width = 4.5, dev.args = list(pointsize= 5), fig.align='center', fig.cap = 'Cascading effects. Potential identified connections between regime shifts'}

fork <- as.sociomatrix(x)
domino <- as.sociomatrix(dom_net)
inconvenient <- as.sociomatrix(inc_net)

inconvenient <- cbind(inconvenient, rep(0,29))
inconvenient <- rbind(inconvenient, rep(0,30))

colnames(inconvenient)[30] <- "Sprawling vs compact city"
rownames(inconvenient)[30] <- "Sprawling vs compact city"

inconvenient <- clean.and.order(inconvenient)

all <- as.data.frame(fork + domino + inconvenient)
all$from <- rownames(all)

df_all <- gather(all,  1:30, key = to, value = count)


## Heatmap with ggplot
g <- ggplot(data = df_all, aes(y = from, x = to)) +
    geom_tile(aes(fill = count)) + theme_minimal(base_size = 6)

 g + scale_fill_gradient(high = "#FFA50080", low = "#0000FF80", na.value = "grey50")+ theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5 )) + xlab('') + ylab('')

# ## heatmap with heatmaply
# x <- df_inc %>% select(Head, Tail, inc) %>%
#     spread(Head, value = inc) %>%
#     select(-1) %>%
#     as.matrix()
# rownames(x) <- colnames(x)
#
# library(heatmaply)
# heatmaply(x, alpha = .6,
#     na.value = "grey84",
#     column_text_angle = 90,
#     margins = c(250,250,30,30),
#     xlab = "Receiver",
#     ylab = "Source",
#     main = "Inconvenient feedbacks",
#     )

```

## Discussion

This paper aimed to develop a framework for exploring potential cascading effects among critical transitions in social-ecological systems. A graphical approach allows us to treat regime shifts as causal networks composed by feedback mechanisms and drivers reported in the regime shifts database. Regime shifts interactions can occur when _sharing drivers_, or when _domino effects_ or _hidden feedbacks_ are strong enough to couple their dynamics. While their dynamic behaviour is outside the scope of this paper, the topological features that would allow coupling are explored here and serve as a conceptual devise for hypothesis exploration and further modeling of this coupled dynamics.

In summary, we have identified structural dependencies that can give rise to cascading effects among different regime shifts. We hypothesised that the likelihood of sharing drivers increased when regime shifts occur on similar ecosystem types and land uses. We confirmed this observation and also found that sharing drivers increase when regime shifts occur on the same spatial scales, or when they impact similar regulating services, cultural services, or impact similar aspects of human well being. Based on examples of cascading effects already reported in the literature we hypothesised that domino effects will be more common between regime shifts whose dynamics occur at larger spatial scales and slower dynamics in time towards regime shifts more localized in space and faster in time. We only found support for the cross-scale dynamic in time but not in space. Additionally, regime shifts that often received the domino effect tend to occur in aquatic environments pointing out the importance of water transport as a potential mechanism linking regime shifts in one-way interactions. Last, we hypothesised that hidden feedbacks would appear when scales match both in space and time, as well as under similar ecosystem types. Our results confirm both speculations and also suggest that hidden feedbacks are common when regime shifts occur under the same land use and when they impact similar ecosystem processes, regulating and cultural services. Figure 6 summarizes the results of our exploration by indicating how many of these types are plausible. While regime shifts in cities (sprawling versus dense growth) is not reported to be affected by any cascading effect with the regime shifts in our dataset, other regime shifts such as kelps transitions are often subject to the three types of cascading effects. Of particular importance, the weakening of the Indian Monsoon, primary production in the Arctic ocean, seagrass transitions, soil salinization, bivalves collapse and the weakening of the thermohaline circulation are regime shifts that are expected to be involved in many of these couplings, at least at the structural level.

Intuitively, the sharing of drivers is proposed as a potential mechanisms that can correlate regime shifts in space and time, but not necessarily make them interdependent; unless they also share feedback mechanisms. Time correlation is debated given that spatial heterogeneity can break the synchrony induced by the sharing of drivers [@Hughes:2013cv], meaning that contextual settings matter for such correlations to emerge. Spatial heterogeneity is also attributed as mechanism that can smooth out critical transitions and soften their abruptness [@Martin:2015kl; @Medeiros:2016vf]. Yet, with or without masking mechanism, identifying common drivers is useful for designing management strategies that target bundles of drivers instead of well studied variables independently, increasing the chances that managers will avoid several regime shifts under the influence of the same sets of drivers [@Rocha:2015eea; @Rocha:2015du]. For example, management options for drivers such as sedimentation, nutrients leakage, and fishing can reduce the likelihood of regime shifts in coastal brackish lagoons such as eutrophication and hypoxia, as well as coral transitions in adjacent coral reefs.

Domino effects and hidden feedbacks are often disregarded because research on regime shifts usually focus on one system at the time; data collection and hypothesis testing for coupled systems has largely remained unexplored. In fact, the question of how different regime shifts might be interconnected remains a key frontier of research [@Liu:2015go; @Hughes:2013cv]. Recent literature report potential linkages between euthrophication and hypoxia [@Diaz:2008p199], hypoxia and coral transitions [@Altieri:2017bl], or shifts in coral reefs and mangroves transitions [@Alongi:2014kq]. Other examples in the terrestrial realm report potential increase in Arctic warming from higher fire frequency in boreal forest [@Young:2016kj; @Kelly:2015iq] or permafrost thawing [@Zona:2016hq], potentially impacting any regime shift in the Arctic driven by temperature [@Peterson:2016ul]. Shifts in forest that can reduce moisture recycling has also been reported to potentially impact mountain forest [@Clark:2015bj; @MoruetaHolme:2015fy], drylands [@DebraPCPeters:2004ex], and regime shifts in the ocean affected by nutrients cycling [@Bakun:2010p5340]. While this handful of examples represent an emergent literature on regime shifts interactions, the framework here developed allow us to explore more rigorously the type of potential couplings between regime shifts. For our sample of 30 regime shifts reported in the regime shifts database, 435 possible pair-wise combinations exist. Exploring such search space is not a trivial task. Once the mechanisms responsible for one coupling is identified, it still remains to be explored the parameter space under which the coupling is feasible. In other words, while the framework identifies plausible connections, modeling efforts and observational studies are imperative to distinguish plausible from probable. While the literature continue to provide examples of potential couplings, our results contribute to the ongoing debate by distinguishing whether the coupling is expected to be correlational because of drivers sharing, a one-way causation (the _domino effect_), or a two-way interaction (the _hidden feedbacks_), providing a useful set of hypotheses for future research.

Our analysis is purely topological, it shows what potential domino effects or feedbacks could exist, but it does not reveals whether the connection is strong enough to couple the dynamic behaviour of systems known to be prone to regime shifts. While experimentation is rarely an option for testing this large scale ecosystem dynamics, observational studies are of prime importance as well as modeling efforts. Dynamic models of this type of dynamics require careful assumptions about parameter values as well as functional form of the system's equations. Alternatively, generalized modeling is a promising technique that does not require particular assumptions allowing the researcher to reach more general conclusions based on the systems Jacobian [@Gross:2009jr; @Gross:2004uu; @Lade:2013iwa]. Another potential avenue for future research is looking at how transport mechanisms couple far apart ecosystems. One example already mentioned is the moisture recycling feedback and how it can affect the water budget of areas down the '_preceipitationshed_' [@Keys:2012bo]. Another teleconnection [sensu @Liu:2015go] could be with allocation of resources through international trade, investigating how demand of resources in certain countries can shape the state space of ecosystems from the providing countries.

```{r, Fig7, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 4, fig.width = 7, dev.args = list(pointsize= 5), fig.align='center', fig.cap = 'Inconvenient feedbacks in drylands. Blue bars show feedbacks present on the individual causal network of each regime shifts. Red bars shows the emergent inconvenient feedbacks when two regime shift networks are joined'}

### In analyizing a subset and produce barplos, uncomment the following.
# rs1 <- list()
# rs1 <- apply(rs.net, rs, )
#
# rs1 <- rs.net(rs, 1)
# rs2 <- rs.net(rs, 2)

#
# x <- melt(out_dat[[1]], id.var="feed.length",
#          measure.var= colnames(out_dat[[1]])[c(1:3,5,6)],
#          value.name='value') %>%
#          mutate(feed.length = as.integer(feed.length))
#
# x$variable <- factor(x$variable, levels = rev(levels(x$variable)))
#
# library(forcats)
# g1<-ggplot(filter(x, variable == 'RS1'),
#     aes(x=feed.length, y=value)) +
#     geom_bar( position = 'dodge', stat = 'identity')  + ylab('Number of feedbacks') + xlab('Feedback length') + xlim(0,max(out_graph[[1]]$data[out_graph[[1]]$data$value > 0, ]$feed.length)) + theme_minimal(base_size = 7) + ylim(0,5)
# g2<-ggplot(filter(x, variable == 'RS2'),
#     aes(x=feed.length, y=value)) + geom_bar( position = 'dodge', stat = 'identity')  + ylab('Number of feedbacks') + xlab('Feedback length') + xlim(0,max(out_graph[[1]]$data[out_graph[[1]]$data$value > 0, ]$feed.length)) + theme_minimal(base_size = 7) + ylim(0,5)
# g3 <- ggplot(filter(x,  variable == 'Inconvenient' | variable == 'Expected') ,
#     aes(x=feed.length, y=value)) +
#     geom_bar( position = 'stack', stat = 'identity', aes(fill = fct_rev(variable)))  +
#     ylab('Number of feedbacks') + xlab('Feedback length') + xlim(0,max(out_graph[[1]]$data[out_graph[[1]]$data$value > 0, ]$feed.length)) + theme_minimal(base_size = 7) + ylim(0,5) +
#     scale_fill_manual("New feedbacks",values=c("#E41A1C","#377EB8")) +
#     theme(legend.position=c(0.8,0.8))
#
# g <- list() # list of plots
# indx <- c(87,91,163,107,176,258,106,178,260,416) # the current list is only for drylands based on 'key'
#
# for (i in 2:length(out_dat)){    # works on all RS (i in 2:length(out_dat))  
#     x <- reshape::melt(out_dat[[i]], id.var="feed.length",
#              measure.var= colnames(out_dat[[i]])[c(1:3,5,6)],
#              value.name='value') %>%
#              mutate(feed.length = as.integer(feed.length))
#     x$variable <- factor(x$variable, levels = rev(levels(x$variable)))
#     g[[i-1]] <- ggplot(filter(x,  variable == 'Inconvenient' | variable == 'Expected') , aes(x=feed.length, y=value)) +
#         geom_bar( position = 'stack', stat = 'identity', aes(fill = fct_rev(variable)), show.legend = F)  +
#         ylab('Number of feedbacks') + xlab('Feedback length') +
#         xlim(0,max(out_graph[[i]]$data[out_graph[[i]]$data$value > 0, ]$feed.length)) + theme_minimal(base_size = 4 ) + ylim(0,5) +
#         scale_fill_manual("New feedbacks",values=c("#E41A1C","#377EB8")) +
#         theme(legend.position=c(0.7,0.7)) + ggtitle(out[[i]] %n% 'name')
# }
#

# The graph g3 has the wrong order of bars but haven't been able to correct it. ON the to do list.
# ggplot(filter(x,  variable == 'Inconvenient' | variable == 'Expected') %>% droplevels(),
#     aes(x=feed.length, y=value)) +
#     geom_bar( aes(fill=variable), position = 'stack', stat = 'identity')  + ylab('Number of feedbacks') + xlab('Feedback length') + xlim(0,max(out_graph[[1]]$data[out_graph[[1]]$data$value > 0, ]$feed.length))  + ylim(0,5)

# library(gridBase)
# library(grid)
# library(gridExtra)
#
#
# # quartz(width = 6, height = 4, pointsize = 7)
# par(mfrow = c(2,3)) # layout(matrix(1:12,4,3, byrow=T))
# plot.new()
# # grid.newpage() # I need this line to plot on quartz, but not on markdown pdf.
# pushViewport(viewport(layout = grid.layout(2,3)))
#
# ## First networks
# pushViewport(viewport(layout.pos.row=1, layout.pos.col=1))
# par(fig = gridFIG(), new = TRUE)
# plotnet(rs1)
# popViewport()
# pushViewport(viewport(layout.pos.row=1, layout.pos.col=2))
# par(fig = gridFIG(), new = TRUE)
# plotnet(rs2)
# popViewport()
# pushViewport(viewport(layout.pos.row=1, layout.pos.col=3))
# par(fig = gridFIG(), new = TRUE)
# plotnet(out[[1]])
# popViewport()
#
# ## Then the feedback histograms
# pushViewport(viewport(layout.pos.row=2, layout.pos.col=1))
# print(g1, newpage = F)
# popViewport()
#
# pushViewport(viewport(layout.pos.row=2, layout.pos.col=2))
# print(g2, newpage = F)
# popViewport()
#
# pushViewport(viewport(layout.pos.row=2, layout.pos.col=3))
# print(g3, newpage = F)
# # popViewport()


# source('~/Dropbox/Code/multiplot.R')
# layout <- matrix(1:10, 2,5)
# multiplot(plotlist = g, layout = layout)

```

## Conclusion

Non-linear dynamics are ubiquitous to a large range of social-ecological systems. However, how a regime shift somewhere in the world could affect the occurrence of another regime shift remains an open question and a key frontier of research. Here we have developed a graphical framework to explore potential cascading effects amongst regime shifts. Based on topological features of causal networks three type of connections have been proposed. Potential correlations can arise when regime shifts share common drivers. While the spatio-temporal correlation can be masked by heterogeneity or noise, the cluster of drivers shared serves to design managerial strategies. One-way directional interactions are denoted as _domino effects_ and are common but not exclusive to aquatic regime shifts. These connections tend to emerge between regime shifts whose dynamics occur at larger spatial scales and slower temporal scales and regime shifts in more localized and faster dynamics. Two-way interconnections are denoted _hidden feedbacks_ and occur often between regime shifts at similar spatio-temporal scales and similar ecosystem types. The two latter types of cascading effects call for a more holistic approach for modeling and studying regime shifts, acknowledging their potential interdependencies.

\pagebreak

## Supplementary material

This section complements the methods and results of linear regressions and exponential random graph models. Both modeling techniques used the number of drivers shared, the number of domino effects and the number of hidden feedback as the three key response variables. While the linear regression only takes similarity (calculated with a Jaccard distance on the attributes coded in the regime shifts database), the exponential random graph models take into account network structure. Thus, the latter investigates the odds of the existance and weight of a link.

### Leftovers from the text to edit or delete:

The concept of cascading effect has been used in two seemingly different contexts: i) when referring to the effect of an abrupt change on one species spreading through food webs [e.g. see @Singer:2014gj; @Pauly:1998iw]; and ii) when local interactions are magnified by feedbacks that are reinforced across scales (e.g. erosion or fire) [e.g. see @Anonymous:2007tc; @DebraPCPeters:2004ex]. What these interpretations have in common is that both refer to networked systems (e.g. foodwebs, landscape mosaics) where a signal (e.g. fire, species collapse, disease) spreads broadly or is contained locally depending upon the system's connectivity. The units of these networks are usually species or sets of spatial units that represent ecosystems. Here we broaden the cascading effects concept to networks of regime shifts, when regime shifts can be represented as causal networks of drivers and underlying feedback mechanisms or processes (see methods).

### Supplementary methods:

_Causal loop diagrams_ (CLDs) represent a collection of causal mechanisms that scientist have reported in their narratives: both empirical (what they choose to sample) or theoretical (what they choose to model). CLDs consist of variables connected by arrows denoting causal influence [@Sterman:2000we], also known as signed directed graphs. Each relationship must have a positive $(+)$ or negative $(-)$ sign that represents the effect of the dependent variable given change on the independent variable [@Lane:2008p6781; @Sterman:2000we]. Although the functional form that underlies each relationship is not necessarily known, positive relationships are proportional while negative are inverse proportional _ceteris paribus_. CLDs assume that the causal relationships captured by links are monotonic, while non-linearities are captured by links sets, thus they do not have self-loops. Feedback loops are the basic structural units of the diagram and emerge by connecting variables in closed directed paths (cycles). Feedback means that once a signal enters the loop, some part of the output is feed back to the input, resulting on amplification or dampening of its own signal. Feedbacks can be reinforcing if the overall polarity of its links is positive, or balancing if negative. Reinforcing feedbacks are usually responsible for behaviours that drives the system out of equilibrium, while balancing feedbacks are responsible for near equilibrium dynamics such as oscillations and delays [@Sterman:2000we]. Note that causal links do not describe the behaviour of variables, only the structure of the system: they describe what would happen if there were changes [@Sterman:2000we]. CLDs were curated in the regime shifts database in a way that variables names are consistent (e.g. agriculture and cropping is kept as 'agriculture'), and feedback loops comparable (e.g. albedo in the rainforest, Arctic or Antarctic regime shifts is the same feedback).

_Categorical variables:_ We calculated the similarity of each pair-wise combination of regime shifts in the database regarding categorical attributes such as *(i)* land use under which the regime shift occur, *(ii)* ecosystem type, impacts on *(iii)* ecosystem processes, *(iv)* provisioning services, *(v)* regulating services, *(vi)* cultural services, *(vii)* and human wellbeing; as well as *(viii)* the spatial scale at which the regime shift occur, *(ix)* the temporal scales, *(x)* reversibility, and *(xi)* evidence type [@Biggs:2015iha; @Rocha:2015du]. For all $92$ categorical variables encoded, the database reports presence or absence $(0,1)$ allowing us to calculate the Jaccard index and use it as a proxy of how similar two regime shifts are. To facilitate the interpretation of statistical models, the Jaccard distance was rescaled ($x =1 - J_{d}$) so equivalent regime shifts score 1 and complete dissimilar zero. Given that most of our hypothesis relate to the scale at which regime shifts occur, we also modeled scale as a categorical variable to account for matches in the network, no only similarity. 

_Networks:_ Causal loop diagrams were reinterpreted as networks where node attributes were coded if a node belongs to a feedback loop -a k-cycle in the network- or not. The later is then by definition a driver, an independent variable whose dynamics are not affected by the dynamics of the state variables of the system at hand. Note that networks in ecology usually describe inter species interactions such as predation or mutualism. Our approach is different from what has been done in ecology. Here a network describe a set of processes, both biotic and abiotic, that can govern ecosystem regime shifts dynamics. Our approach is inspired by other network applications to processes such as cells metabolic networks or the network of human diseases, where a process is not captured by a link type (e.g. predation) but by a collection of link interactions (e.g. the Krebs cycle). Thus, individual species are not taken into consideration, but rather their functional role at the aggregated ecosystem scale (e.g. herbivory).

_Shared drivers:_ To study shared drivers we created a bipartite network of drivers and regime shifts following the method outlined by Rocha et al [@Rocha:2015du]. The statistical models were performed for the case of drivers sharing on the one-mode network projection of regime shifts sharing drivers (this is the matrix $A^TA$), and categorical variables from the regime shifts database were used as node attributes or node covariates to test our hypothesis.

_Domino effects:_ occur when the occurrence of a regime shift can increase or decrease the likelihood of other regime shift occurring, creating a one-way dependence. Different from the driving sharing network, here we explore potential domino effects by using the full causal loop diagrams as networks. The algorithm for identifying domino effects takes the adjacency matrix of two given regime shifts $A_1$ and $A_2$ and identifies all nodes $n \in A_1 \cap A_2$ such that $n$ belong to a feedback in $A_1$ but is a driver in $A_2$. Thus, set differences between causal pathways suggest missing drivers, and set intersection between causal pathways and feedback loop nodes indicate potential domino effects (Fig. 2b). By iterating this simple algorithm we derived how many different pathways exist between every pair-wise combination of regime shifts $(N=435)$. The resulting non-symmetrical matrix represents a directed network with regime shifts as nodes and link weights as the number of pathways used for statistical analysis.

_Hidden feedbacks:_ We explore hidden feedbacks by pair-wise comparison of causal networks. First, the feedback loops (or k-cycles) are counted by feedback length $k$ for each regime shift matrix  $A_1$ and $A_2$ separately. Then the cycle count is applied to the composite network $A_{1,2}$ of the two regime shifts. The difference between the k-cycles in the composite network $A_{1,2}$ and the k-cycles on the individual networks $A_1$ and $A_2$ are the hidden feedbacks that emerge when the two causal networks are joined. By iterating the same procedure to all pair-wise combinations of regime shifts $(N=435)$ a symmetric directed matrix is obtained that is then used on the statistical analysis.




Note that the resulting distance matrix for all cases contains values $x_{i,j}$ regardless if the link exist or not on the networks used as response variable. For this reason we also fitted naïve OLS models to compare what can be explained by similarity alone, as opposed to what is explained by the cascading effects network types (drivers sharing, domino effects, and hidden feedbacks).

### OLS models
All results from linear regressions in Figures 3, 4, and 5 are summarized in Table SM1. Note that coefficients in the ordinary least squares approximation are probabilites that regime shifts have high (low) values in the response variable.

**Table SM1.** Ordinary least square models

```{r tableSM1, message = FALSE, warning = FALSE, echo = FALSE, results='asis'}

invisible(stargazer::stargazer(fit1, fit2, fit3,
    align = F, header = F,  out.header = T, type = 'latex', digits = 2,
    float = F, no.space = T, single.row = T, font.size = "footnotesize", multicolumn = F,
    dep.var.labels = c("Shared drivers", "Domino effects", "Hidden feedbacks"),
    title = "Table SM1. Ordinary least square models")
    )

```

### Exponential random graph models
The coefficients in exponential random graph models present the log-odds of the existence of a link given that similarites (Jaccard distances) or matching of node attributes (e.g. scale), therefore the results are read similarly to those of a logistic regression. Instead of the intercept here we have the `nonzero` term which indicates what are the odds of the existence of a link. Since the networks are weighted by the number of shared drivers, domino effects or hidden feedbacks, the term `sum` accounts for the weight of the link when it exist. Similarly to the OLS approach, here we used Jaccard similarity on the attributes coded on the regime shifts database to quantify how similar two regime shifts are and how the similarity effects the odds of a link. Since our hypothesis were related to the temporal and spatial scales at which the regime shifts occurred, we also modeled such terms not only as similarity (a score between 0 and 1), but also as categorical mutually exclusive variables. The original data from the regime shifts database code for categorical non-exclusive variables. For spatial scale, when two different categories where present (e.g. local, national), we choosed the larger category as unique factor. For temporal scales, regime shifts were often coded as belonging to two categories (e.g. decades and centuries), thus we create a variable `time_range` that bundle both minimum and maximum reported. Spatial and temporal scales are then modeled as factors too, the term `nodefactor` in each model accounts for how more likely is to have a link when the factor is present, while the `nodematch` term accounts for the homogeneity effect of two nodes sharing the same node attribute (same scale).

**Table SM2.** Exponential random graph models for (\textit{shared drivers})
```{r tableSM2, message = FALSE, warning = FALSE, echo = FALSE, results='asis'}

# suppressMessages(stargazer::stargazer(fit.null1, fit.w1, fit.w1a,
#     align = F, header = F, type = 'latex', digits = 2,
#     float = F, no.space = T, single.row = T, font.size = "footnotesize",
#     title = "Table SM2. Exponential random graph models for shared drivers (\textit{number of drivers shared})",
#     # covariate.labels = c("Non-zero", "Sum", "Land use", "Ecosystem type", "Ecosystem processes",
#     #                      "Provising services", "Regulating services", "Cultural services",
#     #                      "Human wellbeing", "Spatial scale", "Temporal scale", "Reversibility",
#     #                      "Evidence type"),
#     dep.var.labels = "Shared drivers",
#     add.lines = list(c("Maximum likelihood estimation",
#                        round(fit.null1$mle.lik,2),
#                        round( fit.w1$mle.lik,2),
#                        round(fit.w1a$mle.lik,2))))
#     )

```
\begingroup
\footnotesize
\begin{tabular}{@{\extracolsep{5pt}}lccc}
\\[-1.8ex]\hline
\hline \\[-1.8ex]
 & \multicolumn{3}{c}{\textit{Dependent variable:}} \\
\cline{2-4}
\\[-1.8ex] & \multicolumn{3}{c}{Shared drivers} \\
\\[-1.8ex] & (1) & (2) & (3)\\
\hline \\[-1.8ex]
 nonzero & $-$1.86$^{***}$ (0.15) & $-$0.23 (0.19) & $-$1.03$^{***}$ (0.17) \\
  sum & 1.05$^{***}$ (0.04) & $-$1.65$^{***}$ (0.25) & 0.15 (0.11) \\
  edgecov.x.landuse.sum &  & 0.68$^{***}$ (0.18) & 0.32$^{**}$ (0.14) \\
  edgecov.x.ecotype.sum &  & $-$0.51$^{***}$ (0.11) & $-$0.59$^{***}$ (0.10) \\
  edgecov.x.ecoprocess.sum &  & $-$0.16 (0.11) & $-$0.15 (0.10) \\
  edgecov.x.reg\_service.sum &  & 0.61$^{***}$ (0.14) & 1.02$^{***}$ (0.14) \\
  edgecov.x.prov\_service.sum &  & 0.57$^{***}$ (0.18) & 0.46$^{***}$ (0.16) \\
  edgecov.x.cult\_service.sum &  & $-$0.04 (0.12) & $-$0.27$^{***}$ (0.10) \\
  edgecov.x.hwb.sum &  & 0.22 (0.15) & 0.32$^{**}$ (0.14) \\
  nodefactor.sum.space\_range.national &  & 0.45$^{***}$ (0.10) &  \\
  nodefactor.sum.space\_range.sub-continental &  & $-$0.07 (0.09) &  \\
  nodefactor.sum.time\_range.month\_year &  & 1.12$^{***}$ (0.11) &  \\
  nodefactor.sum.time\_range.week\_month &  & 1.01$^{***}$ (0.16) &  \\
  nodefactor.sum.time\_range.year\_decade &  & 0.67$^{***}$ (0.10) &  \\
  nodematch.sum.space\_range &  & 0.18$^{**}$ (0.09) &  \\
  nodematch.sum.time\_range &  & 0.01 (0.08) &  \\
  edgecov.x.space\_scale.sum &  &  & $-$0.19$^{**}$ (0.09) \\
  edgecov.x.time\_scale.sum &  &  & 0.16 (0.10) \\
  edgecov.x.reversibility.sum &  & 0.40$^{***}$ (0.10) & 0.27$^{***}$ (0.09) \\
  edgecov.x.evidence.sum &  & $-$0.53$^{***}$ (0.19) & $-$0.40$^{**}$ (0.17) \\
 \hline \\[-1.8ex]
Maximum likelihood estimation & 290.46 & 509.55 & 401.79 \\
Akaike Inf. Crit. & $-$576.91 & $-$983.09 & $-$777.58 \\
Bayesian Inf. Crit. & $-$568.76 & $-$909.73 & $-$724.60 \\
\hline
\hline \\[-1.8ex]
\textit{Note:}  & \multicolumn{3}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\
\end{tabular}
\endgroup

**Table SM3.** Exponential random graph models for \textit{domino effects}
```{r tableSM3, message = FALSE, warning = FALSE, echo = FALSE, results='asis'}
# suppressMessages(stargazer::stargazer( fit.null2, fit.w2, fit.w2a, fit.w2b,
#     align = F, header = F, type = 'latex', digits = 2,
#     float = F, no.space = T, single.row = T, font.size = "footnotesize",
#     title = "Table SM3. Exponential random graph models for \textit{domino effects}",
#     # covariate.labels = c("Non-zero", "Sum", "Land use", "Ecosystem type", "Ecosystem processes",
#     #                      "Provising services", "Regulating services", "Cultural services",
#     #                      "Human wellbeing", "Spatial scale", "Temporal scale", "Reversibility",
#     #                      "Evidence type"),
#     dep.var.labels = "Domino effects",
#      add.lines = list(c("Maximum likelihood estimation",
#                        round(fit.null2$mle.lik,2),
#                        round( fit.w2$mle.lik,2),
#                        round(fit.w2a$mle.lik,2),
#                        round(fit.w2b$mle.lik,2))))
#     )
```
\begingroup
\footnotesize
\begin{tabular}{@{\extracolsep{5pt}}lcccc}
\\[-1.8ex]\hline
\hline \\[-1.8ex]
 & \multicolumn{4}{c}{\textit{Dependent variable:}} \\
\cline{2-5}
\\[-1.8ex] & \multicolumn{4}{c}{Domino effects} \\
\\[-1.8ex] & (1) & (2) & (3) & (4)\\
\hline \\[-1.8ex]
 nonzero & $-$1.63$^{***}$ (0.16) & 3.20$^{***}$ (0.36) & 3.33$^{***}$ (0.38) & 3.44$^{***}$ (0.39) \\
  sum & $-$0.06 (0.09) & $-$6.67$^{***}$ (0.43) & $-$7.24$^{***}$ (0.66) & $-$7.31$^{***}$ (0.71) \\
  edgecov.dom\_net.landuse.sum &  & 0.48 (0.53) & 0.70 (0.56) & 0.77 (0.58) \\
  edgecov.dom\_net.ecotype.sum &  & 0.26 (0.31) & 0.18 (0.32) & 0.31 (0.32) \\
  edgecov.dom\_net.ecoprocess.sum &  & 1.14$^{***}$ (0.35) & 1.03$^{***}$ (0.38) & 0.82$^{**}$ (0.38) \\
  edgecov.dom\_net.prov\_service.sum &  & 1.66$^{***}$ (0.60) & 1.92$^{***}$ (0.64) & 1.97$^{***}$ (0.65) \\
  edgecov.dom\_net.reg\_service.sum &  & 2.53$^{***}$ (0.42) & 2.69$^{***}$ (0.44) & 2.87$^{***}$ (0.45) \\
  edgecov.dom\_net.cult\_service.sum &  & $-$0.25 (0.26) & $-$0.50$^{*}$ (0.27) & $-$0.64$^{**}$ (0.29) \\
  edgecov.dom\_net.hwb.sum &  & 1.43$^{***}$ (0.42) & 1.45$^{***}$ (0.45) & 1.39$^{***}$ (0.45) \\
  edgecov.dom\_net.space\_scale.sum &  & $-$0.03 (0.23) &  &  \\
  edgecov.dom\_net.time\_scale.sum &  & 0.59$^{**}$ (0.29) &  &  \\
  nodefactor.sum.space\_range.national &  &  & 0.04 (0.29) &  \\
  nodefactor.sum.space\_range.sub-continental &  &  & 0.27 (0.37) &  \\
  nodefactor.sum.time\_range.month\_year &  &  & 0.11 (0.23) &  \\
  nodefactor.sum.time\_range.week\_month &  &  & 0.22 (0.43) &  \\
  nodefactor.sum.time\_range.year\_decade &  &  & $-$0.20 (0.19) &  \\
  nodeifactor.sum.space\_range.national &  &  &  & $-$0.16 (0.31) \\
  nodeifactor.sum.space\_range.sub-continental &  &  &  & $-$0.28 (0.56) \\
  nodeifactor.sum.time\_range.month\_year &  &  &  & 0.08 (0.36) \\
  nodeifactor.sum.time\_range.week\_month &  &  &  & 0.94$^{*}$ (0.52) \\
  nodeifactor.sum.time\_range.year\_decade &  &  &  & 0.16 (0.30) \\
  nodeofactor.sum.space\_range.national &  &  &  & $-$0.09 (0.60) \\
  nodeofactor.sum.space\_range.sub-continental &  &  &  & 0.29 (0.48) \\
  nodeofactor.sum.time\_range.month\_year &  &  &  & 0.43 (0.38) \\
  nodeofactor.sum.time\_range.week\_month &  &  &  & $-$1.76 (1.37) \\
  nodeofactor.sum.time\_range.year\_decade &  &  &  & $-$0.48$^{*}$ (0.29) \\
  nodematch.sum.space\_range.local &  &  & 0.85$^{**}$ (0.41) & 0.60 (0.46) \\
  nodematch.sum.space\_range.national &  &  & 0.42 (0.89) & 0.36 (0.88) \\
  nodematch.sum.space\_range.sub-continental &  &  & 0.15 (0.48) & 0.48 (0.61) \\
  nodematch.sum.time\_range &  &  & 0.07 (0.19) & 0.20 (0.21) \\
  edgecov.dom\_net.reversibility.sum &  & 0.82$^{***}$ (0.28) & 0.99$^{***}$ (0.31) & 0.94$^{***}$ (0.32) \\
  edgecov.dom\_net.evidence.sum &  & 0.81$^{**}$ (0.41) & 1.38$^{***}$ (0.48) & 1.28$^{***}$ (0.48) \\
 \hline \\[-1.8ex]
Maximum likelihood estimation & 279.89 & 676.49 & 683.9 & 691.54 \\
Akaike Inf. Crit. & $-$555.77 & $-$1,326.98 & $-$1,327.80 & $-$1,333.09 \\
Bayesian Inf. Crit. & $-$546.23 & $-$1,264.99 & $-$1,232.43 & $-$1,213.88 \\
\hline
\hline \\[-1.8ex]
\textit{Note:}  & \multicolumn{4}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\
\end{tabular}
\endgroup

**Table SM4.** Exponential random graph models for \textit{hidden feedbacks}
```{r tableSM4, message = FALSE, warning = FALSE, echo = FALSE, results='asis'}
# suppressMessages(stargazer::stargazer(fit.null3, fit.w3, fit.w3a,
#     align = F, header = F,  type = 'latex', digits = 2,
#     float = F, no.space = T, single.row = T, font.size = "footnotesize",
#     title = "Table SM4. Exponential random graph models for \textit{hidden feedbacks}",
#     # covariate.labels = c("Non-zero", "Sum", "Land use", "Ecosystem type", "Ecosystem processes",
#     #                      "Provising services", "Regulating services", "Cultural services",
#     #                      "Human wellbeing", "Spatial scale", "Temporal scale", "Reversibility",
#     #                      "Evidence type"),
#     dep.var.labels = "Hidden feedbacks",
#     add.lines = list(c("Maximum likelihood estimation",
#                        round(fit.null3$mle.lik,2),
#                        round( fit.w3$mle.lik,2),
#                        round(fit.w3a$mle.lik,2))))
#     )
```
\begingroup
\footnotesize
\begin{tabular}{@{\extracolsep{5pt}}lccc}
\\[-1.8ex]\hline
\hline \\[-1.8ex]
 & \multicolumn{3}{c}{\textit{Dependent variable:}} \\
\cline{2-4}
\\[-1.8ex] & \multicolumn{3}{c}{Hidden feedbacks} \\
\\[-1.8ex] & (1) & (2) & (3)\\
\hline \\[-1.8ex]
 nonzero & $-$16.14$^{***}$ (0.37) & $-$9.57$^{***}$ (0.42) & $-$7.32$^{***}$ (0.35) \\
  sum & 2.76$^{***}$ (0.02) & 1.99$^{***}$ (0.06) & 1.76$^{***}$ (0.09) \\
  edgecov.inc\_net.landuse.sum &  & $-$0.29$^{***}$ (0.08) & $-$0.10 (0.10) \\
  edgecov.inc\_net.ecotype.sum &  & 0.08 (0.07) & $-$0.01 (0.08) \\
  edgecov.inc\_net.ecoprocess.sum &  & $-$0.58$^{***}$ (0.07) & $-$0.37$^{***}$ (0.08) \\
  edgecov.inc\_net.prov\_service.sum &  & 0.22$^{**}$ (0.10) & 0.15 (0.11) \\
  edgecov.inc\_net.reg\_service.sum &  & 0.91$^{***}$ (0.09) & 1.41$^{***}$ (0.09) \\
  edgecov.inc\_net.cult\_service.sum &  & $-$0.39$^{***}$ (0.07) & $-$0.18$^{**}$ (0.08) \\
  edgecov.inc\_net.hwb.sum &  & 0.04 (0.09) & 0.17$^{*}$ (0.10) \\
  edgecov.inc\_net.space\_scale.sum &  & 0.42$^{***}$ (0.06) &  \\
  edgecov.inc\_net.time\_scale.sum &  & 0.42$^{***}$ (0.06) &  \\
  nodefactor.sum.space\_range.national &  &  & 0.38$^{***}$ (0.04) \\
  nodefactor.sum.space\_range.sub-continental &  &  & $-$0.35$^{***}$ (0.04) \\
  nodefactor.sum.time\_range.month\_year &  &  & $-$0.48$^{***}$ (0.05) \\
  nodefactor.sum.time\_range.week\_month &  &  & $-$0.87$^{***}$ (0.15) \\
  nodefactor.sum.time\_range.year\_decade &  &  & $-$0.28$^{***}$ (0.03) \\
  nodematch.sum.space\_range &  &  & 0.62$^{***}$ (0.05) \\
  nodematch.sum.time\_range &  &  & $-$0.04 (0.04) \\
  edgecov.inc\_net.reversibility.sum &  & 0.26$^{***}$ (0.06) & 0.54$^{***}$ (0.07) \\
  edgecov.inc\_net.evidence.sum &  & $-$0.28$^{***}$ (0.10) & $-$0.27$^{**}$ (0.12) \\
 \hline \\[-1.8ex]
Maximum likelihood estimation & 3987.89 & 4365.31 & 4585.05 \\
Akaike Inf. Crit. & $-$7,971.79 & $-$8,704.62 & $-$9,134.11 \\
Bayesian Inf. Crit. & $-$7,963.77 & $-$8,652.53 & $-$9,061.99 \\
\hline
\hline \\[-1.8ex]
\textit{Note:}  & \multicolumn{3}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\
\end{tabular}
\endgroup

\pagebreak

### Causal loop diagram networks

```{r supp1, cache = TRUE, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, fig.height = 10, fig.width = 10, dev.args = list(pointsize= 5), fig.align='center', fig.cap = 'Supplementary figure 1. Causal netoworks for all regime shifts'}

## Updated ploting function

# detach(package:igraph)
library(network); library(sna)
# quartz(pointsize = 7)
par(mfrow = c(6,5), mar = c(2,2,2,2))

for (i in 1:length(levels(dat$Regime.Shift)) ){
	net <- rs.net(dat = dat,  i = i)
	plotnet(net)

}
```

\pagebreak
